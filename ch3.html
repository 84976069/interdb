
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>第三章. 查询处理 · GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="ch4.html" />
    
    
    <link rel="prev" href="ch2.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    README
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="ch0.html">
            
                <a href="ch0.html">
            
                    
                    简介
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="ch1.html">
            
                <a href="ch1.html">
            
                    
                    第一章. 数据库集群、数据库和表
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="ch1.html">
            
                <a href="ch1.html#1.2.">
            
                    
                    数据库集群的逻辑结构
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="ch2.html">
            
                <a href="ch2.html">
            
                    
                    第二章. 进程和内存结构
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.5" data-path="ch3.html">
            
                <a href="ch3.html">
            
                    
                    第三章. 查询处理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="ch4.html">
            
                <a href="ch4.html">
            
                    
                    第四章. 外部表(FDW)和并行查询
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="ch5.html">
            
                <a href="ch5.html">
            
                    
                    第五章. 并发控制
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="ch6.html">
            
                <a href="ch6.html">
            
                    
                    第六章. VACUUM
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="ch7.html">
            
                <a href="ch7.html">
            
                    
                    第七章. HOT(Heap-Only-Tuple)技术和仅索引扫描(Index-Only Scans)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="ch8.html">
            
                <a href="ch8.html">
            
                    
                    第八章. 缓冲区管理器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="ch9.html">
            
                <a href="ch9.html">
            
                    
                    第九章. 预写式日志 (WAL)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12" data-path="ch10.html">
            
                <a href="ch10.html">
            
                    
                    第十章. 基础备份和时间点恢复 (PITR)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13" data-path="ch11.html">
            
                <a href="ch11.html">
            
                    
                    第十一章. 流复制
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >第三章. 查询处理</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h2 id="&#x7B2C;&#x4E09;&#x7AE0;--&#x67E5;&#x8BE2;&#x5904;&#x7406;">&#x7B2C;&#x4E09;&#x7AE0;  &#x67E5;&#x8BE2;&#x5904;&#x7406;</h2>
<p>&#x6839;&#x636E;PostgreSQL&#x5728;<a href="https://www.postgresql.org/docs/current/static/features.html" target="_blank">&#x5B98;&#x65B9;&#x6587;&#x6863;</a>&#x4E2D;&#x7684;&#x63CF;&#x8FF0;&#xFF0C;&#x5B83;&#x652F;&#x6301;2011&#x5E74;SQL&#x6807;&#x51C6;&#x6240;&#x9700;&#x7684;&#x5927;&#x91CF;&#x7279;&#x6027;&#x3002;&#x67E5;&#x8BE2;&#x5904;&#x7406;&#x662F;PostgreSQL&#x4E2D;&#x6700;&#x590D;&#x6742;&#x7684;&#x5B50;&#x7CFB;&#x7EDF;&#xFF0C;&#x5B83;&#x53EF;&#x4EE5;&#x9AD8;&#x6548;&#x5730;&#x5904;&#x7406;&#x53D7;&#x652F;&#x6301;&#x7684;SQL&#x3002; &#x672C;&#x7AE0;&#x6982;&#x8FF0;&#x4E86;&#x67E5;&#x8BE2;&#x5904;&#x7406;;&#xFF0C;&#x91CD;&#x70B9;&#x63CF;&#x8FF0;&#x67E5;&#x8BE2;&#x4F18;&#x5316;&#x3002;</p>
<p>&#x672C;&#x7AE0;&#x5305;&#x62EC;&#x4EE5;&#x4E0B;&#x4E09;&#x90E8;&#x5206;&#x5185;&#x5BB9;&#xFF1A;</p>
<ul>
<li><p><strong>&#x7B2C;&#x4E00;&#x90E8;&#x5206;:</strong> 3.1&#x8282;.</p>
<p>&#x672C;&#x8282;&#x6982;&#x8FF0;&#x4E86;PostgreSQL&#x4E2D;&#x7684;&#x67E5;&#x8BE2;&#x5904;&#x7406;&#x3002;</p>
</li>
<li><p><strong>&#x7B2C;&#x4E8C;&#x90E8;&#x5206;:</strong> 3.2. &#x2014; 3.4&#x8282;.</p>
<p>&#x672C;&#x90E8;&#x5206;&#x4ECB;&#x7ECD;&#x83B7;&#x53D6;&#x5355;&#x8868;&#x67E5;&#x8BE2;&#x6700;&#x4F18;&#x8BA1;&#x5212;&#x7684;&#x8FC7;&#x7A0B;&#x3002; &#x5728;&#x7B2C;3.2&#x548C;3.3&#x8282;&#x4E2D;&#xFF0C;&#x5206;&#x522B;&#x4ECB;&#x7ECD;&#x4E86;&#x4F30;&#x7B97;&#x6210;&#x672C;(explain)&#x548C;&#x521B;&#x5EFA;&#x8BA1;&#x5212;&#x6811;(plan tree)&#x7684;&#x8FC7;&#x7A0B;&#x3002; &#x5728;3.4&#x8282;&#x4E2D;&#xFF0C;&#x7B80;&#x8981;&#x63CF;&#x8FF0;&#x4E86;&#x6267;&#x884C;&#x5668;(executor)&#x7684;&#x64CD;&#x4F5C;&#x3002;</p>
</li>
<li><p><strong>&#x7B2C;&#x4E09;&#x90E8;&#x5206;:</strong> 3.5. &#x2014; 3.6&#x8282;.</p>
<p>&#x672C;&#x90E8;&#x5206;&#x4ECB;&#x7ECD;&#x83B7;&#x53D6;&#x591A;&#x8868;&#x67E5;&#x8BE2;&#x6700;&#x4F18;&#x8BA1;&#x5212;&#x7684;&#x8FC7;&#x7A0B;&#x3002; &#x5728;3.5&#x8282;&#x4E2D;&#xFF0C;&#x63CF;&#x8FF0;&#x4E86;&#x4E09;&#x79CD;&#x8FDE;&#x63A5;&#x65B9;&#x6CD5;&#xFF1A;nested loop join&#x3001;mege join&#x548C;hash join&#x3002; &#x5728;3.6&#x8282;&#x4E2D;&#xFF0C;&#x63CF;&#x8FF0;&#x521B;&#x5EFA;&#x591A;&#x8868;&#x67E5;&#x8BE2;&#x8BA1;&#x5212;&#x6811;&#x7684;&#x8FC7;&#x7A0B;&#x3002;</p>
</li>
</ul>
<p>PostgreSQL&#x652F;&#x6301;&#x4E24;&#x4E2A;&#x6709;&#x8DA3;&#x7684;&#x6280;&#x672F;&#x548C;&#x5B9E;&#x7528;&#x7684;&#x7279;&#x6027;&#xFF0C;&#x5373;<a href="http://www.postgresql.org/docs/current/static/fdwhandler.html" target="_blank">&#x5916;&#x90E8;&#x6570;&#x636E;&#x5305;(Foreign Data Wrappers) (FDW)</a>&#x548C;<a href="https://www.postgresql.org/docs/current/static/parallel-query.html" target="_blank">&#x5E76;&#x884C;&#x67E5;&#x8BE2;Parallel Query</a>; &#x4ED6;&#x4EEC;&#x5C06;&#x5728;&#x7B2C;4&#x7AE0;&#x4E2D;&#x4ECB;&#x7ECD;&#x3002;</p>
<h2 id="31-&#x6982;&#x8FF0;">3.1. &#x6982;&#x8FF0;</h2>
<p>&#x5728;PostgreSQL&#x4E2D;&#xFF0C;&#x867D;&#x7136;9.6&#x7248;&#x672C;&#x4E2D;&#x5B9E;&#x73B0;&#x7684;&#x5E76;&#x884C;&#x67E5;&#x8BE2;&#x4F7F;&#x7528;&#x591A;&#x4E2A;&#x540E;&#x53F0;&#x5DE5;&#x4F5C;&#x8FDB;&#x7A0B;&#xFF0C;&#x4F46;&#x540E;&#x7AEF;&#x8FDB;&#x7A0B;&#x57FA;&#x672C;&#x4E0A;&#x5904;&#x7406;&#x8FDE;&#x63A5;&#x5BA2;&#x6237;&#x7AEF;&#x53D1;&#x51FA;&#x7684;&#x6240;&#x6709;&#x67E5;&#x8BE2;&#x3002; &#x8BE5;&#x540E;&#x7AEF;&#x7531;&#x4E94;&#x4E2A;&#x5B50;&#x7CFB;&#x7EDF;&#x7EC4;&#x6210;&#xFF0C;&#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF1A;</p>
<ol>
<li><p>&#x7F16;&#x8BD1;&#x5668;(Parser)</p>
<p>&#x89E3;&#x6790;&#x5668;&#x89E3;&#x6790;&#x7EAF;&#x6587;&#x672C;&#x5F62;&#x5F0F;&#x7684;SQL&#x8BED;&#x53E5;&#x751F;&#x6210;&#x89E3;&#x6790;&#x6811;(parse tree)&#x3002;</p>
</li>
<li><p>&#x5206;&#x6790;&#x5668;(Analyzer/Analyser)</p>
<p>&#x5206;&#x6790;&#x5668;&#x5BF9;&#x89E3;&#x6790;&#x6811;&#x8FDB;&#x884C;&#x8BED;&#x4E49;&#x5206;&#x6790;&#x5E76;&#x751F;&#x6210;&#x67E5;&#x8BE2;&#x6811;(query tree)&#x3002;</p>
</li>
<li><p>&#x91CD;&#x5199;&#x5668;(Rewriter)</p>
<p>&#x91CD;&#x5199;&#x5668;&#x4F7F;&#x7528;&#x5B58;&#x50A8;&#x5728;<a href="http://www.postgresql.org/docs/current/static/rules.html" target="_blank">&#x89C4;&#x5219;&#x7CFB;&#x7EDF;</a>&#x4E2D;&#x7684;&#x89C4;&#x5219;&#x8F6C;&#x6362;&#x67E5;&#x8BE2;&#x6811;&#x3002;</p>
</li>
<li><p>&#x4F18;&#x5316;&#x5668;(Planner)</p>
<p>&#x4F18;&#x5316;&#x5668;&#x4ECE;&#x67E5;&#x8BE2;&#x6811;&#x4E2D;&#x751F;&#x6210;&#x6267;&#x884C;&#x6700;&#x4F18;&#x8BA1;&#x5212;&#x6811;(plan tree)&#x3002;</p>
</li>
<li><p>&#x6267;&#x884C;&#x5668;(Executor)</p>
<p>&#x6267;&#x884C;&#x5668;&#x901A;&#x8FC7;&#x6309;&#x7167;&#x8BA1;&#x5212;&#x6811;&#x521B;&#x5EFA;&#x7684;&#x987A;&#x5E8F;&#x8BBF;&#x95EE;&#x8868;&#x548C;&#x7D22;&#x5F15;&#x6765;&#x6267;&#x884C;&#x67E5;&#x8BE2;&#x3002;</p>
</li>
</ol>
<p><strong>&#x56FE;. 3.1. &#x67E5;&#x8BE2;&#x5904;&#x7406;</strong></p>
<p><img src="https://github.com/yonj1e/The-Internals-of-PostgreSQL/blob/master/imgs/ch3/fig-3-01.png?raw=true" alt="Fig. 3.1. Query Processing."></p>
<p>&#x5728;&#x672C;&#x8282;&#x4E2D;&#xFF0C;&#x63D0;&#x4F9B;&#x4E86;&#x8FD9;&#x4E9B;&#x5B50;&#x7CFB;&#x7EDF;&#x7684;&#x6982;&#x8FF0;&#x3002; &#x7531;&#x4E8E;&#x4F18;&#x5316;&#x5668;&#x548C;&#x6267;&#x884C;&#x5668;&#x975E;&#x5E38;&#x590D;&#x6742;&#xFF0C;&#x4E0B;&#x9762;&#x5C06;&#x5BF9;&#x8FD9;&#x4E9B;&#x529F;&#x80FD;&#x8FDB;&#x884C;&#x8BE6;&#x7EC6;&#x8BF4;&#x660E;&#x3002;</p>
<blockquote>
<p>:pushpin: PostgreSQL&#x7684;&#x67E5;&#x8BE2;&#x5904;&#x7406;&#x5728;<a href="http://www.postgresql.org/docs/current/static/overview.html" target="_blank">&#x5B98;&#x65B9;&#x6587;&#x6863;</a>&#x4E2D;&#x6709;&#x8BE6;&#x7EC6;&#x63CF;&#x8FF0;&#x3002;</p>
</blockquote>
<h3 id="311-&#x89E3;&#x6790;&#x5668;parser">3.1.1. &#x89E3;&#x6790;&#x5668;(Parser)</h3>
<p>&#x89E3;&#x6790;&#x5668;&#x89E3;&#x6790;&#x7EAF;&#x6587;&#x672C;&#x5F62;&#x5F0F;&#x7684;SQL&#x8BED;&#x53E5;&#x751F;&#x6210;&#x89E3;&#x6790;&#x6811;&#x3002; &#x8FD9;&#x91CC;&#x6709;&#x4E00;&#x4E2A;&#x5177;&#x4F53;&#x7684;&#x4F8B;&#x5B50;&#xFF0C;&#x540E;&#x9762;&#x4E0D;&#x505A;&#x8BE6;&#x7EC6;&#x7684;&#x63CF;&#x8FF0;&#x3002;</p>
<p>&#x8BA9;&#x6211;&#x4EEC;&#x601D;&#x8003;&#x5982;&#x4E0B;&#x6240;&#x793A;&#x7684;&#x67E5;&#x8BE2;&#x3002; </p>
<pre><code class="lang-sql">testdb=# <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">id</span>, <span class="hljs-keyword">data</span> <span class="hljs-keyword">FROM</span> tbl_a <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> &lt; <span class="hljs-number">300</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">data</span>;
</code></pre>
<p>&#x89E3;&#x6790;&#x6811;&#x662F;&#x5728; <a href="https://github.com/postgres/postgres/blob/master/src/include/nodes/parsenodes.h" target="_blank">parsenodes.h</a> &#x4E2D;&#x5B9A;&#x4E49;&#x6839;&#x8282;&#x70B9;&#x4E3A; <a href="javascript:void(0" target="_blank">SelectStmt</a>) &#x7ED3;&#x6784;&#x7684;&#x6811;&#x3002;</p>
<p>&#x56FE;3.2(B)&#x6F14;&#x793A;&#x4E86;&#x56FE;3.2(A)&#x4E2D;&#x6240;&#x793A;&#x67E5;&#x8BE2;&#x7684;&#x89E3;&#x6790;&#x6811;&#x3002; </p>
<p><strong>&#x56FE;. 3.2. &#x89E3;&#x6790;&#x6811;&#x793A;&#x4F8B;</strong></p>
<p><img src="https://github.com/yonj1e/The-Internals-of-PostgreSQL/blob/master/imgs/ch3/fig-3-02.png?raw=true" alt="Fig. 3.2. An example of a parse tree."></p>
<p>SELECT&#x67E5;&#x8BE2;&#x7684;&#x5143;&#x7D20;&#x548C;&#x89E3;&#x6790;&#x6811;&#x7684;&#x76F8;&#x5E94;&#x5143;&#x7D20;&#x7684;&#x7F16;&#x53F7;&#x76F8;&#x540C;&#x3002; &#x4F8B;&#x5982;&#xFF0C;(1)&#x662F;&#x7B2C;&#x4E00;&#x4E2A;&#x76EE;&#x6807;&#x5217;&#x8868;&#x4E2D;&#x7684;&#x4E00;&#x9879;&#xFF0C;&#x5B83;&#x662F;&#x8868;&#x7684;&apos;id&apos;&#x5217;&#xFF0C;(4)&#x662F;WHERE&#x5B50;&#x53E5;&#xFF0C;&#x7B49;&#x7B49;&#x3002;</p>
<p>&#x7531;&#x4E8E;&#x89E3;&#x6790;&#x5668;&#x4EC5;&#x5728;&#x751F;&#x6210;&#x89E3;&#x6790;&#x6811;&#x65F6;&#x68C0;&#x67E5;&#x8F93;&#x5165;&#x7684;&#x8BED;&#x6CD5;&#xFF0C;&#x56E0;&#x6B64;&#x53EA;&#x6709;&#x5728;&#x67E5;&#x8BE2;&#x4E2D;&#x5B58;&#x5728;&#x8BED;&#x6CD5;&#x9519;&#x8BEF;&#x65F6;&#x624D;&#x4F1A;&#x8FD4;&#x56DE;&#x9519;&#x8BEF;&#x3002;</p>
<p>&#x89E3;&#x6790;&#x5668;&#x4E0D;&#x68C0;&#x67E5;&#x8F93;&#x5165;&#x67E5;&#x8BE2;&#x7684;&#x8BED;&#x4E49;&#x3002; &#x4F8B;&#x5982;&#xFF0C;&#x5373;&#x4F7F;&#x67E5;&#x8BE2;&#x5305;&#x542B;&#x4E0D;&#x5B58;&#x5728;&#x7684;&#x8868;&#x540D;&#xFF0C;&#x89E3;&#x6790;&#x5668;&#x4E5F;&#x4E0D;&#x4F1A;&#x8FD4;&#x56DE;&#x9519;&#x8BEF;&#x3002; &#x8BED;&#x4E49;&#x68C0;&#x67E5;&#x7531;&#x5206;&#x6790;&#x5668;&#x5B8C;&#x6210;&#x3002;</p>
<h3 id="312-&#x5206;&#x6790;&#x5668;analyzer">3.1.2. &#x5206;&#x6790;&#x5668;(Analyzer)</h3>
<p>&#x5206;&#x6790;&#x5668;&#x5BF9;&#x89E3;&#x6790;&#x6811;&#x8FDB;&#x884C;&#x8BED;&#x4E49;&#x5206;&#x6790;&#x5E76;&#x751F;&#x6210;&#x67E5;&#x8BE2;&#x6811;&#x3002;</p>
<p>&#x67E5;&#x8BE2;&#x6811;&#x7684;&#x6839;&#x662F; <a href="javascript:void(0" target="_blank">Query</a>) &#x7ED3;&#x6784;&#x4F53;(<a href="https://github.com/postgres/postgres/blob/master/src/include/nodes/parsenodes.h" target="_blank">parsenodes.h</a>&#x4E2D;&#x5B9A;&#x4E49;); &#x6B64;&#x7ED3;&#x6784;&#x5305;&#x542B;&#x5176;&#x76F8;&#x5E94;&#x67E5;&#x8BE2;&#x7684;&#x5143;&#x6570;&#x636E;&#xFF0C;&#x4F8B;&#x5982;&#x6B64;&#x547D;&#x4EE4;&#x7684;&#x7C7B;&#x578B;(SELECT&#xFF0C;INSERT&#x6216;&#x5176;&#x4ED6;)&#x4EE5;&#x53CA;&#x591A;&#x4E2A;&#x53F6;&#x5B50;; &#x6BCF;&#x4E2A;&#x53F6;&#x5B50;&#x5F62;&#x6210;&#x4E00;&#x4E2A;&#x5217;&#x8868;&#x6216;&#x4E00;&#x68F5;&#x6811;&#x5E76;&#x4FDD;&#x5B58;&#x4E2A;&#x522B;&#x7279;&#x5B9A;&#x5B50;&#x53E5;&#x7684;&#x6570;&#x636E;&#x3002;</p>
<p>&#x56FE;3.3&#x8BF4;&#x660E;&#x4E86;&#x524D;&#x4E00;&#x5C0F;&#x8282;&#x4E2D;&#x56FE;3.2(a)&#x6240;&#x793A;&#x67E5;&#x8BE2;&#x7684;&#x67E5;&#x8BE2;&#x6811;&#x3002;</p>
<p><strong>&#x56FE;. 3.3. &#x67E5;&#x8BE2;&#x6811;&#x793A;&#x4F8B;</strong></p>
<p><img src="https://github.com/yonj1e/The-Internals-of-PostgreSQL/blob/master/imgs/ch3/fig-3-03.png?raw=true" alt="Fig. 3.3. An example of a query tree."></p>
<p>&#x4E0A;&#x9762;&#x7684;&#x67E5;&#x8BE2;&#x6811;&#x7B80;&#x8981;&#x63CF;&#x8FF0;&#x5982;&#x4E0B;&#x3002;</p>
<ul>
<li>targetList&#x662F;&#x8BE5;&#x67E5;&#x8BE2;&#x7ED3;&#x679C;&#x5217;&#x7684;&#x5217;&#x8868;&#x3002; &#x5728;&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x4E2D;&#xFF0C;&#x8FD9;&#x4E2A;&#x5217;&#x8868;&#x7531;&#x4E24;&#x5217;&#x7EC4;&#x6210;&#xFF1A;&apos;id&apos;&#x548C;&apos;data&apos;&#x3002; &#x5982;&#x679C;&#x8F93;&#x5165;&#x67E5;&#x8BE2;&#x6811;&#x4F7F;&#x7528;&apos;*&apos;&#xFF0C;&#x5219;&#x5206;&#x6790;&#x5668;&#x5C06;&#x660E;&#x786E;&#x5730;&#x5C06;&#x5176;&#x66FF;&#x6362;&#x4E3A;&#x6240;&#x6709;&#x5217;&#x3002;</li>
<li>rtable&#x662F;&#x6B64;&#x67E5;&#x8BE2;&#x4E2D;&#x4F7F;&#x7528;&#x7684;&#x5173;&#x7CFB;&#x5217;&#x8868;&#x3002; &#x5728;&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x4E2D;&#xFF0C;&#x8FD9;&#x4E2A;&#x8868;&#x4FDD;&#x5B58;&#x4E86;&#x8868;&apos;tbl_a&apos;&#x7684;&#x4FE1;&#x606F;&#xFF0C;&#x6BD4;&#x5982;&#x8FD9;&#x4E2A;&#x8868;&#x7684;oid&#x548C;&#x8FD9;&#x4E2A;&#x8868;&#x7684;&#x540D;&#x5B57;&#x3002;</li>
<li>jointree&#x5B58;&#x50A8;&#x4E86;FROM&#x5B50;&#x53E5;&#x548C;WHERE&#x5B50;&#x53E5;&#x3002;</li>
<li>sortClause&#x662F;SortGroupClause&#x7684;&#x5217;&#x8868;&#x3002;</li>
</ul>
<p><a href="http://www.postgresql.org/docs/current/static/querytree.html" target="_blank">&#x5B98;&#x65B9;&#x6587;&#x6863;</a>&#x4E2D;&#x63CF;&#x8FF0;&#x4E86;&#x67E5;&#x8BE2;&#x6811;&#x7684;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#x3002;</p>
<h3 id="313-&#x91CD;&#x5199;&#x5668;rewriter">3.1.3. &#x91CD;&#x5199;&#x5668;(Rewriter)</h3>
<p>&#x91CD;&#x5199;&#x662F;&#x5B9E;&#x73B0;&#x89C4;&#x5219;&#x7CFB;&#x7EDF;&#x7684;&#x7CFB;&#x7EDF;&#xFF0C;&#x6839;&#x636E;&#x5B58;&#x50A8;&#x5728;pg_rules&#x7CFB;&#x7EDF;&#x76EE;&#x5F55;&#x4E2D;&#x7684;&#x89C4;&#x5219;&#x8F6C;&#x6362;&#x67E5;&#x8BE2;&#x6811;&#x3002; &#x89C4;&#x5219;&#x7CFB;&#x7EDF;&#x672C;&#x8EAB;&#x5C31;&#x662F;&#x4E00;&#x4E2A;&#x6709;&#x8DA3;&#x7684;&#x4F53;&#x7CFB;&#xFF0C;&#x4F46;&#x662F;&#x4E3A;&#x4E86;&#x9632;&#x6B62;&#x672C;&#x7AE0;&#x53D8;&#x5F97;&#x592A;&#x957F;&#xFF0C;&#x89C4;&#x5219;&#x7CFB;&#x7EDF;&#x548C;&#x91CD;&#x5199;&#x5668;&#x7684;&#x63CF;&#x8FF0;&#x88AB;&#x5FFD;&#x7565;&#x4E86;&#x3002;</p>
<blockquote>
<p>:pushpin: PostgreSQL&#x4E2D;&#x7684;<a href="https://www.postgresql.org/docs/current/static/rules-views.html" target="_blank">&#x89C6;&#x56FE;</a>&#x4F7F;&#x7528;&#x89C4;&#x5219;&#x7CFB;&#x7EDF;&#x5B9E;&#x73B0;&#x3002; &#x5F53;&#x89C6;&#x56FE;&#x7531;<a href="http://www.postgresql.org/docs/current/static/sql-createview.html" target="_blank">CREATE VIEW</a> &#x547D;&#x4EE4;&#x5B9A;&#x4E49;&#x65F6;&#xFF0C;&#x81EA;&#x52A8;&#x751F;&#x6210;&#x76F8;&#x5E94;&#x7684;&#x89C4;&#x5219;&#x5E76;&#x5C06;&#x5176;&#x5B58;&#x50A8;&#x5728;&#x7CFB;&#x7EDF;&#x76EE;&#x5F55;&#x4E2D;&#x3002; </p>
<p>&#x5047;&#x5B9A;&#x5DF2;&#x7ECF;&#x5B9A;&#x4E49;&#x4E86;&#x4EE5;&#x4E0B;&#x89C6;&#x56FE;&#xFF0C;&#x5E76;&#x4E14;&#x76F8;&#x5E94;&#x7684;&#x89C4;&#x5219;&#x5B58;&#x50A8;&#x5728;pg_rules&#x7CFB;&#x7EDF;&#x76EE;&#x5F55;&#x4E2D;&#x3002;</p>
<pre><code class="lang-sql">sampledb=# <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> employees_list 
sampledb-#      <span class="hljs-keyword">AS</span> <span class="hljs-keyword">SELECT</span> e.<span class="hljs-keyword">id</span>, e.<span class="hljs-keyword">name</span>, d.<span class="hljs-keyword">name</span> <span class="hljs-keyword">AS</span> department 
sampledb-#            <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">AS</span> e, departments <span class="hljs-keyword">AS</span> d <span class="hljs-keyword">WHERE</span> e.department_id = d.<span class="hljs-keyword">id</span>;E
</code></pre>
<p>&#x5F53;&#x53D1;&#x51FA;&#x5305;&#x542B;&#x5982;&#x4E0B;&#x6240;&#x793A;&#x7684;&#x89C6;&#x56FE;&#x67E5;&#x8BE2;&#x65F6;&#xFF0C;&#x89E3;&#x6790;&#x5668;&#x5C06;&#x521B;&#x5EFA;&#x89E3;&#x6790;&#x6811;&#xFF0C;&#x5982;&#x56FE;3.4(a)&#x6240;&#x793A;&#x3002;</p>
<pre><code class="lang-sql">sampledb=# <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> employees_list;
</code></pre>
<p>&#x5728;&#x6B64;&#x9636;&#x6BB5;&#xFF0C;&#x91CD;&#x5199;&#x5668;&#x5C06;&#x8303;&#x56F4;&#x8868;&#x8282;&#x70B9;&#x5904;&#x7406;&#x4E3A;&#x5B50;&#x67E5;&#x8BE2;&#x7684;&#x89E3;&#x6790;&#x6811;&#xFF0C;&#x5B50;&#x67E5;&#x8BE2;&#x662F;&#x5B58;&#x50A8;&#x5728;<em>pg_rules</em>&#x4E2D;&#x7684;&#x5BF9;&#x5E94;&#x89C6;&#x56FE;&#x3002; </p>
</blockquote>
<p><strong>&#x56FE;. 3.4. &#x91CD;&#x5199;&#x793A;&#x4F8B;</strong></p>
<p><img src="https://github.com/yonj1e/The-Internals-of-PostgreSQL/blob/master/imgs/ch3/fig-3-04.png?raw=true" alt="Fig. 3.4. An example of the rewriter stage."></p>
<p>&#x7531;&#x4E8E;PostgreSQL&#x4F7F;&#x7528;&#x8FD9;&#x79CD;&#x673A;&#x5236;&#x6765;&#x5B9E;&#x73B0;&#x89C6;&#x56FE;&#xFF0C;&#x5728;9.2&#x7248;&#x672C;&#x4E4B;&#x524D;&#x89C6;&#x56FE;&#x65E0;&#x6CD5;&#x66F4;&#x65B0;&#x3002; &#x4F46;&#x662F;&#xFF0C;&#x4ECE;9.3&#x7248;&#x672C;&#x5F00;&#x59CB;&#x89C6;&#x56FE;&#x53EF;&#x4EE5;&#x66F4;&#x65B0;; &#x5C3D;&#x7BA1;&#x5982;&#x6B64;&#xFF0C;&#x66F4;&#x65B0;&#x89C6;&#x56FE;&#x6709;&#x5F88;&#x591A;&#x9650;&#x5236;&#x3002;&#x8FD9;&#x4E9B;&#x7EC6;&#x8282;&#x5728;<a href="https://www.postgresql.org/docs/current/static/sql-createview.html#SQL-CREATEVIEW-UPDATABLE-VIEWS" target="_blank">&#x5B98;&#x65B9;&#x6587;&#x6863;</a>&#x4E2D;&#x4F5C;&#x4E86;&#x8BF4;&#x660E;&#x3002; </p>
<h3 id="314-&#x4F18;&#x5316;&#x5668;planner&#x548C;&#x6267;&#x884C;&#x5668;exector">3.1.4. &#x4F18;&#x5316;&#x5668;(planner)&#x548C;&#x6267;&#x884C;&#x5668;(exector)</h3>
<p>&#x4F18;&#x5316;&#x5668;&#x4ECE;&#x91CD;&#x5199;&#x5668;&#x63A5;&#x6536;&#x67E5;&#x8BE2;&#x6811;&#x5E76;&#x751F;&#x6210;&#x53EF;&#x7531;&#x6267;&#x884C;&#x5668;&#x6700;&#x4F18;&#x5904;&#x7406;&#x7684;(&#x67E5;&#x8BE2;)&#x8BA1;&#x5212;&#x6811;&#x3002; </p>
<p>PostgreSQL&#x4E2D;&#x7684;&#x4F18;&#x5316;&#x5668;&#x662F;&#x57FA;&#x4E8E;&#x6210;&#x672C;&#x7684;&#x4F18;&#x5316;&#xFF1B;&#x5B83;&#x4E0D;&#x652F;&#x6301;&#x57FA;&#x4E8E;&#x89C4;&#x5219;&#x7684;&#x4F18;&#x5316;&#x548C;&#x63D0;&#x793A;&#x3002;&#x6B64;&#x8BA1;&#x5212;&#x5668;&#x662F;RDBMS&#x4E2D;&#x6700;&#x590D;&#x6742;&#x7684;&#x5B50;&#x7CFB;&#x7EDF;&#xFF1B;&#x56E0;&#x6B64;&#xFF0C;&#x672C;&#x7AE0;&#x540E;&#x9762;&#x7684;&#x90E8;&#x5206;&#x5C06;&#x8BE6;&#x7EC6;&#x63CF;&#x8FF0;&#x4F18;&#x5316;&#x5668;&#x3002; </p>
<blockquote>
<p>:pushpin: <em>pg_hint_plan</em></p>
<p>PostgreSQL&#x4E0D;&#x652F;&#x6301;&#x5728;SQL&#x4E2D;&#x89C4;&#x5212;&#x63D0;&#x793A;&#xFF0C;&#x5B83;&#x5C06;&#x6C38;&#x8FDC;&#x4E0D;&#x88AB;&#x652F;&#x6301;&#x3002;&#x5982;&#x679C;&#x60A8;&#x60F3;&#x5728;&#x67E5;&#x8BE2;&#x4E2D;&#x4F7F;&#x7528;&#x63D0;&#x793A;&#xFF0C;&#x90A3;&#x4E48;&#x503C;&#x5F97;&#x8003;&#x8651;&#x5F15;&#x7528;<em>pg_hint_plan</em>&#x6269;&#x5C55;&#x3002;&#x8BF7;&#x8BE6;&#x7EC6;&#x53C2;&#x8003;<a href="http://pghintplan.osdn.jp/pg_hint_plan.html" target="_blank">&#x5B98;&#x65B9;&#x7F51;&#x7AD9;</a>&#x3002; </p>
</blockquote>
<p>&#x4E0E;&#x5176;&#x4ED6;RDBMS&#x4E00;&#x6837;&#xFF0C;PostgreSQL&#x4E2D;&#x7684; <a href="http://www.postgresql.org/docs/current/static/sql-explain.html" target="_blank">EXPLAIN</a> &#x547D;&#x4EE4;&#x663E;&#x793A;&#x8BA1;&#x5212;&#x6811;&#x3002; &#x793A;&#x4F8B;&#x5982;&#x4E0B;&#x6240;&#x793A;&#x3002;</p>
<pre><code class="lang-sql">testdb=# EXPLAIN SELECT * FROM tbl_a WHERE id &lt; 300 ORDER BY data;                                              QUERY PLAN                           
--------------------------------------------------------------- 
Sort  (cost=182.34..183.09 rows=300 width=8)   
    Sort Key: data   
        -&gt;  Seq Scan on tbl_a  (cost=0.00..170.00 rows=300 width=8)         
            Filter: (id &lt; 300)
(4 rows)
</code></pre>
<p>&#x8FD9;&#x4E2A;&#x7ED3;&#x679C;&#x663E;&#x793A;&#x4E86;&#x56FE;3.5&#x6240;&#x793A;&#x7684;&#x8BA1;&#x5212;&#x6811;&#x3002;</p>
<p><strong>&#x56FE;. 3.5. &#x8BA1;&#x5212;&#x6811;&#x793A;&#x4F8B;&#xFF0C;&#x8BA1;&#x5212;&#x6811;&#x4E0E;EXPLAIN&#x547D;&#x4EE4;&#x7684;&#x7ED3;&#x679C;&#x4E4B;&#x95F4;&#x7684;&#x5173;&#x7CFB;</strong><img src="https://github.com/yonj1e/The-Internals-of-PostgreSQL/blob/master/imgs/ch3/fig-3-05.png?raw=true" alt="Fig. 3.5. A simple plan tree and the relationship between the plan tree and the result of the EXPLAIN command."></p>
<p>&#x8BA1;&#x5212;&#x6811;&#x7531;&#x79F0;&#x4E3A; <em>&#x8BA1;&#x5212;&#x8282;&#x70B9;(plan nodes)</em> &#x7684;&#x5143;&#x7D20;&#x7EC4;&#x6210;&#xFF0C;&#x5E76;&#x8FDE;&#x63A5;&#x5230; <em>PlannedStmt</em> &#x7ED3;&#x6784;&#x7684; Plantree &#x5217;&#x8868;&#x3002; &#x8FD9;&#x4E9B;&#x5143;&#x7D20;&#x5728; <a href="https://github.com/postgres/postgres/blob/master/src/include/nodes/plannodes.h" target="_blank">plannodes.h</a> &#x4E2D;&#x5B9A;&#x4E49;&#x3002; &#x7EC6;&#x8282;&#x5C06;&#x5728;&#x7B2C;3.3.3&#x8282;(&#x548C;&#x7B2C;3.5.4.2&#x8282;)&#x4E2D;&#x63CF;&#x8FF0;&#x3002; </p>
<p>&#x6BCF;&#x4E2A;&#x8BA1;&#x5212;&#x8282;&#x70B9;&#x90FD;&#x5177;&#x6709;&#x6267;&#x884C;&#x5668;&#x5904;&#x7406;&#x6240;&#x9700;&#x7684;&#x4FE1;&#x606F;&#xFF0C;&#x5E76;&#x4E14;&#x5728;&#x5355;&#x8868;&#x67E5;&#x8BE2;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x6267;&#x884C;&#x5668;&#x5C06;&#x4ECE;&#x8BA1;&#x5212;&#x6811;&#x7684;&#x672B;&#x5C3E;&#x5904;&#x7406;&#x5230;&#x6839;&#x8282;&#x70B9;&#x3002; </p>
<p>&#x4F8B;&#x5982;&#xFF0C;&#x56FE;3.5&#x6240;&#x793A;&#x7684;&#x8BA1;&#x5212;&#x6811;&#x662F;&#x4E00;&#x4E2A;&#x6392;&#x5E8F;&#x8282;&#x70B9;&#x548C;&#x4E00;&#x4E2A;&#x987A;&#x5E8F;&#x626B;&#x63CF;&#x8282;&#x70B9;&#x7684;&#x5217;&#x8868;; &#x56E0;&#x6B64;&#xFF0C;&#x6267;&#x884C;&#x5668;&#x901A;&#x8FC7;&#x987A;&#x5E8F;&#x626B;&#x63CF;&#x8868;&#xFF1A;tbl_a&#xFF0C;&#x7136;&#x540E;&#x5BF9;&#x83B7;&#x5F97;&#x7684;&#x7ED3;&#x679C;&#x8FDB;&#x884C;&#x6392;&#x5E8F;&#x3002; </p>
<p>&#x6267;&#x884C;&#x5668;&#x901A;&#x8FC7;&#x7F13;&#x51B2;&#x533A;&#x7BA1;&#x7406;&#x5668;(<a href="ch8.html">&#x7B2C;&#x516B;&#x7AE0;</a>&#x4E2D;&#x63CF;&#x8FF0;)&#x8BFB;&#x5199;&#x6570;&#x636E;&#x5E93;&#x96C6;&#x7FA4;&#x4E2D;&#x7684;&#x8868;&#x548C;&#x7D22;&#x5F15;&#x3002;&#x5904;&#x7406;&#x67E5;&#x8BE2;&#x65F6;&#xFF0C;&#x6267;&#x884C;&#x5668;&#x4F7F;&#x7528;&#x4E00;&#x4E9B;&#x9884;&#x5148;&#x5206;&#x914D;&#x7684;&#x5185;&#x5B58;&#x533A;(&#x5982;temp_buffers&#x548C;work_mem)&#xFF0C;&#x5E76;&#x5728;&#x5FC5;&#x8981;&#x65F6;&#x521B;&#x5EFA;&#x4E34;&#x65F6;&#x6587;&#x4EF6;&#x3002;</p>
<p>&#x53E6;&#x5916;&#xFF0C;&#x5728;&#x8BBF;&#x95EE;&#x5143;&#x7EC4;&#x65F6;&#xFF0C;PostgreSQL&#x4F7F;&#x7528;&#x5E76;&#x53D1;&#x63A7;&#x5236;&#x673A;&#x5236;&#x6765;&#x7EF4;&#x62A4;&#x6B63;&#x5728;&#x8FD0;&#x884C;&#x7684;&#x4E8B;&#x52A1;&#x7684;&#x4E00;&#x81F4;&#x6027;&#x548C;&#x9694;&#x79BB;&#x6027;&#x3002; <a href="ch5.html">&#x7B2C;5&#x7AE0;</a>&#x4ECB;&#x7ECD;&#x4E86;&#x5E76;&#x53D1;&#x63A7;&#x5236;&#x673A;&#x5236;&#x3002;</p>
<p><strong>&#x56FE;. 3.6. &#x6267;&#x884C;&#x5668;&#xFF0C;&#x7F13;&#x51B2;&#x533A;&#x7BA1;&#x7406;&#x8005;&#x548C;&#x4E34;&#x65F6;&#x6587;&#x4EF6;&#x4E4B;&#x95F4;&#x7684;&#x5173;&#x7CFB;</strong></p>
<p><img src="https://github.com/yonj1e/The-Internals-of-PostgreSQL/blob/master/imgs/ch3/fig-3-06.png?raw=true" alt="Fig. 3.6. The relationship among the executor, buffer manager and temporary files."></p>
<hr>
<h2 id="32-&#x5355;&#x8868;&#x67E5;&#x8BE2;&#x4E2D;&#x7684;&#x6210;&#x672C;&#x4F30;&#x7B97;">3.2. &#x5355;&#x8868;&#x67E5;&#x8BE2;&#x4E2D;&#x7684;&#x6210;&#x672C;&#x4F30;&#x7B97;</h2>
<p>PostgreSQL&#x7684;&#x67E5;&#x8BE2;&#x4F18;&#x5316;&#x57FA;&#x4E8E;&#x6210;&#x672C;&#x3002; &#x6210;&#x672C;&#x662F;&#x65E0;&#x91CF;&#x7EB2;&#x7684;&#x4EF7;&#x503C;&#xFF0C;&#x800C;&#x8FD9;&#x4E9B;&#x5E76;&#x4E0D;&#x662F;&#x7EDD;&#x5BF9;&#x7684;&#x7EE9;&#x6548;&#x6307;&#x6807;&#xFF0C;&#x800C;&#x662F;&#x7528;&#x6765;&#x6BD4;&#x8F83;&#x7ECF;&#x8425;&#x76F8;&#x5BF9;&#x7EE9;&#x6548;&#x7684;&#x6307;&#x6807;&#x3002;</p>
<p>&#x6210;&#x672C;&#x901A;&#x8FC7;<a href="https://github.com/postgres/postgres/blob/master/src/backend/optimizer/path/costsize.c" target="_blank">costsize.c</a> &#x4E2D;&#x5B9A;&#x4E49;&#x7684;&#x51FD;&#x6570;&#x4F30;&#x7B97;&#x3002; &#x6267;&#x884C;&#x5668;&#x6267;&#x884C;&#x7684;&#x6240;&#x6709;&#x64CD;&#x4F5C;&#x90FD;&#x5177;&#x6709;&#x76F8;&#x5E94;&#x7684;&#x6210;&#x672C;&#x4F30;&#x7B97;&#x51FD;&#x6570;&#x3002; &#x4F8B;&#x5982;&#xFF0C;&#x987A;&#x5E8F;&#x626B;&#x63CF;&#x548C;&#x7D22;&#x5F15;&#x626B;&#x63CF;&#x7684;&#x6210;&#x672C;&#x5206;&#x522B;&#x7531;cost_seqscan()&#x548C;cost_index()&#x8FDB;&#x884C;&#x4F30;&#x7B97;&#x3002;</p>
<p>&#x5728;PostgreSQL&#x4E2D;&#xFF0C;&#x6709;&#x4E09;&#x79CD;&#x6210;&#x672C;&#xFF1A;<strong>&#x542F;&#x52A8;(start-up)</strong>&#xFF0C;<strong>&#x8FD0;&#x884C;(run)</strong>&#x548C;<strong>&#x603B;&#x8BA1;(total)</strong>&#x3002; &#x603B;&#x6210;&#x672C;&#x662F;&#x542F;&#x52A8;&#x548C;&#x8FD0;&#x884C;&#x6210;&#x672C;&#x7684;&#x603B;&#x548C;; &#x56E0;&#x6B64;&#xFF0C;&#x72EC;&#x7ACB;&#x4F30;&#x8BA1;&#x53EA;&#x6709;&#x542F;&#x52A8;&#x548C;&#x8FD0;&#x884C;&#x6210;&#x672C;&#x3002;</p>
<ul>
<li><strong>&#x542F;&#x52A8;&#x6210;&#x672C;</strong>&#x662F;&#x5728;&#x83B7;&#x53D6;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7EC4;&#x4E4B;&#x524D;&#x82B1;&#x8D39;&#x7684;&#x6210;&#x672C;&#x3002; &#x4F8B;&#x5982;&#xFF0C;&#x7D22;&#x5F15;&#x626B;&#x63CF;&#x8282;&#x70B9;&#x7684;&#x542F;&#x52A8;&#x6210;&#x672C;&#x662F;&#x8BFB;&#x53D6;&#x7D22;&#x5F15;&#x9875;&#x4EE5;&#x8BBF;&#x95EE;&#x76EE;&#x6807;&#x8868;&#x4E2D;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7EC4;&#x7684;&#x5F00;&#x9500;&#x3002;</li>
<li><strong>&#x8FD0;&#x884C;&#x6210;&#x672C;</strong>&#x662F;&#x83B7;&#x53D6;&#x6240;&#x6709;&#x5143;&#x7EC4;&#x7684;&#x6210;&#x672C;&#x3002;</li>
<li><strong>&#x603B;&#x6210;&#x672C;</strong>&#x662F;&#x542F;&#x52A8;&#x6210;&#x672C;&#x548C;&#x8FD0;&#x884C;&#x6210;&#x672C;&#x7684;&#x603B;&#x548C;&#x3002;</li>
</ul>
<p><a href="https://www.postgresql.org/docs/current/static/sql-explain.html" target="_blank">EXPLAIN</a>&#x547D;&#x4EE4;&#x663E;&#x793A;&#x6BCF;&#x4E2A;&#x64CD;&#x4F5C;&#x7684;&#x542F;&#x52A8;&#x548C;&#x603B;&#x6210;&#x672C;&#x3002; &#x6700;&#x7B80;&#x5355;&#x7684;&#x4F8B;&#x5B50;&#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF1A;</p>
<pre><code class="lang-sql">testdb=# <span class="hljs-keyword">EXPLAIN</span> <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> tbl;
                    QUERY PLAN                        
<span class="hljs-comment">--------------------------------------------------------- </span>
Seq Scan on tbl  (cost=0.00..145.00 rows=10000 width=8)
(1 row)
</code></pre>
<p>&#x5728;&#x7B2C;4&#x884C;&#x4E2D;&#xFF0C;&#x8BE5;&#x547D;&#x4EE4;&#x663E;&#x793A;&#x6709;&#x5173;&#x987A;&#x5E8F;&#x626B;&#x63CF;&#x7684;&#x4FE1;&#x606F;&#x3002; &#x5728;&#x6210;&#x672C;&#x90E8;&#x5206;&#xFF0C;&#x6709;&#x4E24;&#x4E2A;&#x503C;; 0.00&#x548C;145.00&#x3002; &#x5728;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x542F;&#x52A8;&#x6210;&#x672C;&#x548C;&#x603B;&#x6210;&#x672C;&#x5206;&#x522B;&#x4E3A;0.00&#x548C;145.00&#x3002;</p>
<p>&#x5728;&#x672C;&#x8282;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x8BE6;&#x7EC6;&#x63A2;&#x8BA8;&#x5982;&#x4F55;&#x4F30;&#x8BA1;&#x987A;&#x5E8F;&#x626B;&#x63CF;(sequential scan)&#xFF0C;&#x7D22;&#x5F15;&#x626B;&#x63CF;(index scan)&#x548C;&#x6392;&#x5E8F;&#x64CD;&#x4F5C;(sort operation)&#x3002;</p>
<p>&#x5728;&#x4E0B;&#x9762;&#x7684;&#x63CF;&#x8FF0;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x4F7F;&#x7528;&#x5982;&#x4E0B;&#x6240;&#x793A;&#x7684;&#x8868;&#x548C;&#x7D22;&#x5F15;&#xFF1A;</p>
<pre><code class="lang-sql">testdb=# <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> tbl (<span class="hljs-keyword">id</span> <span class="hljs-built_in">int</span> PRIMARY <span class="hljs-keyword">KEY</span>, <span class="hljs-keyword">data</span> <span class="hljs-built_in">int</span>);
testdb=# <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> tbl_data_idx <span class="hljs-keyword">ON</span> tbl (<span class="hljs-keyword">data</span>);
testdb=# <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> tbl <span class="hljs-keyword">SELECT</span> generate_series(<span class="hljs-number">1</span>,<span class="hljs-number">10000</span>),generate_series(<span class="hljs-number">1</span>,<span class="hljs-number">10000</span>);
testdb=# <span class="hljs-keyword">ANALYZE</span>;
testdb=# \d tbl
      Table &quot;public.tbl&quot;
 Column |  Type   | Modifiers 
<span class="hljs-comment">--------+---------+-----------</span>
 id     | integer | not null
 data   | integer | 
Indexes:
    &quot;tbl_pkey&quot; PRIMARY KEY, btree (id)
    &quot;tbl_data_idx&quot; btree (data)
</code></pre>
<h3 id="321-&#x987A;&#x5E8F;&#x626B;&#x63CF;">3.2.1. &#x987A;&#x5E8F;&#x626B;&#x63CF;</h3>
<p>&#x987A;&#x5E8F;&#x626B;&#x63CF;&#x7684;&#x6210;&#x672C;&#x7531;cost_seqscan()&#x51FD;&#x6570;&#x4F30;&#x8BA1;&#x3002; &#x5728;&#x672C;&#x5C0F;&#x8282;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x63A2;&#x8BA8;&#x5982;&#x4F55;&#x4F30;&#x8BA1;&#x4EE5;&#x4E0B;&#x67E5;&#x8BE2;&#x7684;&#x987A;&#x5E8F;&#x626B;&#x63CF;&#x6210;&#x672C;&#x3002;</p>
<pre><code class="lang-sql">testdb=# <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> tbl <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> &lt; <span class="hljs-number">8000</span>;
</code></pre>
<p>&#x5728;&#x987A;&#x5E8F;&#x626B;&#x63CF;&#x4E2D;&#xFF0C;&#x542F;&#x52A8;&#x6210;&#x672C;&#x7B49;&#x4E8E;0&#xFF0C;&#x8FD0;&#x884C;&#x6210;&#x672C;&#x7531;&#x4EE5;&#x4E0B;&#x516C;&#x5F0F;&#x5B9A;&#x4E49;&#xFF1A;</p>
<p>&#x200B;    &#x2018;run cost&#x2019; = &#x2018;cpu run cost&#x2019; + &#x2018;disk run cost&#x2019;</p>
<p>&#x200B;            = (cpu<em>tuple_cost + cpu_operator_cost) &#xD7; $N</em> {tuple}$ + seq<em>page_cost &#xD7; $N</em> {page}$</p>
<p>&#x5176;&#x4E2D;<a href="https://www.postgresql.org/docs/current/static/runtime-config-query.html#GUC-SEQ-PAGE-COST" target="_blank">seq_page_cost</a>, <a href="https://www.postgresql.org/docs/current/static/runtime-config-query.html#GUC-CPU-TUPLE-COST" target="_blank">cpu_tuple_cost</a>&#x548C;<a href="https://www.postgresql.org/docs/current/static/runtime-config-query.html#GUC-CPU-OPERATOR-COST" target="_blank">cpu_operator_cost</a>&#x5728;postgresql.conf&#x6587;&#x4EF6;&#x4E2D;&#x8BBE;&#x7F6E;&#xFF0C;&#x9ED8;&#x8BA4;&#x503C;&#x5206;&#x522B;&#x4E3A;1.0, 0.01&#x548C;0.0025; $N<em> {tuple}$&#x548C;N$N</em> {page}$&#x5206;&#x522B;&#x662F;&#x8BE5;&#x8868;&#x7684;&#x6240;&#x6709;&#x5143;&#x7EC4;&#x548C;&#x6240;&#x6709;&#x9875;&#x9762;&#x7684;&#x7F16;&#x53F7;&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x4EE5;&#x4E0B;&#x67E5;&#x8BE2;&#x663E;&#x793A;&#x8FD9;&#x4E9B;&#x7F16;&#x53F7;&#xFF1A;</p>
<pre><code class="lang-sql">testdb=# <span class="hljs-keyword">SELECT</span> relpages, reltuples <span class="hljs-keyword">FROM</span> pg_class <span class="hljs-keyword">WHERE</span> relname = <span class="hljs-string">&apos;tbl&apos;</span>;
 relpages | reltuples 
<span class="hljs-comment">----------+-----------</span>
       45 |     10000
(1 row)
</code></pre>
<p>&#x200B;    (1) $N<em> {page}$=10000,
    (2) $N</em> {page}$=45.        </p>
<p>&#x4ECE;&#x800C;,</p>
<p>&#x200B;    &#x2018;run cost&#x2019;  =  (0.01 + 0.0025) &#xD7; 10000 + 1.0 &#xD7; 45 = 170.0.</p>
<p>&#x6700;&#x7EC8;,</p>
<p>&#x200B;    &#x2018;total cost&#x2019; = 0.0 + 170.0 = 170.</p>
<p>&#x4E3A;&#x4E86;&#x786E;&#x8BA4;&#xFF0C;&#x4EE5;&#x4E0A;&#x67E5;&#x8BE2;&#x7684;EXPLAIN&#x547D;&#x4EE4;&#x7684;&#x7ED3;&#x679C;&#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF1A;</p>
<pre><code class="lang-sql">testdb=# EXPLAIN SELECT * FROM tbl WHERE id &lt; 8000;
                    QUERY PLAN                       
-------------------------------------------------------- 
Seq Scan on tbl  (cost=0.00..170.00 rows=8000 width=8)   
    Filter: (id &lt; 8000)
(2 rows)
</code></pre>
<p>&#x5728;&#x7B2C;4&#x884C;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#x542F;&#x52A8;&#x548C;&#x603B;&#x6210;&#x672C;&#x5206;&#x522B;&#x662F;170.00&#x548C;170.00&#xFF0C; &#x636E;&#x4F30;&#x8BA1;&#xFF0C;&#x5C06;&#x901A;&#x8FC7;&#x626B;&#x63CF;&#x6240;&#x6709;&#x884C;&#x6765;&#x9009;&#x62E9;8000&#x884C;(tuple)&#x3002;  &#x5728;&#x7B2C;5&#x884C;&#x4E2D;&#xFF0C;&#x663E;&#x793A;&#x4E86;&#x987A;&#x5E8F;&#x626B;&#x63CF;&#x7684;&#x8FC7;&#x6EE4;&#x5668;&#x2018;Filter&#xFF1A;(ID&lt;8000)&#x2019;&#x3002; &#x66F4;&#x51C6;&#x786E;&#x5730;&#x8BF4;&#xFF0C;&#x5B83;&#x88AB;&#x79F0;&#x4E3A;<em>table level filter predicate</em>&#x3002; &#x8BF7;&#x6CE8;&#x610F;&#xFF0C;&#x8FD9;&#x79CD;&#x7C7B;&#x578B;&#x7684;&#x8FC7;&#x6EE4;&#x5668;&#x662F;&#x5728;&#x8BFB;&#x53D6;&#x8868;&#x4E2D;&#x7684;&#x6240;&#x6709;&#x5143;&#x7EC4;&#x65F6;&#x4F7F;&#x7528;&#x7684;&#xFF0C;&#x5E76;&#x4E14;&#x5B83;&#x4E0D;&#x4F1A;&#x7F29;&#x5C0F;page&#x9875;&#x7684;&#x626B;&#x63CF;&#x8303;&#x56F4;&#x3002; </p>
<blockquote>
<p>:pushpin: &#x4ECE;&#x8FD0;&#x884C;&#x6210;&#x672C;&#x4F30;&#x7B97;&#x4E2D;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#xFF0C;PostgreSQL&#x5047;&#x8BBE;&#x6240;&#x6709;&#x9875;&#x9762;&#x90FD;&#x5C06;&#x4ECE;&#x5B58;&#x50A8;&#x4E2D;&#x8BFB;&#x53D6;; &#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#xFF0C;PostgreSQL&#x4E0D;&#x4F1A;&#x8003;&#x8651;&#x626B;&#x63CF;&#x9875;&#x662F;&#x5426;&#x5728;&#x5171;&#x4EAB;&#x7F13;&#x51B2;&#x533A;&#x4E2D;&#x3002;</p>
</blockquote>
<h3 id="322-&#x7D22;&#x5F15;&#x626B;&#x63CF;">3.2.2. &#x7D22;&#x5F15;&#x626B;&#x63CF;</h3>
<p>&#x5C3D;&#x7BA1;PostgreSQL&#x652F;&#x6301;&#x8BB8;&#x591A;<a href="https://www.postgresql.org/docs/current/static/indexes-types.html" target="_blank">&#x7D22;&#x5F15;&#x65B9;&#x6CD5;</a>&#xFF0C;&#x5982;BTree&#xFF0C;<a href="https://www.postgresql.org/docs/current/static/gist.html" target="_blank">GiST</a>&#xFF0C;<a href="https://www.postgresql.org/docs/current/static/gin.html" target="_blank">GIN</a>&#x548C;<a href="https://www.postgresql.org/docs/current/static/brin.html" target="_blank">BRIN</a>&#xFF0C;&#x4F46;&#x7D22;&#x5F15;&#x626B;&#x63CF;&#x7684;&#x6210;&#x672C;&#x4F7F;&#x7528;&#x901A;&#x7528;&#x7684;&#x6210;&#x672C;&#x51FD;&#x6570;cost_index()&#x4F30;&#x7B97;&#x3002;</p>
<p>&#x5728;&#x672C;&#x5C0F;&#x8282;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x63A2;&#x8BA8;&#x5982;&#x4F55;&#x4F30;&#x8BA1;&#x4EE5;&#x4E0B;&#x67E5;&#x8BE2;&#x7684;&#x7D22;&#x5F15;&#x626B;&#x63CF;&#x6210;&#x672C;&#xFF1A;</p>
<pre><code class="lang-sql">testdb=# <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">id</span>, <span class="hljs-keyword">data</span> <span class="hljs-keyword">FROM</span> tbl <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">data</span> &lt; <span class="hljs-number">240</span>;
</code></pre>
<p>&#x5728;&#x4F30;&#x7B97;&#x6210;&#x672C;&#x4E4B;&#x524D;&#xFF0C;&#x7D22;&#x5F15;&#x9875;&#x548C;&#x7D22;&#x5F15;&#x5143;&#x7EC4;&#x7684;&#x6570;&#x91CF;, $N<em>{index,tuple}$ and $N</em>{index,page}$ &#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF1A;</p>
<pre><code class="lang-sql">testdb=# <span class="hljs-keyword">SELECT</span> relpages, reltuples <span class="hljs-keyword">FROM</span> pg_class <span class="hljs-keyword">WHERE</span> relname = <span class="hljs-string">&apos;tbl_data_idx&apos;</span>;
 relpages | reltuples 
<span class="hljs-comment">----------+-----------</span>
       30 |     10000
(1 row)
</code></pre>
<p>&#x200B;    (3) $N<em>{index,tuple}$=10000,
    (4) $N</em>{index,page}$=30.</p>
<h4 id="3221-&#x542F;&#x52A8;&#x6210;&#x672C;start-up-cost">3.2.2.1. &#x542F;&#x52A8;&#x6210;&#x672C;(Start-Up Cost)</h4>
<p>&#x7D22;&#x5F15;&#x626B;&#x63CF;&#x7684;&#x542F;&#x52A8;&#x6210;&#x672C;&#x662F;&#x8BFB;&#x53D6;&#x7D22;&#x5F15;&#x9875;&#x4EE5;&#x8BBF;&#x95EE;&#x76EE;&#x6807;&#x8868;&#x4E2D;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7EC4;&#x7684;&#x5F00;&#x9500;&#xFF0C;&#x5B83;&#x7531;&#x4EE5;&#x4E0B;&#x516C;&#x5F0F;&#x5B9A;&#x4E49;&#xFF1A;</p>
<p>&#x200B;    &#x2018;start-up cost&#x2019; = {ceil($log_{2}$($Nindex,tuple$)) + ($Hindex$ + 1) &#xD7; 50} &#xD7; cpu_operator_cost,</p>
<p>$H_{index}$&#x662F;&#x7D22;&#x5F15;&#x6811;&#x7684;&#x9AD8;&#x5EA6;&#x3002;</p>
<p>&#x5728;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x6839;&#x636E;(3)&#xFF0C;$N<em>{index,tuple}$&#x4E3A;10000; $H</em>{index}$&#x662F;1; cpu_operator_cost&#x4E3A;0.0025(&#x9ED8;&#x8BA4;)&#x3002; &#x4ECE;&#x800C;&#xFF0C;</p>
<p>&#x200B;    (5) &#x2018;start-up cost&#x2019; = {ceil($log_{2}($10000)) + (1 + 1) &#xD7; 50} &#xD7; 0.0025 = 0.285</p>
<h4 id="3222-&#x8FD0;&#x884C;&#x6210;&#x672C;run-cost">3.2.2.2. &#x8FD0;&#x884C;&#x6210;&#x672C;(Run Cost)</h4>
<p>&#x7D22;&#x5F15;&#x626B;&#x63CF;&#x7684;&#x8FD0;&#x884C;&#x6210;&#x672C;&#x662F;&#x8868;&#x548C;&#x7D22;&#x5F15;&#x7684;CPU&#x6210;&#x672C;&#x548C;IO(&#x8F93;&#x5165;/&#x8F93;&#x51FA;)&#x6210;&#x672C;&#x7684;&#x603B;&#x548C;&#xFF1A;</p>
<p>&#x200B;    &#x2018;run cost&#x2019; = (&#x2018;index cpu cost&#x2019; + &#x2018;table cpu cost&#x2019;) + (&#x2018;index IO cost&#x2019; + &#x2018;table IO cost&#x2019;).</p>
<blockquote>
<p>:pushpin: &#x5982;&#x679C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; <a href="https://www.postgresql.org/docs/10/static/indexes-index-only-scans.html" target="_blank">Index-Only Scans</a>(&#x7B2C;7&#x7AE0;&#x4E2D;&#x63CF;&#x8FF0;)&#xFF0C;&#x5219;&#x4E0D;&#x4F30;&#x8BA1;&apos;&#x2018;table cpu cost&#x2019;&#x548C;&apos;table IO cost&#x2019;&#x3002;</p>
</blockquote>
<p>&#x524D;&#x4E09;&#x9879;&#x6210;&#x672C;(i.e. index cpu cost, table cpu cost and index IO cost) &#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF1A;</p>
<p>&#x200B;    &#x2018;index cpu cost&#x2019; = Selectivity &#xD7; $N_{index,tuple}$ &#xD7; (cpu_index_tuple_cost + qual_op_cost),</p>
<p>&#x200B;    &#x2018;table cpu cost&#x2019; = Selectivity &#xD7; $N_{tuple}$ &#xD7; cpu_tuple_cost,</p>
<p>&#x200B;    &#x2018;index IO cost&#x2019; = ceil(Selectivity &#xD7; $N_{index,page}$) &#xD7; random_page_cost,</p>
<p>&#x5176;&#x4E2D;<a href="https://www.postgresql.org/docs/current/static/runtime-config-query.html#GUC-CPU-INDEX-TUPLE-COST" target="_blank">cpu_index_tuple_cost</a>&#x548C;<a href="https://www.postgresql.org/docs/current/static/runtime-config-query.html#GUC-RANDOM-PAGE-COST" target="_blank">random_page_cost</a>&#x5728;postgresql.conf&#x6587;&#x4EF6;&#x4E2D;&#x8BBE;&#x7F6E;(&#x9ED8;&#x8BA4;&#x503C;&#x5206;&#x522B;&#x4E3A;0.005&#x548C;4.0); &#x5927;&#x81F4;&#x6765;&#x8BF4;&#xFF0C;qual<em>op_cost&#x662F;&#x7D22;&#x5F15;&#x7684;&#x8BC4;&#x4F30;&#x6210;&#x672C;&#xFF0C;&#x8FD9;&#x91CC;&#x6CA1;&#x6709;&#x7ED9;&#x51FA;&#x592A;&#x591A;&#x89E3;&#x91CA;&#xFF1A;qual_op_cost=0.0025&#x3002;Selectivity&#x662F;&#x6307;&#x5B9A;WHERE&#x5B50;&#x53E5;&#x7684;&#x7D22;&#x5F15;&#x641C;&#x7D22;&#x8303;&#x56F4;&#x7684;&#x6BD4;&#x4F8B;; &#x5B83;&#x662F;&#x4ECE;0&#x5230;1&#x7684;&#x6D6E;&#x70B9;&#x6570;&#xFF0C;&#x4E0B;&#x9762;&#x8BE6;&#x7EC6;&#x4ECB;&#x7ECD;&#x3002; &#x4F8B;&#x5982;&#xFF0C;(Selectivity&#xD7;$N</em>{tuple}$)&#x8868;&#x793A;&#x8981;&#x8BFB;&#x53D6;&#x7684;&#x8868;&#x5143;&#x7EC4;&#x7684;&#x6570;&#x91CF;&#xFF0C;(Selectivity&#xD7;$N_{index,page}$)&#x8868;&#x793A;&#x8981;&#x8BFB;&#x53D6;&#x7684;&#x7D22;&#x5F15;&#x9875;&#x7684;&#x6570;&#x91CF;&#x7B49;&#x7B49;&#x3002;</p>
<blockquote>
<p>:pushpin: <em>Selectivity</em></p>
<p>&#x67E5;&#x8BE2;&#x8C13;&#x8BCD;&#x7684;selectivity&#x662F;&#x4F7F;&#x7528;histogram_bounds&#x6216;MCV(Most Common Value)&#x4F30;&#x8BA1;&#x7684;&#xFF0C;&#x5B83;&#x4EEC;&#x90FD;&#x5B58;&#x50A8;&#x5728;&#x7EDF;&#x8BA1;&#x4FE1;&#x606F;<a href="https://www.postgresql.org/docs/current/static/view-pg-stats.html" target="_blank">pg_stats</a>&#x4E2D;&#x3002; &#x8FD9;&#x91CC;&#xFF0C;&#x4F7F;&#x7528;&#x5177;&#x4F53;&#x5B9E;&#x4F8B;&#x7B80;&#x8981;&#x63CF;&#x8FF0;selectivity&#x7684;&#x8BA1;&#x7B97;&#x3002; &#x66F4;&#x591A;&#x7EC6;&#x8282;&#x89C1;<a href="https://www.postgresql.org/docs/10/static/row-estimation-examples.html" target="_blank">&#x5B98;&#x65B9;&#x6587;&#x6863;</a>&#x3002; </p>
<p>&#x8868;&#x4E2D;&#x6BCF;&#x5217;&#x7684;MCV&#x4F5C;&#x4E3A;&#x4E00;&#x5BF9;most_common_vals&#x548C;most_common_freqs&#x5217;&#x5B58;&#x50A8;&#x5728;<a href="https://www.postgresql.org/docs/10/static/view-pg-stats.html" target="_blank">pg_stats</a>&#x89C6;&#x56FE;&#x4E2D;&#x3002;</p>
<ul>
<li>most_common_vals&#x662F;&#x8BE5;&#x5217;&#x7684;MCV&#x5217;&#x8868;&#x3002;</li>
<li>most_common_freqs&#x662F;MCV&#x9891;&#x7387;&#x7684;&#x5217;&#x8868;&#x3002;</li>
</ul>
<p>&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x4F8B;&#x5B50;&#x5982;&#x4E0B;&#x6240;&#x793A;&#x3002;<a href="javascript:void(0" target="_blank">&quot;countries&quot;</a>) &#x8868;&#x6709;&#x4E24;&#x5217;&#xFF1A;&#x5B58;&#x50A8;&#x56FD;&#x5BB6;&#x540D;&#x79F0;&#x7684;&#x5217;&#x2018;country&#x2019;&#x548C;&#x5B58;&#x50A8;&#x56FD;&#x5BB6;&#x6240;&#x5C5E;&#x7684;&#x5927;&#x9646;&#x540D;&#x79F0;&#x7684;&#x5217;&#x2018;continent&#x2019;&#x3002;</p>
<pre><code class="lang-sql">testdb=# \d countries
 Table &quot;public.countries&quot;
Column   | Type | Modifiers 
<span class="hljs-comment">-----------+------+-----------</span>
country   | text | 
continent | text | 
Indexes:
  &quot;continent_idx&quot; btree (continent)
  testdb=# <span class="hljs-keyword">SELECT</span> continent, <span class="hljs-keyword">count</span>(*) <span class="hljs-keyword">AS</span> <span class="hljs-string">&quot;number of countries&quot;</span>, 
testdb-#     (<span class="hljs-keyword">count</span>(*)/(<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(*) <span class="hljs-keyword">FROM</span> countries)::<span class="hljs-built_in">real</span>) <span class="hljs-keyword">AS</span> <span class="hljs-string">&quot;number of countries / all countries&quot;</span>
testdb-#       <span class="hljs-keyword">FROM</span> countries <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> continent <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-string">&quot;number of countries&quot;</span> <span class="hljs-keyword">DESC</span>;
  continent   | number of countries | number of countries / all countries 
<span class="hljs-comment">---------------+---------------------+-------------------------------------</span>
Africa        |                  53 |                   0.274611398963731
Europe        |                  47 |                   0.243523316062176
Asia          |                  44 |                   0.227979274611399
North America |                  23 |                   0.119170984455959
Oceania       |                  14 |                  0.0725388601036269
South America |                  12 |                  0.0621761658031088
(6 rows)
</code></pre>
<p>&#x8BA9;&#x6211;&#x4EEC;&#x8003;&#x8651;&#x4E00;&#x4E0B;WHERE&#x5B50;&#x53E5;&apos;continent =&apos;Asia&apos;&apos;&#x7684;&#x67E5;&#x8BE2;&#xFF1A;</p>
<pre><code class="lang-sql">testdb=# <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> countries <span class="hljs-keyword">WHERE</span> continent = <span class="hljs-string">&apos;Asia&apos;</span>;
</code></pre>
<p>&#x5728;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x4F18;&#x5316;&#x5668;&#x4F7F;&#x7528;&#x2018;continent&#x2019;&#x5217;&#x7684;MCV&#x4F30;&#x7B97;&#x7D22;&#x5F15;&#x626B;&#x63CF;&#x6210;&#x672C;&#x3002; &#x4E0B;&#x9762;&#x663E;&#x793A;&#x4E86;&#x6B64;&#x5217;&#x7684;most_common_vals&#x548C;most_common_freqs&#xFF1A;</p>
<pre><code class="lang-sql">testdb=# \x
Expanded display is on.
testdb=# SELECT most_common_vals, most_common_freqs FROM pg_stats 
testdb-#                  WHERE tablename = &apos;countries&apos; AND attname=&apos;continent&apos;;
-[ RECORD 1 ]-----+-------------------------------------------------------------
most_common_vals  | {Africa,Europe,Asia,&quot;North America&quot;,Oceania,&quot;South America&quot;}
most_common_freqs | {0.274611,0.243523,0.227979,0.119171,0.0725389,0.0621762}
</code></pre>
<p>most_common_vals&#x7684;&apos;Asia&apos;&#x5BF9;&#x5E94;&#x7684;most_common_freqs&#x7684;&#x503C;&#x4E3A;0.227979&#x3002; &#x56E0;&#x6B64;&#xFF0C;&#x5728;&#x6B64;&#x4F30;&#x8BA1;&#x4E2D;&#x4F7F;&#x7528;0.227979&#x4F5C;&#x4E3A;selectivity&#x3002;</p>
<p>&#x5982;&#x679C;&#x4E0D;&#x80FD;&#x4F7F;&#x7528;MCV&#xFF0C;&#x5219;&#x4F7F;&#x7528;&#x76EE;&#x6807;&#x5217;&#x7684;histogram_bounds&#x7684;&#x503C;&#x6765;&#x4F30;&#x8BA1;&#x6210;&#x672C;&#x3002;</p>
<ul>
<li><strong>histogram_bounds</strong> &#x662F;&#x5C06;&#x5217;&#x503C;&#x5206;&#x6210;&#x6570;&#x91CF;&#x5927;&#x81F4;&#x76F8;&#x7B49;&#x7684;&#x503C;&#x7684;&#x5217;&#x8868;&#x3002;</li>
</ul>
<p>&#x4E00;&#x4E2A;&#x5177;&#x4F53;&#x7684;&#x4F8B;&#x5B50;&#x3002; &#x8FD9;&#x662F;&#x8868;&apos;tbl&apos;&#x4E2D;&#x5217;&apos;data&apos;&#x7684;histogram_bounds&#x7684;&#x503C;&#xFF1A;</p>
<pre><code class="lang-sql">testdb=# SELECT histogram_bounds FROM pg_stats WHERE tablename = &apos;tbl&apos; AND attname = &apos;data&apos;;
                                  histogram_bounds
---------------------------------------------------------------------------------------------------
{1,100,200,300,400,500,600,700,800,900,1000,1100,1200,1300,1400,1500,1600,1700,1800,1900,2000,2100,
2200,2300,2400,2500,2600,2700,2800,2900,3000,3100,3200,3300,3400,3500,3600,3700,3800,3900,4000,4100,
4200,4300,4400,4500,4600,4700,4800,4900,5000,5100,5200,5300,5400,5500,5600,5700,5800,5900,6000,6100,
6200,6300,6400,6500,6600,6700,6800,6900,7000,7100,7200,7300,7400,7500,7600,7700,7800,7900,8000,8100,
8200,8300,8400,8500,8600,8700,8800,8900,9000,9100,9200,9300,9400,9500,9600,9700,9800,9900,10000}
(1 row)
</code></pre>
<p>&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;histogram_bounds&#x88AB;&#x5206;&#x6210;100&#x4E2A;&#x6876;&#x3002; &#x56FE;3.7&#x5C55;&#x793A;&#x4E86;&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x4E2D;&#x7684;&#x6876;&#x548C;&#x76F8;&#x5E94;&#x7684;histogram_bounds&#x3002; &#x5B58;&#x50A8;&#x6876;&#x4ECE;0&#x5F00;&#x59CB;&#x7F16;&#x53F7;&#xFF0C;&#x6BCF;&#x4E2A;&#x5B58;&#x50A8;&#x6876;(&#x5927;&#x7EA6;)&#x5B58;&#x50A8;&#x76F8;&#x540C;&#x6570;&#x91CF;&#x7684;&#x5143;&#x7EC4;&#x3002; histogram_bounds&#x7684;&#x503C;&#x662F;&#x76F8;&#x5E94;&#x6876;&#x7684;&#x8FB9;&#x754C;&#x3002; &#x4F8B;&#x5982;&#xFF0C;histogram_bounds&#x7684;&#x7B2C;0&#x4E2A;&#x503C;&#x662F;1&#xFF0C;&#x8FD9;&#x610F;&#x5473;&#x7740;&#x5B83;&#x662F;&#x5B58;&#x50A8;&#x5728;bucket_0&#x4E2D;&#x7684;&#x5143;&#x7EC4;&#x7684;&#x6700;&#x5C0F;&#x503C;; &#x7B2C;&#x4E00;&#x4E2A;&#x503C;&#x662F;100&#xFF0C;&#x8FD9;&#x662F;&#x5B58;&#x50A8;&#x5728;bucket_1&#x4E2D;&#x7684;&#x5143;&#x7EC4;&#x7684;&#x6700;&#x5C0F;&#x503C;&#xFF0C;&#x4F9D;&#x6B64;&#x7C7B;&#x63A8;&#x3002;</p>
<p><strong>&#x56FE;. 3.7. Buckets and histogram_bounds.</strong></p>
<p><img src="https://github.com/yonj1e/The-Internals-of-PostgreSQL/blob/master/imgs/ch3/fig-3-07.png?raw=true" alt="Fig. 3.7. Buckets and histogram_bounds."></p>
<p>&#x63A5;&#x4E0B;&#x6765;&#xFF0C;&#x5C06;&#x4F7F;&#x7528;&#x672C;&#x5C0F;&#x8282;&#x4E2D;&#x7684;&#x793A;&#x4F8B;&#x8BA1;&#x7B97;selectivity&#x3002; &#x67E5;&#x8BE2;&#x6709;&#x4E00;&#x4E2A;WHERE&#x5B50;&#x53E5;&apos;data &lt;240&apos;&#xFF0C;&#x503C;&apos;240&apos;&#x5728;&#x7B2C;&#x4E8C;&#x4E2A;&#x6876;&#x4E2D;&#x3002; &#x5728;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;selectivity&#x53EF;&#x4EE5;&#x901A;&#x8FC7;linear interpolation&#x5F97;&#x51FA;; &#x56E0;&#x6B64;&#xFF0C;&#x4F7F;&#x7528;&#x4EE5;&#x4E0B;&#x7B49;&#x5F0F;&#x6765;&#x8BA1;&#x7B97;&#x8BE5;&#x67E5;&#x8BE2;&#x4E2D;&#x5217;&apos;&#x6570;&#x636E;&apos;&#x7684;selectivity&#xFF1A;</p>
<p>&#x200B;    (6) Selectivity = $\frac{2+(240&#x2212;hb[2])/(hb[3]&#x2212;hb[2])}{100}$ = $\frac{2+(240&#x2212;200)/(300&#x2212;200)}{100}$ = $\frac{2+40/100}{100}$ = 0.024.</p>
</blockquote>
<p> &#x56E0;&#x6B64;&#xFF0C;&#x6839;&#x636E; (1),(3),(4) and (6),</p>
<p>&#x200B;    (7) &#x2018;index cpu cost&#x2019; = 0.024 &#xD7; 10000 &#xD7; (0.005 + 0.0025) = 1.8,</p>
<p>&#x200B;    (8) &#x2018;table cpu cost&#x2019; = 0.024 &#xD7; 10000 &#xD7; 0.01 = 2.4,</p>
<p>&#x200B;    (9) &#x2018;index IO cost&#x2019; = ceil(0.024 &#xD7; 30) &#xD7; 4.0 = 4.0.</p>
<p>&#x2018;table IO cost&#x2019; &#x7531;&#x4EE5;&#x4E0B;&#x7B49;&#x5F0F;&#x5B9A;&#x4E49;&#xFF1A;</p>
<p>&#x200B;    &#x2018;table IO cost&#x2019; = max_IO_cost + $indexCorrelation^{2}$ &#xD7; (min_IO_cost &#x2212; max_IO_cost).</p>
<p>max_IO_cost&#x662F;IO&#x6210;&#x672C;&#x6700;&#x5DEE;&#x7684;&#x60C5;&#x51B5;&#xFF0C;&#x5373;&#x968F;&#x673A;&#x626B;&#x63CF;&#x6240;&#x6709;&#x8868;&#x9875;&#x7684;&#x6210;&#x672C;; &#x8BE5;&#x6210;&#x672C;&#x7531;&#x4EE5;&#x4E0B;&#x7B49;&#x5F0F;&#x5B9A;&#x4E49;&#xFF1A;</p>
<p>&#x200B;    max<em>IO_cost = $N</em>{page}$ &#xD7; random_page_cost.</p>
<p>&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x6839;&#x636E; (2), $N_{page}$=45, &#x56E0;&#x6B64;</p>
<p>&#x200B;    (10) max_IO_cost = 45 &#xD7; 4.0 = 180.0.</p>
<p>min_IO_cost&#x662F;IO&#x6210;&#x672C;&#x7684;&#x6700;&#x4F73;&#x60C5;&#x51B5;&#xFF0C;&#x5373;&#x987A;&#x5E8F;&#x626B;&#x63CF;&#x6240;&#x9009;&#x8868;&#x9875;&#x7684;&#x6210;&#x672C;; &#x8BE5;&#x6210;&#x672C;&#x7531;&#x4EE5;&#x4E0B;&#x7B49;&#x5F0F;&#x5B9A;&#x4E49;&#xFF1A;</p>
<p>&#x200B;    min<em>IO_cost = 1 &#xD7; random_page_cost + (ceil(Selectivity &#xD7; $N</em>{page}$) &#x2212; 1) &#xD7; seq_page_cost.</p>
<p>&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;</p>
<p>&#x200B;    (11) min_IO_cost = 1 &#xD7; 4.0 + (ceil(0.024 &#xD7; 45)) &#x2212; 1) &#xD7; 1.0 = 5.0.</p>
<p>indexCorrelation&#x5728;&#x4E0B;&#x9762;&#x8BE6;&#x7EC6;&#x63CF;&#x8FF0;&#xFF0C;&#x5728;&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x4E2D;&#xFF0C;</p>
<p>&#x200B;    (12) indexCorrelation = 1.0.</p>
<p>&#x56E0;&#x6B64;&#xFF0C;&#x6839;&#x636E;(10),(11) &#x548C; (12),</p>
<p>&#x200B;    (13) &#x2018;table IO cost&#x2019; = 180.0 + $1.0^{2}$ &#xD7; (5.0 &#x2212; 180.0) = 5.0.</p>
<p>&#x6700;&#x540E;&#xFF0C;&#x6839;&#x636E; (7),(8),(9) &#x548C; (13),</p>
<p>&#x200B;    (14) &#x2018;run cost&#x2019; = (1.8 + 2.4) + (4.0 + 5.0) = 13.2.</p>
<blockquote>
<p>:pushpin: &#x7D22;&#x5F15;&#x76F8;&#x5173;&#x6027;(Index Correlation)&#x662F;&#x5217;&#x503C;&#x7684;&#x7269;&#x7406;&#x884C;&#x6392;&#x5E8F;&#x4E0E;&#x903B;&#x8F91;&#x6392;&#x5E8F;&#x4E4B;&#x95F4;&#x7684;&#x7EDF;&#x8BA1;&#x76F8;&#x5173;&#x6027;(&#x5F15;&#x81EA;&#x5B98;&#x65B9;&#x6587;&#x6863;)&#x3002; &#x8FD9;&#x8303;&#x56F4;&#x4ECE;$-1$&#x5230; $+1$&#x3002; &#x4E3A;&#x4E86;&#x7406;&#x89E3;&#x7D22;&#x5F15;&#x626B;&#x63CF;&#x548C;&#x7D22;&#x5F15;&#x76F8;&#x5173;&#x6027;&#x4E4B;&#x95F4;&#x7684;&#x5173;&#x7CFB;&#xFF0C;&#x4E0B;&#x9762;&#x7ED9;&#x51FA;&#x4E00;&#x4E2A;&#x5177;&#x4F53;&#x793A;&#x4F8B;&#x3002;</p>
<p>&#x8868;tbl_corr&#x6709;&#x4E94;&#x5217;&#xFF1A;&#x4E24;&#x5217;&#x662F;&#x6587;&#x672C;&#x7C7B;&#x578B;&#xFF0C;&#x4E09;&#x5217;&#x662F;&#x6574;&#x6570;&#x7C7B;&#x578B;&#x3002; &#x4E09;&#x4E2A;&#x6574;&#x6570;&#x5217;&#x5B58;&#x50A8;&#x4ECE;1&#x5230;12&#x7684;&#x6570;&#x5B57;&#x3002;&#x7269;&#x7406;&#x4E0A;&#xFF0C;tbl_corr&#x7531;&#x4E09;&#x4E2A;page&#x9875;&#x7EC4;&#x6210;&#xFF0C;&#x6BCF;&#x4E2A;&#x9875;&#x6709;&#x56DB;&#x4E2A;&#x5143;&#x7EC4;&#x3002; &#x6BCF;&#x4E2A;&#x6574;&#x6570;&#x7C7B;&#x578B;&#x5217;&#x90FD;&#x6709;&#x4E00;&#x4E2A;&#x540D;&#x79F0;&#x4E3A;index_col_asc&#x7684;&#x7D22;&#x5F15;&#xFF0C;&#x4F9D;&#x6B64;&#x7C7B;&#x63A8;&#x3002;</p>
<pre><code class="lang-sql">testdb=# \d tbl_corr
   Table &quot;public.tbl_corr&quot;
 Column  |  Type   | Modifiers 
<span class="hljs-comment">----------+---------+-----------</span>
col      | text    | 
col_asc  | integer | 
col_desc | integer | 
col_rand | integer | 
data     | text    |
Indexes:
   &quot;tbl_corr_asc_idx&quot; btree (col_asc)
   &quot;tbl_corr_desc_idx&quot; btree (col_desc)
   &quot;tbl_corr_rand_idx&quot; btree (col_rand)
</code></pre>
<pre><code class="lang-sql">testdb=# <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">col</span>,col_asc,col_desc,col_rand 
testdb-#                         <span class="hljs-keyword">FROM</span> tbl_corr;
  col    | col_asc | col_desc | col_rand 
<span class="hljs-comment">----------+---------+----------+----------</span>
Tuple_1  |       1 |       12 |        3
Tuple_2  |       2 |       11 |        8
Tuple_3  |       3 |       10 |        5
Tuple_4  |       4 |        9 |        9
Tuple_5  |       5 |        8 |        7
Tuple_6  |       6 |        7 |        2
Tuple_7  |       7 |        6 |       10
Tuple_8  |       8 |        5 |       11
Tuple_9  |       9 |        4 |        4
Tuple_10 |      10 |        3 |        1
Tuple_11 |      11 |        2 |       12
Tuple_12 |      12 |        1 |        6
(12 rows)
</code></pre>
<p>&#x8FD9;&#x4E9B;&#x5217;&#x7684;&#x7D22;&#x5F15;&#x76F8;&#x5173;&#x6027;&#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF1A;</p>
<pre><code class="lang-sql">testdb=# <span class="hljs-keyword">SELECT</span> tablename,attname, correlation <span class="hljs-keyword">FROM</span> pg_stats <span class="hljs-keyword">WHERE</span> &gt;tablename = <span class="hljs-string">&apos;tbl_corr&apos;</span>;
tablename | attname  | correlation 
<span class="hljs-comment">-----------+----------+-------------</span>
tbl_corr  | col_asc  |           1
tbl_corr  | col_desc |          -1
tbl_corr  | col_rand |    0.125874
(3 rows)
</code></pre>
<p>&#x5F53;&#x6267;&#x884C;&#x4EE5;&#x4E0B;&#x67E5;&#x8BE2;&#x65F6;&#xFF0C;PostgreSQL&#x53EA;&#x8BFB;&#x53D6;&#x7B2C;&#x4E00;&#x9875;&#xFF0C;&#x56E0;&#x4E3A;&#x6240;&#x6709;&#x76EE;&#x6807;&#x5143;&#x7EC4;&#x90FD;&#x5B58;&#x50A8;&#x5728;&#x7B2C;&#x4E00;&#x9875;&#x4E2D;&#x3002; &#x53C2;&#x8003;&#x56FE;3.8(a)&#x3002;</p>
<pre><code class="lang-sql">testdb=# <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> tbl_corr <span class="hljs-keyword">WHERE</span> col_asc <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">2</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">4</span>;
</code></pre>
<p>&#x53E6;&#x4E00;&#x65B9;&#x9762;&#xFF0C;&#x5F53;&#x6267;&#x884C;&#x4EE5;&#x4E0B;&#x67E5;&#x8BE2;&#x65F6;&#xFF0C;PostgreSQL&#x5FC5;&#x987B;&#x8BFB;&#x53D6;&#x6240;&#x6709;&#x9875;&#x3002; &#x53C2;&#x8003;&#x56FE;3.8(b).</p>
<pre><code class="lang-sql">testdb=# <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> tbl_corr <span class="hljs-keyword">WHERE</span> col_rand <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">2</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">4</span>;
</code></pre>
<p>&#x8FD9;&#x6837;&#xFF0C;&#x7D22;&#x5F15;&#x76F8;&#x5173;&#x6027;&#x662F;&#x4E00;&#x79CD;&#x7EDF;&#x8BA1;&#x76F8;&#x5173;&#x6027;&#xFF0C;&#x5B83;&#x53CD;&#x6620;&#x4E86;&#x5728;&#x4F30;&#x8BA1;&#x7D22;&#x5F15;&#x626B;&#x63CF;&#x6210;&#x672C;&#x65F6;&#x8868;&#x4E2D;&#x7D22;&#x5F15;&#x6392;&#x5E8F;&#x548C;&#x8868;&#x4E2D;&#x7269;&#x7406;&#x5143;&#x7EC4;&#x6392;&#x5E8F;&#x4E4B;&#x95F4;&#x7684;&#x626D;&#x66F2;&#x6240;&#x5F15;&#x8D77;&#x7684;&#x968F;&#x673A;&#x8BBF;&#x95EE;&#x7684;&#x5F71;&#x54CD;&#x3002;</p>
<p><strong>&#x56FE;. 3.8. &#x7D22;&#x5F15;&#x76F8;&#x5173;&#x6027;</strong></p>
<p><img src="https://github.com/yonj1e/The-Internals-of-PostgreSQL/blob/master/imgs/ch3/fig-3-08.png?raw=true" alt="Fig. 3.8. Index correlation."></p>
</blockquote>
<h4 id="3223-&#x603B;&#x6210;&#x672C;total-cost">3.2.2.3. &#x603B;&#x6210;&#x672C;(Total Cost)</h4>
<p>&#x6839;&#x636E; (3) &#x548C; (14),</p>
<p>&#x200B;    (15) &#x2018;total cost&#x2019; = 0.285 + 13.2 = 13.485.</p>
<p>&#x4E3A;&#x4E86;&#x786E;&#x8BA4;&#xFF0C;&#x4E0A;&#x9762;SELECT&#x67E5;&#x8BE2;&#x7684;EXPLAIN&#x547D;&#x4EE4;&#x7684;&#x7ED3;&#x679C;&#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF1A; </p>
<pre><code class="lang-sql">testdb=# EXPLAIN SELECT id, data FROM tbl WHERE data &lt; 240;
                            QUERY PLAN                                     
---------------------------------------------------------------------------
Index Scan using tbl_data_idx on tbl  (cost=0.29..13.49 rows=240 width=8)   
    Index Cond: (data &lt; 240)
(2 rows)
</code></pre>
<p>&#x5728;&#x7B2C;4&#x884C;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#x542F;&#x52A8;&#x6210;&#x672C;&#x548C;&#x603B;&#x6210;&#x672C;&#x5206;&#x522B;&#x4E3A;0.29&#x548C;13.49&#xFF0C;&#x5E76;&#x4E14;&#x4F30;&#x8BA1;&#x5C06;&#x4F1A;&#x626B;&#x63CF;240&#x884C;&#x3002;</p>
<p>&#x5728;&#x7B2C;5&#x884C;&#x4E2D;&#xFF0C;&#x663E;&#x793A;&#x4E86;&#x7D22;&#x5F15;&#x626B;&#x63CF;&#x7684;&#x7D22;&#x5F15;&#x6761;&#x4EF6;&#x2018;Index Cond:(data &lt; 240)&#x2019;&#x3002; &#x66F4;&#x786E;&#x5207;&#x5730;&#x8BF4;&#xFF0C;&#x8FD9;&#x4E2A;&#x6761;&#x4EF6;&#x88AB;&#x79F0;&#x4E3A;<em>&#x8BBF;&#x95EE;&#x8C13;&#x8BCD;access predicate</em>&#xFF0C;&#x5B83;&#x8868;&#x8FBE;&#x4E86;&#x7D22;&#x5F15;&#x626B;&#x63CF;&#x7684;&#x5F00;&#x59CB;&#x548C;&#x7ED3;&#x675F;&#x6761;&#x4EF6;&#x3002;</p>
<blockquote>
<p>:exclamation: &#x6839;&#x636E;&#x8FD9;&#x7BC7;<a href="http://use-the-index-luke.com/sql/explain-plan/postgresql/filter-predicates" target="_blank">&#x6587;&#x7AE0;</a>&#xFF0C;PostgreSQL&#x4E2D;&#x7684;EXPLAIN&#x547D;&#x4EE4;&#x4E0D;&#x533A;&#x5206;&#x8BBF;&#x95EE;&#x8C13;&#x8BCD;&#x548C;&#x7D22;&#x5F15;&#x8FC7;&#x6EE4;&#x5668;&#x8C13;&#x8BCD;&#x3002; &#x56E0;&#x6B64;&#xFF0C;&#x5982;&#x679C;&#x60A8;&#x5206;&#x6790;EXPLAIN&#x7684;&#x8F93;&#x51FA;&#xFF0C;&#x4E0D;&#x4EC5;&#x8981;&#x6CE8;&#x610F;&#x7D22;&#x5F15;&#x6761;&#x4EF6;&#xFF0C;&#x8FD8;&#x8981;&#x6CE8;&#x610F;&#x884C;&#x7684;&#x4F30;&#x8BA1;&#x503C;&#x3002;</p>
<p>:pushpin: <em>seq_page_cost and random_page_cost</em></p>
<p><a href="https://www.postgresql.org/docs/10/static/runtime-config-query.html#GUC-SEQ-PAGE-COST" target="_blank">seq_page_cost</a>&#x548C;<a href="https://www.postgresql.org/docs/10/static/runtime-config-query.html#GUC-RANDOM-PAGE-COST" target="_blank">random_page_cost</a> &#x7684;&#x9ED8;&#x8BA4;&#x503C;&#x5206;&#x522B;&#x662F;1.0&#x548C;4.0&#x3002; &#x8FD9;&#x610F;&#x5473;&#x7740;PostgeSQL&#x5047;&#x5B9A;&#x968F;&#x673A;&#x626B;&#x63CF;&#x6BD4;&#x987A;&#x5E8F;&#x626B;&#x63CF;&#x6162;&#x56DB;&#x500D;; &#x5F88;&#x660E;&#x663E;&#xFF0C;PostgreSQL&#x7684;&#x9ED8;&#x8BA4;&#x503C;&#x662F;&#x57FA;&#x4E8E;&#x4F7F;&#x7528;&#x786C;&#x76D8;HDD&#x3002;</p>
</blockquote>
<p>&#x53E6;&#x4E00;&#x65B9;&#x9762;&#xFF0C;&#x8FD1;&#x51E0;&#x5929;&#xFF0C;&#x7531;&#x4E8E;&#x4E3B;&#x8981;&#x4F7F;&#x7528;SSD&#xFF0C;&#x56E0;&#x6B64;random_page_cost&#x7684;&#x9ED8;&#x8BA4;&#x503C;&#x592A;&#x5927;&#x3002; &#x5982;&#x679C;&#x5C3D;&#x7BA1;&#x4F7F;&#x7528;&#x4E86;SSD&#xFF0C;&#x4ECD;&#x7136;&#x4F7F;&#x7528;&#x4E86;&#x9ED8;&#x8BA4;&#x503C;random_page_cost&#xFF0C;&#x4F46;&#x4F18;&#x5316;&#x5668;&#x53EF;&#x80FD;&#x4F1A;&#x9009;&#x62E9;&#x65E0;&#x6548;&#x7684;&#x8BA1;&#x5212;&#x3002; &#x56E0;&#x6B64;&#xFF0C;&#x4F7F;&#x7528;SSD&#x65F6;&#xFF0C;&#x6700;&#x597D;&#x5C06;random_page_cost&#x7684;&#x503C;&#x66F4;&#x6539;&#x4E3A;1.0&#x3002;</p>
<p>&#x6B64;<a href="https://amplitude.engineering/how-a-single-postgresql-config-change-improved-slow-query-performance-by-50x-85593b8991b0" target="_blank">&#x535A;&#x5BA2;</a>&#x5728;&#x4F7F;&#x7528;random_page_cost&#x7684;&#x9ED8;&#x8BA4;&#x503C;&#x65F6;&#x62A5;&#x544A;&#x4E86;&#x6B64;&#x95EE;&#x9898;&#x3002;</p>
<h3 id="323-&#x6392;&#x5E8F;sort">3.2.3. &#x6392;&#x5E8F;(Sort)</h3>
<p>&#x6392;&#x5E8F;&#x8DEF;&#x5F84;&#x7528;&#x4E8E;&#x6392;&#x5E8F;&#x64CD;&#x4F5C;&#xFF0C;&#x5982;ORDER BY&#xFF0C;merge join&#x64CD;&#x4F5C;&#x7684;&#x9884;&#x5904;&#x7406;&#x548C;&#x5176;&#x4ED6;&#x51FD;&#x6570;&#x3002;&#x6392;&#x5E8F;&#x7684;&#x6210;&#x672C;&#x662F;&#x4F7F;&#x7528;cost_sort()&#x51FD;&#x6570;&#x4F30;&#x7B97;&#x7684;&#x3002; </p>
<p>&#x5728;&#x6392;&#x5E8F;&#x64CD;&#x4F5C;&#x4E2D;&#xFF0C;&#x5982;&#x679C;&#x6240;&#x6709;&#x8981;&#x6392;&#x5E8F;&#x7684;&#x5143;&#x7EC4;&#x90FD;&#x53EF;&#x4EE5;&#x5B58;&#x50A8;&#x5728;work_mem&#x4E2D;&#xFF0C;&#x5219;&#x4F7F;&#x7528;quicksort&#x7B97;&#x6CD5;&#x3002; &#x5426;&#x5219;&#xFF0C;&#x5C06;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x4E34;&#x65F6;&#x6587;&#x4EF6;&#x5E76;&#x4F7F;&#x7528;&#x6587;&#x4EF6;merge-sort&#x7B97;&#x6CD5;&#x3002;</p>
<p>&#x6392;&#x5E8F;&#x8DEF;&#x5F84;&#x7684;&#x542F;&#x52A8;&#x6210;&#x672C;&#x662F;&#x6392;&#x5E8F;&#x76EE;&#x6807;&#x5143;&#x7EC4;&#x7684;&#x6210;&#x672C;&#xFF0C;&#x56E0;&#x6B64;&#xFF0C;&#x6210;&#x672C;&#x4E3A;O($N<em>{sort}$&#xD7;$log</em>{2}$&#x2061;($N<em>{sort}$))&#xFF0C;&#x5176;&#x4E2D;$N</em>{sort}$&#x662F;&#x8FDB;&#x884C;&#x6392;&#x5E8F;&#x7684;&#x5143;&#x7EC4;&#x6570;&#x3002; &#x6392;&#x5E8F;&#x8DEF;&#x5F84;&#x7684;&#x8FD0;&#x884C;&#x6210;&#x672C;&#x662F;&#x8BFB;&#x53D6;&#x6392;&#x5E8F;&#x5143;&#x7EC4;&#x7684;&#x6210;&#x672C;&#xFF0C;&#x56E0;&#x6B64;&#xFF0C;&#x6210;&#x672C;&#x4E3A;O($N_{sort}$)&#x3002;</p>
<p>&#x5728;&#x672C;&#x5C0F;&#x8282;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x63A2;&#x8BA8;&#x5982;&#x4F55;&#x4F30;&#x8BA1;&#x4EE5;&#x4E0B;&#x67E5;&#x8BE2;&#x7684;&#x6392;&#x5E8F;&#x6210;&#x672C;&#x3002; &#x5047;&#x8BBE;&#x8FD9;&#x4E2A;&#x67E5;&#x8BE2;&#x5C06;&#x5728;work_mem&#x4E2D;&#x6392;&#x5E8F;&#xFF0C;&#x800C;&#x4E0D;&#x4F7F;&#x7528;&#x4E34;&#x65F6;&#x6587;&#x4EF6;&#x3002;</p>
<pre><code class="lang-sql">testdb=# <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">id</span>, <span class="hljs-keyword">data</span> <span class="hljs-keyword">FROM</span> tbl <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">data</span> &lt; <span class="hljs-number">240</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">id</span>;
</code></pre>
<p>&#x5728;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x542F;&#x52A8;&#x6210;&#x672C;&#x5728;&#x4EE5;&#x4E0B;&#x516C;&#x5F0F;&#x4E2D;&#x5B9A;&#x4E49;&#xFF1A;</p>
<p>&#x200B;    &#x2018;start-up cost&#x2019; = C + comparison<em>cost &#xD7; $N</em>{sort}$ &#xD7; $log<em>{2}$($N</em>{sort}$),</p>
<p>&#x5176;&#x4E2D;$C$&#x662F;&#x6700;&#x540E;&#x4E00;&#x6B21;&#x626B;&#x63CF;&#x7684;&#x603B;&#x6210;&#x672C;&#xFF0C;&#x5373;&#x7D22;&#x5F15;&#x626B;&#x63CF;&#x7684;&#x603B;&#x6210;&#x672C;; &#x6839;&#x636E;(15)&#xFF0C;&#x662F;13.48513.485;$N_{sort}$=240; compare_costcomparison_cost&#x5728;2&#xD7;cpu_operator_cost&#x4E2D;&#x5B9A;&#x4E49;&#x3002; &#x4ECE;&#x800C;&#xFF0C;</p>
<p>&#x200B;    &#x2018;start-up cost&#x2019; = 13.485+(2 &#xD7; 0.0025) &#xD7; 240.0 &#xD7; $log_{2}$(240.0) = 22.973.</p>
<p>&#x8FD0;&#x884C;&#x6210;&#x672C;&#x662F;&#x8BFB;&#x53D6;&#x5185;&#x5B58;&#x4E2D;&#x5DF2;&#x6392;&#x5E8F;&#x7684;&#x5143;&#x7EC4;&#x7684;&#x6210;&#x672C;; &#x4ECE;&#x800C;&#xFF0C;</p>
<p>&#x200B;    &#x2018;run cost&#x2019; = cpu<em>operator_cost &#xD7; $N</em>{sort}$ = 0.0025 &#xD7; 240 = 0.6.</p>
<p>&#x6700;&#x7EC8;,</p>
<p>&#x200B;    &#x2018;total cost&#x2019; = 22.973 + 0.6 = 23.573.</p>
<p>&#x4E3A;&#x4E86;&#x786E;&#x8BA4;&#xFF0C;&#x4E0A;&#x9762;&#x7684;SELECT&#x67E5;&#x8BE2;&#x7684;EXPLAIN&#x547D;&#x4EE4;&#x7684;&#x7ED3;&#x679C;&#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF1A;</p>
<pre><code class="lang-sql">testdb=# EXPLAIN SELECT id, data FROM tbl WHERE data &lt; 240 ORDER BY id;                                                       QUERY PLAN                                    
--------------------------------------------------------------------------------- 
Sort  (cost=22.97..23.57 rows=240 width=8)   
    Sort Key: id   
        -&gt;  Index Scan using tbl_data_idx on tbl  (cost=0.29..13.49 rows=240 width=8)         
            Index Cond: (data &lt; 240)
(4 rows)
</code></pre>
<p>&#x5728;&#x7B2C;4&#x884C;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#x542F;&#x52A8;&#x548C;&#x603B;&#x6210;&#x672C;&#x5206;&#x522B;&#x4E3A;22.97&#x548C;23.57&#x3002;</p>
<h2 id="33-&#x521B;&#x5EFA;&#x5355;&#x8868;&#x67E5;&#x8BE2;&#x7684;&#x8BA1;&#x5212;&#x6811;">3.3. &#x521B;&#x5EFA;&#x5355;&#x8868;&#x67E5;&#x8BE2;&#x7684;&#x8BA1;&#x5212;&#x6811;</h2>
<p>&#x7531;&#x4E8E;&#x7684;&#x5904;&#x7406;&#x975E;&#x5E38;&#x590D;&#x6742;&#xFF0C;&#x56E0;&#x6B64;&#x672C;&#x8282;&#x4ECB;&#x7ECD;&#x4E86;&#x6700;&#x7B80;&#x5355;&#x7684;&#x8FC7;&#x7A0B;&#xFF0C;&#x5373;&#x5982;&#x4F55;&#x521B;&#x5EFA;&#x5355;&#x8868;&#x67E5;&#x8BE2;&#x7684;&#x8BA1;&#x5212;&#x6811;&#x3002; 3.6&#x8282;&#x63CF;&#x8FF0;&#x4E86;&#x66F4;&#x590D;&#x6742;&#x7684;&#x5904;&#x7406;&#x8FC7;&#x7A0B;&#xFF0C;&#x5373;&#x5982;&#x4F55;&#x521B;&#x5EFA;&#x591A;&#x8868;&#x67E5;&#x8BE2;&#x7684;&#x8BA1;&#x5212;&#x6811;&#x3002;</p>
<p>PostgreSQL&#x4E2D;&#x7684;&#x4F18;&#x5316;&#x5668;&#x6267;&#x884C;&#x4E09;&#x4E2A;&#x6B65;&#x9AA4;&#xFF0C;&#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF1A;</p>
<ol>
<li>&#x8FDB;&#x884C;&#x9884;&#x5904;&#x7406;&#x3002;</li>
<li>&#x901A;&#x8FC7;&#x4F30;&#x8BA1;&#x6240;&#x6709;&#x53EF;&#x80FD;&#x7684;&#x8BBF;&#x95EE;&#x8DEF;&#x5F84;&#x7684;&#x6210;&#x672C;&#xFF0C;&#x83B7;&#x5F97;&#x6700;&#x4F18;&#x8BBF;&#x95EE;&#x8DEF;&#x5F84;&#x3002;</li>
<li>&#x4ECE;&#x6700;&#x4F18;&#x8DEF;&#x5F84;&#x521B;&#x5EFA;&#x8BA1;&#x5212;&#x6811;&#x3002;</li>
</ol>
<p>&#x8BBF;&#x95EE;&#x8DEF;&#x5F84;&#x662F;&#x4F30;&#x8BA1;&#x6210;&#x672C;&#x7684;&#x5904;&#x7406;&#x5355;&#x4F4D;; &#x4F8B;&#x5982;&#xFF0C;&#x987A;&#x5E8F;&#x626B;&#x63CF;&#xFF0C;&#x7D22;&#x5F15;&#x626B;&#x63CF;&#xFF0C;&#x6392;&#x5E8F;&#x548C;&#x5404;&#x79CD;&#x8FDE;&#x63A5;&#x64CD;&#x4F5C;&#x90FD;&#x6709;&#x76F8;&#x5E94;&#x7684;&#x8DEF;&#x5F84;&#x3002; &#x8BBF;&#x95EE;&#x8DEF;&#x5F84;&#x4EC5;&#x5728;&#x4F18;&#x5316;&#x5668;&#x5185;&#x90E8;&#x7528;&#x4E8E;&#x521B;&#x5EFA;&#x8BA1;&#x5212;&#x6811;&#x3002; &#x8BBF;&#x95EE;&#x8DEF;&#x5F84;&#x7684;&#x6700;&#x57FA;&#x672C;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x662F;<a href="https://github.com/postgres/postgres/blob/master/src/include/nodes/relation.h" target="_blank">relation.h</a>&#x4E2D;&#x5B9A;&#x4E49;&#x7684; <a href="javascript:void(0" target="_blank">Path</a>) &#x7ED3;&#x6784;&#x4F53;&#xFF0C;&#x5B83;&#x5BF9;&#x5E94;&#x4E8E;&#x987A;&#x5E8F;&#x626B;&#x63CF;&#x3002; &#x6240;&#x6709;&#x5176;&#x4ED6;&#x8BBF;&#x95EE;&#x8DEF;&#x5F84;&#x90FD;&#x57FA;&#x4E8E;&#x8BE5;&#x7ED3;&#x6784;&#x3002; &#x8BE6;&#x7EC6;&#x5185;&#x5BB9;&#x5C06;&#x5728;&#x540E;&#x9762;&#x4ECB;&#x7ECD;&#x3002;</p>
<p>&#x4E3A;&#x4E86;&#x5904;&#x7406;&#x4E0A;&#x8FF0;&#x6B65;&#x9AA4;&#xFF0C;&#x4F18;&#x5316;&#x5668;&#x5728;&#x5185;&#x90E8;&#x521B;&#x5EFA; <a href="javascript:void(0" target="_blank">PlannerInfo</a>) &#x7ED3;&#x6784;&#xFF0C;&#x5E76;&#x4FDD;&#x5B58;&#x67E5;&#x8BE2;&#x6811;&#x3001;&#x5173;&#x4E8E;&#x67E5;&#x8BE2;&#x4E2D;&#x5305;&#x542B;&#x7684;&#x5173;&#x7CFB;&#x7684;&#x4FE1;&#x606F;&#x3001;&#x8BBF;&#x95EE;&#x8DEF;&#x5F84;&#x7B49;&#x3002;</p>
<p>&#x5728;&#x672C;&#x8282;&#x4E2D;&#xFF0C;&#x5C06;&#x4F7F;&#x7528;&#x7279;&#x5B9A;&#x793A;&#x4F8B;&#x63CF;&#x8FF0;&#x5982;&#x4F55;&#x4ECE;&#x67E5;&#x8BE2;&#x6811;&#x521B;&#x5EFA;&#x8BA1;&#x5212;&#x6811;&#x3002;</p>
<h3 id="331-&#x9884;&#x5904;&#x7406;preprocessing">3.3.1. &#x9884;&#x5904;&#x7406;(Preprocessing)</h3>
<p>&#x5728;&#x521B;&#x5EFA;&#x8BA1;&#x5212;&#x6811;&#x4E4B;&#x524D;&#xFF0C;&#x4F18;&#x5316;&#x5668;&#x5BF9;&#x5B58;&#x50A8;&#x5728;PlannerInfo&#x7ED3;&#x6784;&#x4E2D;&#x7684;&#x67E5;&#x8BE2;&#x6811;&#x8FDB;&#x884C;&#x4E00;&#x4E9B;&#x9884;&#x5904;&#x7406;&#x3002;</p>
<p>&#x867D;&#x7136;&#x9884;&#x5904;&#x7406;&#x6D89;&#x53CA;&#x5F88;&#x591A;&#x6B65;&#x9AA4;&#xFF0C;&#x4F46;&#x6211;&#x4EEC;&#x53EA;&#x8BA8;&#x8BBA;&#x672C;&#x5C0F;&#x8282;&#x4E2D;&#x5355;&#x8868;&#x67E5;&#x8BE2;&#x7684;&#x4E3B;&#x8981;&#x9884;&#x5904;&#x7406;&#x3002; &#x5176;&#x4ED6;&#x9884;&#x5904;&#x7406;&#x64CD;&#x4F5C;&#x5728;3.6&#x8282;&#x4E2D;&#x63CF;&#x8FF0;&#x3002;</p>
<ol>
<li><p>&#x7B80;&#x5316;&#x76EE;&#x6807;&#x5217;&#x8868;&#x3001;&#x9650;&#x5236;&#x5B50;&#x53E5;&#x7B49;&#x3002; </p>
<p>&#x4F8B;&#x5982;&#xFF0C;&apos;2 + 2&apos;&#x7531;<a href="https://github.com/postgres/postgres/blob/master/src/backend/optimizer/util/clauses.c" target="_blank">clauses.c</a>&#x4E2D;&#x5B9A;&#x4E49;&#x7684;eval_const_expressions()&#x51FD;&#x6570;&#x91CD;&#x5199;&#x4E3A;&apos;4&apos;&#x3002;</p>
</li>
<li><p>&#x89C4;&#x8303;&#x5E03;&#x5C14;&#x8868;&#x8FBE;&#x5F0F;&#x3002; </p>
<p>&#x4F8B;&#x5982;&#xFF0C; &#x2018;NOT (NOT a)&#x2019; &#x88AB;&#x91CD;&#x5199;&#x4E3A;&apos;a&apos;&#x3002;</p>
</li>
<li><p>&#x5C55;&#x5F00;AND/OR&#x8868;&#x8FBE;&#x5F0F;.</p>
<p>SQL&#x6807;&#x51C6;&#x4E2D;&#x7684;AND&#x548C;OR&#x662F;&#x4E8C;&#x5143;&#x8FD0;&#x7B97;&#x7B26;&#xFF0C;&#x4F46;&#x662F;&#x5728;PostgreSQL&#x5185;&#x90E8;&#xFF0C;&#x5B83;&#x4EEC;&#x662F;n&#x5143;&#x8FD0;&#x7B97;&#x7B26;&#xFF0C;&#x4F18;&#x5316;&#x5668;&#x603B;&#x662F;&#x5047;&#x5B9A;&#x6240;&#x6709;&#x5D4C;&#x5957;&#x7684;AND&#x548C;OR&#x8868;&#x8FBE;&#x5F0F;&#x90FD;&#x88AB;&#x5C55;&#x5F00;&#x3002;</p>
<p>&#x7ED9;&#x51FA;&#x4E00;&#x4E2A;&#x5177;&#x4F53;&#x7684;&#x4F8B;&#x5B50;&#x3002; &#x8003;&#x8651;&#x5E03;&#x5C14;&#x8868;&#x8FBE;&#x5F0F;&#x2018;(id = 1) OR (id = 2) OR (id = 3)&#x2019; &#x3002; &#x56FE;3.9(a)&#x663E;&#x793A;&#x4E86;&#x4F7F;&#x7528;&#x4E8C;&#x5143;&#x8FD0;&#x7B97;&#x7B26;&#x65F6;&#x67E5;&#x8BE2;&#x6811;&#x7684;&#x4E00;&#x90E8;&#x5206;&#x3002; &#x4F18;&#x5316;&#x5668;&#x901A;&#x8FC7;&#x4F7F;&#x7528;&#x4E09;&#x5143;&#x8FD0;&#x7B97;&#x7B26;&#x8FDB;&#x884C;&#x62FC;&#x5408;&#x6765;&#x7B80;&#x5316;&#x6B64;&#x6811;&#x3002; &#x53C2;&#x8003;&#x56FE;3.9(b)&#x3002;</p>
</li>
</ol>
<p><strong>&#x56FE;. 3.9. &#x5C55;&#x5F00;AND/OR&#x8868;&#x8FBE;&#x5F0F;&#x793A;&#x4F8B;</strong></p>
<p><img src="https://github.com/yonj1e/The-Internals-of-PostgreSQL/blob/master/imgs/ch3/fig-3-09.png?raw=true" alt="Fig. 3.9. An example of flattening AND/OR expressions."></p>
<h3 id="332-&#x83B7;&#x53D6;&#x6700;&#x4F18;&#x8BBF;&#x95EE;&#x8DEF;&#x5F84;">3.3.2. &#x83B7;&#x53D6;&#x6700;&#x4F18;&#x8BBF;&#x95EE;&#x8DEF;&#x5F84;</h3>
<p>&#x4E3A;&#x4E86;&#x83B7;&#x5F97;&#x6700;&#x4F18;&#x7684;&#x8BBF;&#x95EE;&#x8DEF;&#x5F84;&#xFF0C;&#x4F18;&#x5316;&#x5668;&#x4F30;&#x8BA1;&#x6240;&#x6709;&#x53EF;&#x80FD;&#x7684;&#x8BBF;&#x95EE;&#x8DEF;&#x5F84;&#x7684;&#x6210;&#x672C;&#xFF0C;&#x5E76;&#x9009;&#x62E9;&#x6700;&#x4F18;&#x7684;&#x8BBF;&#x95EE;&#x8DEF;&#x5F84;&#x3002; &#x66F4;&#x5177;&#x4F53;&#x5730;&#x8BF4;&#xFF0C;&#x4F18;&#x5316;&#x5668;&#x6267;&#x884C;&#x4EE5;&#x4E0B;&#x64CD;&#x4F5C;&#xFF1A;</p>
<ol>
<li><p>&#x521B;&#x5EFA; <a href="javascript:void(0" target="_blank">RelOptInfo</a>) &#x7ED3;&#x6784;&#x6765;&#x5B58;&#x50A8;&#x8BBF;&#x95EE;&#x8DEF;&#x5F84;&#x548C;&#x76F8;&#x5E94;&#x7684;&#x6210;&#x672C;&#x3002;</p>
<p>RelOptInfo&#x7ED3;&#x6784;&#x7531;make_one_rel()&#x51FD;&#x6570;&#x521B;&#x5EFA;&#x5E76;&#x5B58;&#x50A8;&#x5728;PlannerInfo&#x7ED3;&#x6784;&#x7684;simple_rel_array&#x4E2D;&#x3002; &#x53C2;&#x8003;&#x56FE;3.10&#x3002; &#x5728;&#x521D;&#x59CB;&#x72B6;&#x6001;&#x4E0B;&#xFF0C;&#x5982;&#x679C;&#x5B58;&#x5728;&#x76F8;&#x5173;&#x7D22;&#x5F15;&#xFF0C;&#x5219;RelOptInfo&#x4FDD;&#x5B58;<em>baserestrictinfo</em> &#x548C; <em>indexlist</em> ; <em>baserestrictinfo</em> &#x5B58;&#x50A8;&#x67E5;&#x8BE2;&#x7684;WHERE&#x5B50;&#x53E5;&#xFF0C;<em>indexlist</em>&#x5B58;&#x50A8;&#x76EE;&#x6807;&#x8868;&#x7684;&#x76F8;&#x5173;&#x7D22;&#x5F15;&#x3002;</p>
</li>
<li><p>&#x4F30;&#x8BA1;&#x6240;&#x6709;&#x53EF;&#x80FD;&#x7684;&#x8BBF;&#x95EE;&#x8DEF;&#x5F84;&#x7684;&#x6210;&#x672C;&#xFF0C;&#x5E76;&#x5C06;&#x8BBF;&#x95EE;&#x8DEF;&#x5F84;&#x6DFB;&#x52A0;&#x5230;RelOptInfo&#x7ED3;&#x6784;&#x4E2D;&#x3002;</p>
<p>&#x8FD9;&#x4E2A;&#x5904;&#x7406;&#x7684;&#x7EC6;&#x8282;&#x5982;&#x4E0B;&#xFF1A;</p>
<ol>
<li>&#x521B;&#x5EFA;&#x8DEF;&#x5F84;&#xFF0C;&#x4F30;&#x8BA1;&#x987A;&#x5E8F;&#x626B;&#x63CF;&#x7684;&#x6210;&#x672C;&#xFF0C;&#x5E76;&#x5C06;&#x4F30;&#x8BA1;&#x7684;&#x6210;&#x672C;&#x5199;&#x5165;&#x8DEF;&#x5F84;&#x4E2D;&#x3002; &#x7136;&#x540E;&#xFF0C;&#x8DEF;&#x5F84;&#x88AB;&#x6DFB;&#x52A0;&#x5230;RelOptInfo&#x7ED3;&#x6784;&#x7684;<em>pathlist</em>&#x4E2D;&#x3002;</li>
<li>&#x5982;&#x679C;&#x5B58;&#x5728;&#x4E0E;&#x76EE;&#x6807;&#x8868;&#x76F8;&#x5173;&#x7684;&#x7D22;&#x5F15;&#xFF0C;&#x5219;&#x521B;&#x5EFA;&#x7D22;&#x5F15;&#x8BBF;&#x95EE;&#x8DEF;&#x5F84;&#xFF0C;&#x4F30;&#x8BA1;&#x6240;&#x6709;&#x7D22;&#x5F15;&#x626B;&#x63CF;&#x6210;&#x672C;&#xFF0C;&#x5E76;&#x5C06;&#x4F30;&#x8BA1;&#x7684;&#x6210;&#x672C;&#x5199;&#x5165;&#x8DEF;&#x5F84;&#x3002; &#x7136;&#x540E;&#xFF0C;&#x7D22;&#x5F15;&#x8DEF;&#x5F84;&#x88AB;&#x6DFB;&#x52A0;&#x5230;<em>pathlist</em>&#x3002;</li>
<li>&#x5982;&#x679C;&#x53EF;&#x4EE5;&#x5B8C;&#x6210;<a href="https://wiki.postgresql.org/wiki/Bitmap_Indexes" target="_blank">&#x4F4D;&#x56FE;&#x626B;&#x63CF;(bitmap scan)</a>&#xFF0C;&#x5219;&#x521B;&#x5EFA;&#x4F4D;&#x56FE;&#x626B;&#x63CF;&#x8DEF;&#x5F84;&#xFF0C;&#x4F30;&#x8BA1;&#x6240;&#x6709;&#x4F4D;&#x56FE;&#x626B;&#x63CF;&#x6210;&#x672C;&#xFF0C;&#x5E76;&#x5C06;&#x4F30;&#x8BA1;&#x7684;&#x6210;&#x672C;&#x5199;&#x5165;&#x8DEF;&#x5F84;&#x4E2D;&#x3002; &#x7136;&#x540E;&#xFF0C;&#x4F4D;&#x56FE;&#x626B;&#x63CF;&#x8DEF;&#x5F84;&#x88AB;&#x6DFB;&#x52A0;&#x5230;<em>pathlist</em>&#x3002;</li>
</ol>
</li>
<li><p>&#x5728;RelOptInfo&#x7ED3;&#x6784;&#x7684;<em>pathlist</em>&#x4E2D;&#x83B7;&#x53D6;&#x6700;&#x4F18;&#x7684;&#x8BBF;&#x95EE;&#x8DEF;&#x5F84;&#x3002;</p>
</li>
<li><p>&#x6839;&#x636E;&#x9700;&#x8981;&#x4F30;&#x7B97; LIMIT, ORDER BY &#x548C; ARREGISFDD&#x6210;&#x672C;&#x3002;</p>
</li>
</ol>
<p>&#x4E3A;&#x4E86;&#x7406;&#x89E3;&#x4F18;&#x5316;&#x5668;&#x7684;&#x8868;&#x73B0;&#x5982;&#x4F55;&#xFF0C;&#x4E0B;&#x9762;&#x7ED9;&#x51FA;&#x4E86;&#x4E24;&#x4E2A;&#x5177;&#x4F53;&#x7684;&#x4F8B;&#x5B50;&#x3002;</p>
<h4 id="3321-&#x793A;&#x4F8B;1">3.3.2.1. &#x793A;&#x4F8B;1</h4>
<p>&#x9996;&#x5148;&#xFF0C;&#x6211;&#x4EEC;&#x63A2;&#x7D22;&#x4E00;&#x4E2A;&#x6CA1;&#x6709;&#x7D22;&#x5F15;&#x7684;&#x7B80;&#x5355;&#x5355;&#x8868;&#x67E5;&#x8BE2;; &#x8FD9;&#x4E2A;&#x67E5;&#x8BE2;&#x5305;&#x542B;WHERE&#x548C;ORDER BY&#x5B50;&#x53E5;&#x3002;</p>
<pre><code class="lang-sql">testdb=# \d tbl_1
     Table &quot;public.tbl_1&quot;
 Column |  Type   | Modifiers 
<span class="hljs-comment">--------+---------+-----------</span>
 id     | integer | 
 data   | integer | 

testdb=# <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> tbl_1 <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> &lt; <span class="hljs-number">300</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">data</span>;
</code></pre>
<p>&#x56FE;3.10&#x548C;3.11&#x63CF;&#x8FF0;&#x4E86;&#x89C4;&#x5212;&#x5668;&#x5728;&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x4E2D;&#x7684;&#x8868;&#x73B0;&#x3002;</p>
<p><strong>&#x56FE;. 3.10. &#x5982;&#x4F55;&#x83B7;&#x5F97;&#x793A;&#x4F8B;1&#x7684;&#x6700;&#x4F18;&#x8DEF;&#x5F84;</strong></p>
<p><img src="https://github.com/yonj1e/The-Internals-of-PostgreSQL/blob/master/imgs/ch3/fig-3-10.png?raw=true" alt="Fig. 3.10. How to get the cheapest path of Example 1."></p>
<ol>
<li><p>&#x521B;&#x5EFA;&#x4E00;&#x4E2A;RelOptInfo&#x7ED3;&#x6784;&#x5E76;&#x5C06;&#x5176;&#x5B58;&#x50A8;&#x5728;PlannerInfo&#x7684;simple_rel_array&#x4E2D;&#x3002;</p>
</li>
<li><p>&#x5728;RelOptInfo&#x7684;<em>baserestrictinfo</em>&#x4E2D;&#x6DFB;&#x52A0;&#x4E00;&#x4E2A;WHERE&#x5B50;&#x53E5;&#x3002;</p>
<p>&#x901A;&#x8FC7;<a href="https://github.com/postgres/postgres/blob/master/src/backend/optimizer/plan/initsplan.c" target="_blank">initsplan.c</a>&#x4E2D;&#x5B9A;&#x4E49;&#x7684;distribute_restrictinfo_to_rels()&#x51FD;&#x6570;&#x5C06;WHERE&#x5B50;&#x53E5;<em>&#x2018;id &lt; 300&#x2019;</em> &#x6DFB;&#x52A0;&#x5230;<em>baserestrictinfo</em>&#x3002; &#x53E6;&#x5916;&#xFF0C;RelOptInfo&#x7684;<em>indexlist</em>&#x662F;NULL&#xFF0C;&#x56E0;&#x4E3A;&#x76EE;&#x6807;&#x8868;&#x6CA1;&#x6709;&#x76F8;&#x5173;&#x7684;&#x7D22;&#x5F15;&#x3002;</p>
</li>
<li><p>&#x901A;&#x8FC7;<a href="https://github.com/postgres/postgres/blob/master/src/backend/optimizer/plan/planner.c" target="_blank">planner.c</a>&#x4E2D;&#x5B9A;&#x4E49;&#x7684;standard_qp_callback() &#x51FD;&#x6570;&#x5C06;&#x6392;&#x5E8F;pathkey&#x6DFB;&#x52A0;&#x5230;PlannerInfo&#x7684;<em>sort_pathkeys</em>&#x4E2D;&#x3002;</p>
<p><em>pathkey</em>&#x662F;&#x8868;&#x793A;&#x8DEF;&#x5F84;&#x6392;&#x5E8F;&#x987A;&#x5E8F;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x3002; &#x5728;&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x4E2D;&#xFF0C;&#x5217;&#x201C;data&#x201D;&#x4F5C;&#x4E3A;&#x4E00;&#x4E2A;<em>pathkey</em>&#x88AB;&#x6DFB;&#x52A0;&#x5230;sort_pathkeys&#xFF0C;&#x56E0;&#x4E3A;&#x8FD9;&#x4E2A;&#x67E5;&#x8BE2;&#x5305;&#x542B;&#x4E00;&#x4E2A;ORDER BY&#x5B50;&#x53E5;&#x5E76;&#x4E14;&#x5B83;&#x7684;&#x5217;&#x662F;&apos;data&apos;&#x3002;</p>
</li>
<li><p>&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x8DEF;&#x5F84;&#x7ED3;&#x6784;&#x5E76;&#x4F7F;&#x7528;cost_seqscan&#x51FD;&#x6570;&#x4F30;&#x8BA1;&#x987A;&#x5E8F;&#x626B;&#x63CF;&#x7684;&#x6210;&#x672C;&#xFF0C;&#x5E76;&#x5C06;&#x4F30;&#x8BA1;&#x7684;&#x6210;&#x672C;&#x5199;&#x5165;&#x8DEF;&#x5F84;&#x3002; &#x7136;&#x540E;&#xFF0C;&#x901A;&#x8FC7;<a href="https://github.com/postgres/postgres/blob/master/src/backend/optimizer/util/pathnode.c" target="_blank">pathnode.c</a>&#x4E2D;&#x5B9A;&#x4E49;&#x7684;add_path() &#x51FD;&#x6570;&#x5C06;&#x8DEF;&#x5F84;&#x6DFB;&#x52A0;&#x5230;RelOptInfo&#x3002;</p>
<p>&#x5982;&#x524D;&#x6240;&#x8FF0;&#xFF0C; <a href="javascript:void(0" target="_blank">Path</a>) &#x7ED3;&#x6784;&#x65E2;&#x5305;&#x542B;&#x7531;cost_seqscan&#x51FD;&#x6570;&#x4F30;&#x8BA1;&#x7684;&#x542F;&#x52A8;&#x6210;&#x672C;&#x548C;&#x603B;&#x6210;&#x672C;&#xFF0C;&#x7B49;&#x7B49;&#x3002;</p>
</li>
</ol>
<p>&#x5728;&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x4E2D;&#xFF0C;&#x7531;&#x4E8E;&#x6CA1;&#x6709;&#x76EE;&#x6807;&#x8868;&#x7684;&#x7D22;&#x5F15;&#xFF0C;&#x4F18;&#x5316;&#x5668;&#x53EA;&#x4F30;&#x8BA1;&#x987A;&#x5E8F;&#x626B;&#x63CF;&#x6210;&#x672C;; &#x56E0;&#x6B64;&#xFF0C;&#x6700;&#x4F18;&#x7684;&#x8BBF;&#x95EE;&#x8DEF;&#x5F84;&#x662F;&#x81EA;&#x52A8;&#x786E;&#x5B9A;&#x7684;&#x3002;</p>
<p><strong>&#x56FE;. 3.11. &#x5982;&#x4F55;&#x83B7;&#x5F97;&#x793A;&#x4F8B;1&#x7684;&#x6700;&#x4F18;&#x8DEF;&#x5F84;(&#x4ECE;&#x56FE;3.10&#x7EE7;&#x7EED;)</strong></p>
<p><img src="https://github.com/yonj1e/The-Internals-of-PostgreSQL/blob/master/imgs/ch3/fig-3-11.png?raw=true" alt="Fig. 3.11. How to get the cheapest path of Example 1 (continued from Fig. 3.10)."></p>
<ol>
<li><p>&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;RelOptInfo&#x7ED3;&#x6784;&#x6765;&#x5904;&#x7406;ORDER BY&#x8FC7;&#x7A0B;&#x3002;</p>
<p>&#x8BF7;&#x6CE8;&#x610F;&#xFF0C;&#x65B0;&#x7684;RelOptInfo&#x6CA1;&#x6709;<em>baserestrictinfo</em>&#xFF0C;&#x5373;WHERE&#x5B50;&#x53E5;&#x7684;&#x4FE1;&#x606F;&#x3002;</p>
</li>
<li><p>&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x6392;&#x5E8F;&#x8DEF;&#x5F84;&#x5E76;&#x5C06;&#x5176;&#x6DFB;&#x52A0;&#x5230;&#x65B0;&#x7684;RelOptInfo; &#x7136;&#x540E;&#x5C06;&#x987A;&#x5E8F;&#x626B;&#x63CF;&#x8DEF;&#x5F84;&#x94FE;&#x63A5;&#x5230;&#x6392;&#x5E8F;&#x8DEF;&#x5F84;&#x7684;&#x5B50;&#x8DEF;&#x5F84;&#x3002;</p>
<p><a href="javascript:void(0" target="_blank">SortPath</a>) &#x7ED3;&#x6784;&#x7531;&#x4E24;&#x4E2A;&#x8DEF;&#x5F84;&#x7ED3;&#x6784;&#x7EC4;&#x6210;&#xFF1A;&#x8DEF;&#x5F84;&#x548C;&#x5B50;&#x8DEF;&#x5F84;; &#x8BE5;&#x8DEF;&#x5F84;&#x5B58;&#x50A8;&#x6709;&#x5173;&#x6392;&#x5E8F;&#x64CD;&#x4F5C;&#x672C;&#x8EAB;&#x7684;&#x4FE1;&#x606F;&#xFF0C;&#x5E76;&#x4E14;&#x5B50;&#x8DEF;&#x5F84;&#x5B58;&#x50A8;&#x6700;&#x4F18;&#x7684;&#x8DEF;&#x5F84;&#x3002;</p>
<p>&#x8BF7;&#x6CE8;&#x610F;&#xFF0C;&#x987A;&#x5E8F;&#x626B;&#x63CF;&#x8DEF;&#x5F84;&#x7684;&#x9879;&#x76EE;&#x2018;parent&#x2019;&#x4FDD;&#x5B58;&#x5230;&#x65E7;RelOptInfo&#x7684;&#x94FE;&#x63A5;&#xFF0C;&#x8BE5;&#x65E7;RelOptInfo&#x5C06;WHERE&#x5B50;&#x53E5;&#x5B58;&#x50A8;&#x5728;&#x5176;<em>baserestrictinfo</em>&#x4E2D;&#x3002; &#x56E0;&#x6B64;&#xFF0C;&#x5728;&#x4E0B;&#x4E00;&#x9636;&#x6BB5;&#xFF0C;&#x5373;&#x521B;&#x5EFA;&#x8BA1;&#x5212;&#x6811;&#x65F6;&#xFF0C;&#x4F18;&#x5316;&#x5668;&#x53EF;&#x4EE5;&#x521B;&#x5EFA;&#x5305;&#x542B;WHERE&#x5B50;&#x53E5;&#x4F5C;&#x4E3A; &#x2018;Filter&#x2019;&#x7684;&#x987A;&#x5E8F;&#x626B;&#x63CF;&#x8282;&#x70B9;&#xFF0C;&#x5373;&#x4F7F;&#x65B0;&#x7684;RelOptInfo&#x6CA1;&#x6709;<em>baserestrictinfo</em>&#x3002;</p>
</li>
</ol>
<p>&#x6839;&#x636E;&#x6B64;&#x5904;&#x83B7;&#x5F97;&#x7684;&#x6700;&#x4F18;&#x7684;&#x8BBF;&#x95EE;&#x8DEF;&#x5F84;&#xFF0C;&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x67E5;&#x8BE2;&#x6811;&#x3002; &#x7EC6;&#x8282;&#x5728;3.3.3&#x8282;&#x4E2D;&#x63CF;&#x8FF0;&#x3002;</p>
<h4 id="3322-&#x793A;&#x4F8B;2">3.3.2.2. &#x793A;&#x4F8B;2</h4>
<p>&#x63A5;&#x4E0B;&#x6765;&#xFF0C;&#x6211;&#x4EEC;&#x63A2;&#x7D22;&#x53E6;&#x4E00;&#x4E2A;&#x5E26;&#x6709;&#x4E24;&#x4E2A;&#x7D22;&#x5F15;&#x7684;&#x5355;&#x8868;&#x67E5;&#x8BE2;; &#x8FD9;&#x4E2A;&#x67E5;&#x8BE2;&#x5305;&#x542B;&#x4E00;&#x4E2A;WHERE&#x5B50;&#x53E5;&#x3002;</p>
<pre><code class="lang-sql">testdb=# \d tbl_2
     Table &quot;public.tbl_2&quot;
 Column |  Type   | Modifiers 
<span class="hljs-comment">--------+---------+-----------</span>
 id     | integer | not null
 data   | integer | 
Indexes:
    &quot;tbl_2_pkey&quot; PRIMARY KEY, btree (id)
    &quot;tbl_2_data_idx&quot; btree (data)

testdb=# <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> tbl_2 <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> &lt; <span class="hljs-number">240</span>;
</code></pre>
<p>&#x56FE;3.12&#x81F3;3.14&#x63CF;&#x8FF0;&#x4E86;&#x89C4;&#x5212;&#x5E08;&#x5728;&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x4E2D;&#x7684;&#x8868;&#x73B0;&#x3002;</p>
<ol>
<li><p>&#x521B;&#x5EFA;&#x4E00;&#x4E2A;<em>RelOptInfo</em>&#x7ED3;&#x6784;</p>
</li>
<li><p>&#x5C06;WHERE&#x5B50;&#x53E5;&#x6DFB;&#x52A0;&#x5230;<em>baserestrictinfo</em>&#xFF0C;&#x5E76;&#x5C06;&#x76EE;&#x6807;&#x8868;&#x7684;&#x7D22;&#x5F15;&#x6DFB;&#x52A0;&#x5230;<em>indexlist</em>&#x3002;</p>
<p>&#x5728;&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x4E2D;&#xFF0C;WHERE&#x5B50;&#x53E5;&apos;id &lt;240&apos;&#x88AB;&#x6DFB;&#x52A0;&#x5230;<em>baserestrictinfo</em>&#xFF0C;&#x5E76;&#x4E14;&#x4E24;&#x4E2A;&#x7D22;&#x5F15;<em>tbl_2_pkey</em>&#x548C;<em>tbl_2_data_idx</em>&#x88AB;&#x6DFB;&#x52A0;&#x5230;RelOptInfo&#x7684;<em>indexlist</em>&#x4E2D;&#x3002;</p>
</li>
<li><p>&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x8DEF;&#x5F84;&#xFF0C;&#x4F30;&#x8BA1;&#x987A;&#x5E8F;&#x626B;&#x63CF;&#x7684;&#x5F00;&#x9500;&#x5E76;&#x5C06;&#x8DEF;&#x5F84;&#x6DFB;&#x52A0;&#x5230;<em>RelOptInfo</em>&#x7684;<em>indexlist</em>&#x4E2D;&#x3002;</p>
</li>
</ol>
<p><strong>&#x56FE;. 3.12. &#x793A;&#x4F8B;2&#x4E2D;&#x5982;&#x4F55;&#x83B7;&#x5F97;&#x6700;&#x4F18;&#x8DEF;&#x5F84;</strong></p>
<p><img src="https://github.com/yonj1e/The-Internals-of-PostgreSQL/blob/master/imgs/ch3/fig-3-12.png?raw=true" alt="Fig. 3.12. How to get the cheapest path of Example 2."></p>
<p><strong>&#x56FE;. 3.13. &#x793A;&#x4F8B;2&#x4E2D;&#x5982;&#x4F55;&#x83B7;&#x5F97;&#x6700;&#x4F18;&#x8DEF;&#x5F84;(&#x4ECE;&#x56FE;3.12&#x7EE7;&#x7EED;)</strong></p>
<p><img src="https://github.com/yonj1e/The-Internals-of-PostgreSQL/blob/master/imgs/ch3/fig-3-13.png?raw=true" alt="Fig. 3.13. How to get the cheapest path of Example 2 (continued from Fig. 3.12)."></p>
<ol>
<li><p>&#x521B;&#x5EFA; <a href="javascript:void(0" target="_blank">IndexPath</a>)&#xFF0C;&#x4F30;&#x7B97;&#x7D22;&#x5F15;&#x626B;&#x63CF;&#x7684;&#x6210;&#x672C;&#xFF0C;&#x5E76;&#x4F7F;&#x7528;add_path()&#x51FD;&#x6570;&#x5C06;IndexPath&#x6DFB;&#x52A0;&#x5230;RelOptInfo&#x7684;pathlist&#x4E2D;&#x3002;</p>
<p>&#x5728;&#x672C;&#x4F8B;&#x4E2D;&#xFF0C;&#x7531;&#x4E8E;&#x6709;&#x4E24;&#x4E2A;&#x7D22;&#x5F15;tbl_2_pkey&#x548C;tbl_2_data_idx&#xFF0C;&#x6240;&#x4EE5;&#x8FD9;&#x4E9B;&#x7D22;&#x5F15;&#x6309;&#x987A;&#x5E8F;&#x5904;&#x7406;&#x3002; &#x9996;&#x5148;&#x5904;&#x7406;tbl_2_pkey&#x3002;</p>
<p>&#x4E3A;tbl_2_pkey&#x521B;&#x5EFA;IndexPath&#xFF0C;&#x5E76;&#x4F30;&#x7B97;&#x542F;&#x52A8;&#x6210;&#x672C;&#x548C;&#x603B;&#x6210;&#x672C;&#x3002; &#x5728;&#x672C;&#x4F8B;&#x4E2D;&#xFF0C;tbl_2_pkey&#x662F;&#x4E0E;&apos;id&apos;&#x5217;&#x76F8;&#x5173;&#x7684;&#x7D22;&#x5F15;&#xFF0C;&#x800C;WHERE&#x5B50;&#x53E5;&#x5305;&#x542B;&apos;id&apos;&#x5217;; &#x56E0;&#x6B64;&#xFF0C;WHERE&#x5B50;&#x53E5;&#x5B58;&#x50A8;&#x5728;IndexPath&#x7684; <em>indexclauses</em>&#x4E2D;&#x3002;</p>
<p>&#x8BF7;&#x6CE8;&#x610F;&#xFF0C;&#x5411;pathlist&#x6DFB;&#x52A0;&#x8BBF;&#x95EE;&#x8DEF;&#x5F84;&#x65F6;&#xFF0C;add_path()&#x51FD;&#x6570;&#x4F1A;&#x6309;&#x7167;&#x603B;&#x6210;&#x672C;&#x7684;&#x6392;&#x5E8F;&#x987A;&#x5E8F;&#x6DFB;&#x52A0;&#x8DEF;&#x5F84;&#x3002; &#x5728;&#x6B64;&#x793A;&#x4F8B;&#x4E2D;&#xFF0C;&#x6B64;&#x7D22;&#x5F15;&#x626B;&#x63CF;&#x7684;&#x603B;&#x6210;&#x672C;&#x5C0F;&#x4E8E;&#x987A;&#x5E8F;&#x626B;&#x63CF;&#x603B;&#x6210;&#x672C;; &#x56E0;&#x6B64;&#xFF0C;&#x8BE5;&#x7D22;&#x5F15;&#x8DEF;&#x5F84;&#x88AB;&#x63D2;&#x5165;&#x5728;&#x987A;&#x5E8F;&#x626B;&#x63CF;&#x8DEF;&#x5F84;&#x4E4B;&#x524D;&#x3002;</p>
</li>
<li><p>&#x521B;&#x5EFA;&#x53E6;&#x4E00;&#x4E2A;IndexPath&#xFF0C;&#x4F30;&#x7B97;&#x5176;&#x4ED6;&#x7D22;&#x5F15;&#x626B;&#x63CF;&#x7684;&#x6210;&#x672C;&#x5E76;&#x5C06;&#x7D22;&#x5F15;&#x8DEF;&#x5F84;&#x6DFB;&#x52A0;&#x5230;RelOptInfo&#x7684;pathlist&#x3002;</p>
<p>&#x63A5;&#x4E0B;&#x6765;&#xFF0C;&#x4E3A;tbl_2_data_idx&#x521B;&#x5EFA;IndexPath&#xFF0C;&#x4F30;&#x8BA1;&#x6210;&#x672C;&#x5E76;&#x5C06;&#x6B64;IndexPath&#x6DFB;&#x52A0;&#x5230;pathlist&#x3002; &#x5728;&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x4E2D;&#xFF0C;&#x6CA1;&#x6709;&#x4E0E;tbl_2_data_idx&#x7D22;&#x5F15;&#x76F8;&#x5173;&#x7684;WHERE&#x5B50;&#x53E5;; &#x56E0;&#x6B64;&#xFF0C;&#x7D22;&#x5F15;&#x5B50;&#x53E5;&#x662F;NULL&#x3002;</p>
</li>
</ol>
<blockquote>
<p>:exclamation: &#x8BF7;&#x6CE8;&#x610F;&#xFF0C;add_path()&#x51FD;&#x6570;&#x5E76;&#x4E0D;&#x603B;&#x662F;&#x6DFB;&#x52A0;&#x8DEF;&#x5F84;&#x3002; &#x7531;&#x4E8E;&#x8FD9;&#x79CD;&#x64CD;&#x4F5C;&#x7684;&#x590D;&#x6742;&#x6027;&#xFF0C;&#x7EC6;&#x8282;&#x88AB;&#x7701;&#x7565;&#x3002; &#x6709;&#x5173;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;add_path()&#x51FD;&#x6570;&#x7684;&#x6CE8;&#x91CA;&#x3002;</p>
</blockquote>
<ol>
<li><p>&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;RelOptInfo&#x7ED3;&#x6784;</p>
</li>
<li><p>&#x5C06;&#x6700;&#x4F18;&#x8DEF;&#x5F84;&#x6DFB;&#x52A0;&#x5230;&#x65B0;RelOptInfo&#x7684;pathlist&#x4E2D;</p>
<p>&#x5728;&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x4E2D;&#xFF0C;&#x6700;&#x4F18;&#x8DEF;&#x5F84;&#x662F;&#x4F7F;&#x7528;&#x7D22;&#x5F15;tbl_2_pkey&#x7684;&#x7D22;&#x5F15;&#x8DEF;&#x5F84;; &#x56E0;&#x6B64;&#xFF0C;&#x5B83;&#x7684;&#x8DEF;&#x5F84;&#x88AB;&#x6DFB;&#x52A0;&#x5230;&#x65B0;&#x7684;RelOptInfo&#x7684;pathlist&#x4E2D;&#x3002;</p>
</li>
</ol>
<p><strong>&#x56FE;. 3.14. &#x793A;&#x4F8B;2&#x4E2D;&#x5982;&#x4F55;&#x83B7;&#x53D6;&#x6700;&#x4F18;&#x8DEF;&#x5F84;(&#x4ECE;&#x56FE;3.13&#x7EE7;&#x7EED;)</strong></p>
<p><img src="https://github.com/yonj1e/The-Internals-of-PostgreSQL/blob/master/imgs/ch3/fig-3-14.png?raw=true" alt="Fig. 3.14. How to get the cheapest path of Example 2 (continued from Fig. 3.13)."></p>
<h3 id="333-&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x8BA1;&#x5212;&#x6811;">3.3.3. &#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x8BA1;&#x5212;&#x6811;</h3>
<p>&#x5728;&#x6700;&#x540E;&#x9636;&#x6BB5;&#xFF0C;&#x4F18;&#x5316;&#x5668;&#x4ECE;&#x6700;&#x4F18;&#x8DEF;&#x5F84;&#x751F;&#x6210;&#x8BA1;&#x5212;&#x6811;&#x3002;</p>
<p>&#x8BA1;&#x5212;&#x6811;&#x7684;&#x6839;&#x662F;<a href="https://github.com/postgres/postgres/blob/master/src/include/nodes/plannodes.h" target="_blank">plannodes.h</a>&#x4E2D;&#x5B9A;&#x4E49;&#x7684;  <a href="javascript:void(0" target="_blank">PlannedStmt</a>) &#x7ED3;&#x6784;&#x3002; &#x5B83;&#x5305;&#x542B;19&#x4E2A;&#x5143;&#x7D20;&#xFF0C;&#x8FD9;&#x91CC;&#x6709;4&#x4E2A;&#x4EE3;&#x8868;&#x6027;&#x7684;&#x5143;&#x7D20;&#x3002;</p>
<ul>
<li><strong>commandType</strong> &#x5B58;&#x50A8;&#x4E00;&#x4E2A;&#x64CD;&#x4F5C;&#x7C7B;&#x578B;&#xFF0C;&#x5982;SELECT&#xFF0C;UPDATE&#x548C;INSERT&#x3002;</li>
<li><strong>rtable</strong> &#x5B58;&#x50A8;rangeTable&#x6761;&#x76EE;&#x3002;</li>
<li><strong>relationOids</strong> &#x5B58;&#x50A8;&#x8BE5;&#x67E5;&#x8BE2;&#x7684;&#x76F8;&#x5173;&#x8868;&#x7684;oid&#x3002;</li>
<li><strong>plantree</strong> &#x5B58;&#x50A8;&#x7531;&#x8BA1;&#x5212;&#x8282;&#x70B9;&#x7EC4;&#x6210;&#x7684;&#x8BA1;&#x5212;&#x6811;&#xFF0C;&#x5176;&#x4E2D;&#x6BCF;&#x4E2A;&#x8282;&#x70B9;&#x5BF9;&#x5E94;&#x4E8E;&#x7279;&#x5B9A;&#x64CD;&#x4F5C;&#xFF0C;&#x5982;&#x987A;&#x5E8F;&#x626B;&#x63CF;&#x3001;&#x6392;&#x5E8F;&#x548C;&#x7D22;&#x5F15;&#x626B;&#x63CF;&#x3002; </li>
</ul>
<p>&#x5982;&#x4E0A;&#x6240;&#x8FF0;&#xFF0C;&#x8BA1;&#x5212;&#x6811;&#x7531;&#x5404;&#x79CD;&#x8BA1;&#x5212;&#x8282;&#x70B9;&#x7EC4;&#x6210;&#x3002; <a href="javascript:void(0" target="_blank">PlanNode</a>) &#x7ED3;&#x6784;&#x662F;&#x57FA;&#x672C;&#x8282;&#x70B9;&#xFF0C;&#x5176;&#x4ED6;&#x8282;&#x70B9;&#x59CB;&#x7EC8;&#x5305;&#x542B;&#x5B83;&#x3002; &#x4F8B;&#x5982;&#xFF0C;&#x7528;&#x4E8E;&#x987A;&#x5E8F;&#x626B;&#x63CF;&#x7684;<a href="javascript:void(0" target="_blank">SeqScanNode</a>) &#x7531;PlanNode&#x548C;&#x4E00;&#x4E2A;&#x6574;&#x6570;&#x53D8;&#x91CF;&apos;scanrelid&apos;&#x7EC4;&#x6210;&#x3002; PlanNode&#x5305;&#x542B;&#x5341;&#x56DB;&#x4E2A;&#x5143;&#x7D20;&#x3002; &#x4EE5;&#x4E0B;&#x662F;&#x4E03;&#x4E2A;&#x6709;&#x4EE3;&#x8868;&#x6027;&#x7684;&#x5143;&#x7D20;&#x3002;</p>
<ul>
<li><strong>start-up cost</strong> and <strong>total_cost</strong> &#x662F;&#x4E0E;&#x8BE5;&#x8282;&#x70B9;&#x76F8;&#x5BF9;&#x5E94;&#x7684;&#x64CD;&#x4F5C;&#x7684;&#x4F30;&#x8BA1;&#x6210;&#x672C;&#x3002;</li>
<li><strong>rows</strong> is the number of rows to be scanned which is estimated by the planner.</li>
<li><strong>targetlist</strong> &#x662F;&#x4F18;&#x5316;&#x5668;&#x4F30;&#x8BA1;&#x7684;&#x8981;&#x626B;&#x63CF;&#x7684;&#x884C;&#x6570;&#x3002;</li>
<li><strong>qual</strong> &#x662F;&#x4E00;&#x4E2A;&#x5B58;&#x50A8;qual&#x6761;&#x4EF6;&#x7684;&#x5217;&#x8868;&#x3002;</li>
<li><strong>lefttree</strong> and <strong>righttree</strong> &#x662F;&#x6DFB;&#x52A0;&#x5B50;&#x8282;&#x70B9;&#x7684;&#x8282;&#x70B9;&#x3002;</li>
</ul>
<p>&#x5728;&#x4E0B;&#x6587;&#x4E2D;&#xFF0C;&#x5C06;&#x63CF;&#x8FF0;&#x4E24;&#x4E2A;&#x8BA1;&#x5212;&#x6811;&#xFF0C;&#x5B83;&#x4EEC;&#x5C06;&#x4ECE;&#x524D;&#x4E00;&#x5C0F;&#x8282;&#x7684;&#x793A;&#x4F8B;&#x4E2D;&#x6240;&#x793A;&#x7684;&#x6700;&#x4F18;&#x8DEF;&#x5F84;&#x751F;&#x6210;&#x3002;</p>
<h4 id="3331-&#x793A;&#x4F8B;1">3.3.3.1. &#x793A;&#x4F8B;1</h4>
<p>&#x7B2C;&#x4E00;&#x4E2A;&#x4F8B;&#x5B50;&#x662F;&#x7B2C;3.3.2.1&#x8282;&#x4E2D;&#x793A;&#x4F8B;&#x7684;&#x8BA1;&#x5212;&#x6811;&#x3002; &#x56FE;3.11&#x6240;&#x793A;&#x7684;&#x6700;&#x4F18;&#x8DEF;&#x5F84;&#x662F;&#x7531;&#x6392;&#x5E8F;&#x8DEF;&#x5F84;&#x548C;&#x987A;&#x5E8F;&#x626B;&#x63CF;&#x8DEF;&#x5F84;&#x7EC4;&#x6210;&#x7684;&#x6811;; &#x6839;&#x8DEF;&#x5F84;&#x662F;&#x6392;&#x5E8F;&#x8DEF;&#x5F84;&#xFF0C;&#x5B50;&#x8DEF;&#x5F84;&#x662F;&#x987A;&#x5E8F;&#x626B;&#x63CF;&#x8DEF;&#x5F84;&#x3002; &#x5C3D;&#x7BA1;&#x7701;&#x7565;&#x4E86;&#x8BE6;&#x7EC6;&#x7684;&#x89E3;&#x91CA;&#xFF0C;&#x4F46;&#x5F88;&#x5BB9;&#x6613;&#x7406;&#x89E3;&#xFF0C;&#x8BA1;&#x5212;&#x6811;&#x51E0;&#x4E4E;&#x53EF;&#x4EE5;&#x4ECE;&#x6700;&#x4F18;&#x8DEF;&#x5F84;&#x751F;&#x6210;&#x3002; &#x5728;&#x672C;&#x4F8B;&#x4E2D;&#xFF0C; <a href="javascript:void(0" target="_blank">SortNode</a>) &#x88AB;&#x6DFB;&#x52A0;&#x5230;PlannedStmt&#x7ED3;&#x6784;&#x7684;plantree&#xFF0C;SeqScanNode&#x88AB;&#x6DFB;&#x52A0;&#x5230;SortNode&#x7684;lefttree&#x3002; &#x53C2;&#x8003;&#x56FE;3.15(a)&#x3002;</p>
<p><strong>&#x56FE;. 3.15. &#x8BA1;&#x5212;&#x6811;&#x793A;&#x4F8B;</strong></p>
<p><img src="https://github.com/yonj1e/The-Internals-of-PostgreSQL/blob/master/imgs/ch3/fig-3-15.png?raw=true" alt="Fig. 3.15. Examples of plan trees."></p>
<p>&#x5728;SortNode&#x4E2D;&#xFF0C;lefttree&#x6307;&#x5411;SeqScanNode&#x3002; </p>
<p>&#x5728;SeqScanNode&#x4E2D;&#xFF0C;qual&#x4FDD;&#x7559;WHERE&#x5B50;&#x53E5;&#x2018;id&lt;300&#x2019;&#x3002; </p>
<h4 id="3332-&#x793A;&#x4F8B;2">3.3.3.2. &#x793A;&#x4F8B;2</h4>
<p>&#x7B2C;&#x4E8C;&#x4E2A;&#x4F8B;&#x5B50;&#x662F;&#x7B2C;3.3.2.2&#x8282;&#x4E2D;&#x793A;&#x4F8B;&#x7684;&#x8BA1;&#x5212;&#x6811;&#x3002; &#x56FE;3.14&#x6240;&#x793A;&#x7684;&#x6700;&#x4F18;&#x8DEF;&#x5F84;&#x662F;&#x7D22;&#x5F15;&#x626B;&#x63CF;&#x8DEF;&#x5F84;; &#x56E0;&#x6B64;&#xFF0C;&#x8BE5;&#x8BA1;&#x5212;&#x6811;&#x4EC5;&#x7531;&#x4E00;&#x4E2A; <a href="javascript:void(0" target="_blank">IndexScanNode</a>) &#x7ED3;&#x6784;&#x7EC4;&#x6210;&#x3002; &#x53C2;&#x8003;&#x56FE;3.15(b)&#x3002;</p>
<p>&#x5728;&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x4E2D;&#xFF0C;WHERE&#x5B50;&#x53E5;&apos;id &lt;240&apos;&#x662F;&#x4E00;&#x4E2A;&#x8BBF;&#x95EE;&#x8C13;&#x8BCD;; &#x5B83;&#x56E0;&#x6B64;&#x5B58;&#x50A8;&#x5728;IndexScanNode&#x7684;indexqual&#x4E2D;&#x3002;</p>
<h2 id="34-&#x6267;&#x884C;&#x5668;&#x5982;&#x4F55;&#x6267;&#x884C;">3.4. &#x6267;&#x884C;&#x5668;&#x5982;&#x4F55;&#x6267;&#x884C;</h2>
<p>&#x5728;&#x5355;&#x8868;&#x67E5;&#x8BE2;&#x4E2D;&#xFF0C;&#x6267;&#x884C;&#x5668;&#x6309;&#x7167;&#x4ECE;&#x8BA1;&#x5212;&#x6811;&#x672B;&#x5C3E;&#x5230;&#x6839;&#x7684;&#x987A;&#x5E8F;&#x53D6;&#x5F97;&#x8BA1;&#x5212;&#x8282;&#x70B9;&#xFF0C;&#x7136;&#x540E;&#x8C03;&#x7528;&#x6267;&#x884C;&#x76F8;&#x5E94;&#x8282;&#x70B9;&#x7684;&#x5904;&#x7406;&#x51FD;&#x6570;&#x3002;</p>
<p>&#x6BCF;&#x4E2A;&#x8BA1;&#x5212;&#x8282;&#x70B9;&#x90FD;&#x5177;&#x6709;&#x7528;&#x4E8E;&#x6267;&#x884C;&#x76F8;&#x5E94;&#x64CD;&#x4F5C;&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x5E76;&#x4E14;&#x5B83;&#x4EEC;&#x4F4D;&#x4E8E;<a href="https://github.com/postgres/postgres/blob/master/src/backend/executor/" target="_blank">src/backend/executor/</a> &#x76EE;&#x5F55;&#x4E2D;&#x3002; &#x4F8B;&#x5982;&#xFF0C;&#x6267;&#x884C;&#x987A;&#x5E8F;&#x626B;&#x63CF;(ScanScan)&#x7684;&#x51FD;&#x6570;&#x5728;<a href="https://github.com/postgres/postgres/blob/master/src/backend/executor/nodeIndexscan.c" target="_blank">nodeSeqscan.c</a>&#x4E2D;&#x5B9A;&#x4E49;; &#x6267;&#x884C;&#x7D22;&#x5F15;&#x626B;&#x63CF;(IndexScanNode)&#x7684;&#x51FD;&#x6570;&#x5728;<a href="https://github.com/postgres/postgres/blob/master/src/backend/executor/nodeIndexscan.c" target="_blank">nodeIndexscan.c</a>&#x4E2D;&#x5B9A;&#x4E49;; &#x6392;&#x5E8F;SortNode&#x7684;&#x51FD;&#x6570;&#x5728;<a href="https://github.com/postgres/postgres/blob/master/src/backend/executor/nodeSort.c" target="_blank">nodeSort.c</a>&#x4E2D;&#x5B9A;&#x4E49;&#x7B49;&#x3002;</p>
<p>&#x5F53;&#x7136;&#xFF0C;&#x4E86;&#x89E3;&#x6267;&#x884C;&#x5668;&#x6267;&#x884C;&#x65B9;&#x5F0F;&#x7684;&#x6700;&#x597D;&#x65B9;&#x6CD5;&#x662F;&#x67E5;&#x770B;EXPLAIN&#x547D;&#x4EE4;&#x7684;&#x8F93;&#x51FA;&#xFF0C;&#x56E0;&#x4E3A;PostgreSQL&#x7684;EXPLAIN&#x51E0;&#x4E4E;&#x6309;&#x7167;&#x539F;&#x6837;&#x5C55;&#x793A;&#x4E86;&#x8BA1;&#x5212;&#x6811;&#x3002; &#x8FD9;&#x5C06;&#x5728;&#x7B2C;3.3.3&#x8282;&#x4E2D;&#x4F7F;&#x7528;&#x793A;&#x4F8B;1&#x8FDB;&#x884C;&#x89E3;&#x91CA;&#x3002;</p>
<pre><code class="lang-sql">testdb=# EXPLAIN SELECT * FROM tbl_1 WHERE id &lt; 300 ORDER BY data;
                    QUERY PLAN                           
--------------------------------------------------------------- 
Sort  (cost=182.34..183.09 rows=300 width=8)   
    Sort Key: data   
    -&gt;  Seq Scan on tbl_1  (cost=0.00..170.00 rows=300 width=8)         
        Filter: (id &lt; 300)
(4 rows)
</code></pre>
<p>&#x8BA9;&#x6211;&#x4EEC;&#x6765;&#x63A2;&#x8BA8;&#x6267;&#x884C;&#x5668;&#x662F;&#x5982;&#x4F55;&#x6267;&#x884C;&#x7684;&#x3002;&#x4ECE;&#x5E95;&#x884C;&#x5230;&#x9876;&#x884C;&#x67E5;&#x770B;EXPLAIN&#x547D;&#x4EE4;&#x7684;&#x8F93;&#x51FA;&#x7ED3;&#x679C;&#x3002; </p>
<ul>
<li><strong>&#x7B2C;6&#x884C;</strong>: &#x9996;&#x5148;&#xFF0C;&#x6267;&#x884C;&#x5668;&#x4F7F;&#x7528;<a href="https://github.com/postgres/postgres/blob/master/src/backend/executor/nodeSeqscan.c" target="_blank">nodeSeqscan.c</a>&#x4E2D;&#x5B9A;&#x4E49;&#x7684;&#x51FD;&#x6570;&#x6267;&#x884C;&#x987A;&#x5E8F;&#x626B;&#x63CF;&#x64CD;&#x4F5C;&#x3002;</li>
<li><strong>&#x7B2C;4&#x884C;</strong>: &#x63A5;&#x4E0B;&#x6765;&#xFF0C;&#x6267;&#x884C;&#x5668;&#x4F7F;&#x7528;<a href="https://github.com/postgres/postgres/blob/master/src/backend/executor/nodeSort.c" target="_blank">nodeSort.c</a>&#x4E2D;&#x5B9A;&#x4E49;&#x7684;&#x51FD;&#x6570;&#x5BF9;&#x987A;&#x5E8F;&#x626B;&#x63CF;&#x7684;&#x7ED3;&#x679C;&#x8FDB;&#x884C;&#x6392;&#x5E8F;&#x3002;</li>
</ul>
<blockquote>
<p>:pushpin: <em>Temporary Files</em> </p>
<p>&#x5C3D;&#x7BA1;&#x6267;&#x884C;&#x5668;&#x4F7F;&#x7528;&#x5B58;&#x50A8;&#x5668;&#x5206;&#x914D;&#x7684;work_men&#x548C;temp_buffers&#x8FDB;&#x884C;&#x67E5;&#x8BE2;&#x5904;&#x7406;&#xFF0C;&#x4F46;&#x5982;&#x679C;&#x4EC5;&#x5728;&#x5185;&#x5B58;&#x4E2D;&#x6267;&#x884C;&#x5904;&#x7406;&#xFF0C;&#x5B83;&#x5C06;&#x4F7F;&#x7528;&#x4E34;&#x65F6;&#x6587;&#x4EF6;&#x3002;</p>
<p>&#x4F7F;&#x7528;ANALYZE&#x9009;&#x9879;&#xFF0C;EXPLAIN&#x547D;&#x4EE4;&#x5B9E;&#x9645;&#x4E0A;&#x6267;&#x884C;&#x67E5;&#x8BE2;&#x5E76;&#x663E;&#x793A;&#x5B9E;&#x9645;&#x7684;&#x884C;&#x6570;&#x3001;&#x8FD0;&#x884C;&#x65F6;&#x95F4;&#x548C;&#x5185;&#x5B58;&#x4F7F;&#x7528;&#x60C5;&#x51B5;&#x3002; &#x5177;&#x4F53;&#x793A;&#x4F8B;&#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF1A;</p>
<pre><code class="lang-sql">1, testdb=# EXPLAIN ANALYZE SELECT id, data FROM tbl_25m ORDER BY id;
2,                          QUERY PLAN                         
3, ---------------------------------------------------------------------------
4,  Sort  (cost=3944070.01..3945895.01 rows=730000 width=4104) (actual time=885.648..1033.746 rows=730000 loops=1)
5,    Sort Key: id
6,    Sort Method: external sort  Disk: 10000kB
7,    -&gt;  Seq Scan on tbl_25m  (cost=0.00..10531.00 rows=730000 width=4104) (actual time=0.024..102.548 rows=730000 loops=1)
8,  Planning time: 1.548 ms
9,  Execution time: 1109.571 ms
10, (6 rows)
</code></pre>
<p>&#x5728;&#x7B2C;6&#x884C;&#x4E2D;&#xFF0C;EXPLAIN&#x547D;&#x4EE4;&#x663E;&#x793A;&#x6267;&#x884C;&#x7A0B;&#x5E8F;&#x4F7F;&#x7528;&#x4E86;&#x4E00;&#x4E2A;&#x5927;&#x5C0F;&#x4E3A;10000kB&#x7684;&#x4E34;&#x65F6;&#x6587;&#x4EF6;&#x3002;</p>
<p>&#x4E34;&#x65F6;&#x6587;&#x4EF6;&#x6682;&#x65F6;&#x5728;base/pg_tmp&#x5B50;&#x76EE;&#x5F55;&#x4E2D;&#x521B;&#x5EFA;&#xFF0C;&#x547D;&#x540D;&#x65B9;&#x6CD5;&#x5982;&#x4E0B;&#x6240;&#x793A;&#x3002;</p>
<pre><code class="lang-shell">{&quot;pgsql_tmp&quot;} + {PID of the postgres process which creates the file} . {sequencial number from 0}
</code></pre>
<p>&#x4F8B;&#x5982;&#xFF0C;&#x4E34;&#x65F6;&#x6587;&#x4EF6;&#x2018;pgsql_tmp8903.5&#x2019;&#x201D;&#x662F;&#x7531;PID&#x4E3A;8903&#x7684;Postgres&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;&#x7684;&#x7B2C;6&#x4E2A;&#x4E34;&#x65F6;&#x6587;&#x4EF6;&#x3002; </p>
<pre><code class="lang-shell">$ ls -la /usr/local/pgsql/data/base/pgsql_tmp*
-rw-------  1 postgres  postgres  10240000 12  4 14:18 pgsql_tmp8903.5
</code></pre>
</blockquote>
<hr>
<h2 id="35-join&#x64CD;&#x4F5C;">3.5. Join&#x64CD;&#x4F5C;</h2>
<p>PostgreSQL&#x652F;&#x6301;&#x4E09;&#x79CD;join&#x64CD;&#x4F5C;&#xFF1A;nested loop join&#xFF0C;merge join&#x548C;hash join&#x3002; PostgreSQL&#x4E2D;&#x7684;nested loop join&#x548C;merge join&#x6709;&#x51E0;&#x4E2A;&#x53D8;&#x5316;&#x3002;</p>
<p>&#x5728;&#x4E0B;&#x6587;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x5047;&#x8BBE;&#x8BFB;&#x8005;&#x719F;&#x6089;&#x8FD9;&#x4E09;&#x79CD;&#x8FDE;&#x63A5;&#x7684;&#x57FA;&#x672C;&#x884C;&#x4E3A;&#x3002; &#x5982;&#x679C;&#x60A8;&#x4E0D;&#x719F;&#x6089;&#x8FD9;&#x4E9B;&#x672F;&#x8BED;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;[<a href="http://www.interdb.jp/pg/pgsql03.html#_3.ref.1" target="_blank">1</a>, <a href="http://www.interdb.jp/pg/pgsql03.html#_3.ref.2" target="_blank">2</a>]&#x3002;&#x4F46;&#x662F;&#xFF0C;&#x5BF9;&#x4E8E;PostgreSQL&#x652F;&#x6301;&#x7684;hybrid hash join with skew&#xFF0C;&#x6CA1;&#x6709;&#x592A;&#x591A;&#x7684;&#x89E3;&#x91CA;&#xFF0C;&#x5728;&#x8FD9;&#x91CC;&#x5C06;&#x8FDB;&#x884C;&#x66F4;&#x8BE6;&#x7EC6;&#x7684;&#x89E3;&#x91CA;&#x3002;</p>
<p>&#x8BF7;&#x6CE8;&#x610F;&#xFF0C;PostgreSQL&#x652F;&#x6301;&#x7684;&#x4E09;&#x79CD;&#x8FDE;&#x63A5;&#x65B9;&#x6CD5;&#x53EF;&#x4EE5;&#x6267;&#x884C;&#x6240;&#x6709;&#x7684;&#x8FDE;&#x63A5;&#x64CD;&#x4F5C;&#xFF0C;&#x4E0D;&#x4EC5;&#x5305;&#x62EC;INNER JOIN&#xFF0C;&#x8FD8;&#x5305;&#x62EC;LEFT/RIGHT OUTER JOIN&#xFF0C;FULL OUTER JOIN&#x7B49;; &#x7136;&#x800C;&#xFF0C;&#x4E3A;&#x4E86;&#x7B80;&#x5316;&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x91CD;&#x70B9;&#x653E;&#x5728;&#x672C;&#x7AE0;&#x7684;NATURAL INNER JOIN&#x4E0A;&#x3002;</p>
<h3 id="351-nested-loop-join">3.5.1. Nested Loop Join</h3>
<p>nested loop join&#x662F;&#x6700;&#x57FA;&#x672C;&#x7684;&#x8FDE;&#x63A5;&#x64CD;&#x4F5C;&#xFF0C;&#x5B83;&#x53EF;&#x4EE5;&#x7528;&#x4E8E;&#x4EFB;&#x4F55;&#x8FDE;&#x63A5;&#x6761;&#x4EF6;&#x3002; PostgreSQL&#x652F;&#x6301;nested loop join&#x548C;&#x5B83;&#x7684;&#x4E94;&#x79CD;&#x53D8;&#x4F53;&#x3002;</p>
<h4 id="3511-nested-loop-join">3.5.1.1. Nested Loop Join</h4>
<p>nested loop join&#x4E0D;&#x9700;&#x8981;&#x4EFB;&#x4F55;&#x542F;&#x52A8;&#x64CD;&#x4F5C;; &#x4ECE;&#x800C;&#xFF0C;</p>
<p>&#x200B;    &#x2018;start-up cost&#x2019;=0.</p>
<p>nested loop join&#x7684;&#x8FD0;&#x884C;&#x6210;&#x672C;&#x4E0E;&#x5916;&#x8868;&#x548C;&#x5185;&#x8868;&#x7684;&#x5927;&#x5C0F;&#x7684;&#x4E58;&#x79EF;&#x6210;&#x6BD4;&#x4F8B;; &#x5373; &#x2018;run cost&#x2019;&#x2018;run cost&#x2019;&#x662F;O($N<em>{outer}$&#xD7;$N</em>{inner}$)&#xFF0C;&#x5176;&#x4E2D;$N<em>{outer}$ &#x548C;  $N</em>{inner}$&#x5206;&#x522B;&#x662F;&#x5916;&#x8868;&#x548C;&#x5185;&#x8868;&#x7684;&#x5143;&#x7EC4;&#x6570;&#x3002; &#x66F4;&#x786E;&#x5207;&#x5730;&#x8BF4;&#xFF0C;&#x5B83;&#x7531;&#x4EE5;&#x4E0B;&#x7B49;&#x5F0F;&#x5B9A;&#x4E49;&#xFF1A;</p>
<p>&#x200B;    &#x2018;run cost&#x2019; = (cpu<em>operator_cost + cpu_tuple_cost) &#xD7; $N</em>{outer}$ &#xD7; $N<em>{inner}$ + $C</em>{inner}$ &#xD7; $N<em>{outer}$ + $C</em>{outer}$</p>
<p>&#x5176;&#x4E2D;$C<em>{outer}$&#x548C;$C</em>{inner}$&#x5206;&#x522B;&#x662F;&#x5916;&#x8868;&#x548C;&#x5185;&#x8868;&#x7684;&#x626B;&#x63CF;&#x6210;&#x672C;&#x3002;</p>
<p><strong>&#x56FE;. 3.16. Nested loop join.</strong></p>
<p><img src="https://github.com/yonj1e/The-Internals-of-PostgreSQL/blob/master/imgs/ch3/fig-3-16.png?raw=true" alt="Fig. 3.16. Nested loop join."></p>
<p>nested loop join&#x7684;&#x6210;&#x672C;&#x603B;&#x662F;&#x53EF;&#x4EE5;&#x4F30;&#x8BA1;&#x7684;&#xFF0C;&#x4F46;&#x8FD9;&#x79CD;&#x8FDE;&#x63A5;&#x64CD;&#x4F5C;&#x5F88;&#x5C11;&#x4F7F;&#x7528;&#xFF0C;&#x56E0;&#x4E3A;&#x901A;&#x5E38;&#x4F7F;&#x7528;&#x4E0B;&#x9762;&#x63CF;&#x8FF0;&#x7684;&#x66F4;&#x6709;&#x6548;&#x7684;&#x53D8;&#x4F53;&#x3002;</p>
<h4 id="3512-materialized-nested-loop-join">3.5.1.2. Materialized Nested Loop Join</h4>
<p>&#x4E0A;&#x9762;&#x63CF;&#x8FF0;&#x7684;nested loop join&#x5FC5;&#x987B;&#x5728;&#x8BFB;&#x53D6;&#x5916;&#x8868;&#x7684;&#x6BCF;&#x4E2A;&#x5143;&#x7EC4;&#x65F6;&#x626B;&#x63CF;&#x5185;&#x8868;&#x7684;&#x6240;&#x6709;&#x5143;&#x7EC4;&#x3002;&#x56E0;&#x4E3A;&#x626B;&#x63CF;&#x6BCF;&#x4E2A;&#x5916;&#x8868;&#x5143;&#x7EC4;&#x7684;&#x6574;&#x4E2A;&#x5185;&#x8868;&#x662F;&#x4E00;&#x4E2A;&#x6602;&#x8D35;&#x7684;&#x8FC7;&#x7A0B;&#xFF0C;PostgreSQL&#x652F;&#x6301;<em>materialized nested loop join</em>&#xFF0C;&#x4EE5;&#x51CF;&#x5C11;&#x5185;&#x8868;&#x7684;&#x603B;&#x626B;&#x63CF;&#x6210;&#x672C;&#x3002; </p>
<p>&#x5728;&#x8FD0;&#x884C;nested loop join&#x4E4B;&#x524D;&#xFF0C;&#x6267;&#x884C;&#x5668;&#x901A;&#x8FC7;&#x4F7F;&#x7528;&#x4E0B;&#x9762;&#x63CF;&#x8FF0;&#x7684;&#x4E34;&#x65F6;&#x5143;&#x7EC4;&#x5B58;&#x50A8;(<em>temporary tuple storage</em>)&#x6A21;&#x5757;&#x626B;&#x63CF;&#x5185;&#x8868;&#x4E00;&#x6B21;&#xFF0C;&#x5C06;&#x5185;&#x8868;&#x5143;&#x7EC4;&#x5199;&#x5165;work_mem&#x6216;&#x4E34;&#x65F6;&#x6587;&#x4EF6;&#x3002;&#x4E0E;&#x4F7F;&#x7528;&#x7F13;&#x51B2;&#x533A;&#x7BA1;&#x7406;&#x5668;&#x76F8;&#x6BD4;&#xFF0C;&#x5B83;&#x6709;&#x53EF;&#x80FD;&#x66F4;&#x6709;&#x6548;&#x5730;&#x5904;&#x7406;&#x5185;&#x8868;&#x5143;&#x7EC4;&#xFF0C;&#x7279;&#x522B;&#x662F;&#x5982;&#x679C;&#x81F3;&#x5C11;&#x6240;&#x6709;&#x7684;&#x5143;&#x7EC4;&#x90FD;&#x5199;&#x5230;work_mem&#x4E2D;&#x3002; </p>
<p>&#x56FE;3.17&#x6F14;&#x793A;&#x4E86;materialized nested loop join&#x662F;&#x5982;&#x4F55;&#x6267;&#x884C;&#x7684;&#x3002; &#x626B;&#x63CF;&#x7269;&#x5316;&#x5143;&#x7EC4;(materialized tuples)&#x5728;&#x5185;&#x90E8;&#x79F0;&#x4E3A;<strong>&#x91CD;&#x65B0;&#x626B;&#x63CF;(rescan</strong>)&#x3002;</p>
<p><strong>&#x56FE;. 3.17. Materialized nested loop join.</strong></p>
<p><img src="https://github.com/yonj1e/The-Internals-of-PostgreSQL/blob/master/imgs/ch3/fig-3-17.png?raw=true" alt="Fig. 3.17. Materialized nested loop join."></p>
<blockquote>
<p>:pushpin: <em>&#x4E34;&#x65F6;&#x5143;&#x7EC4;&#x5B58;&#x50A8; Temporary Tuple Storage</em></p>
<p>PostgreSQL&#x5185;&#x90E8;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E2A;&#x4E34;&#x65F6;&#x5143;&#x7EC4;&#x5B58;&#x50A8;&#x6A21;&#x5757;&#xFF0C;&#x7528;&#x4E8E;&#x5728;hybrid hash join&#x4E2D;&#x521B;&#x5EFA;batch&#x7B49;&#x7B49;&#x3002;  &#x8FD9;&#x4E2A;&#x6A21;&#x5757;&#x7531;<a href="https://github.com/postgres/postgres/blob/master/src/backend/utils/sort/tuplestore.c" target="_blank">tuplestore.c</a>&#x4E2D;&#x5B9A;&#x4E49;&#x7684;&#x51FD;&#x6570;&#x7EC4;&#x6210;&#xFF0C;&#x5B83;&#x4EEC;&#x5B58;&#x50A8;&#x5E76;&#x4ECE;work_mem&#x6216;&#x4E34;&#x65F6;&#x6587;&#x4EF6;&#x4E2D;&#x8BFB;&#x53D6;&#x4E00;&#x7CFB;&#x5217;&#x5143;&#x7EC4;&#x3002; &#x662F;&#x5426;&#x4F7F;&#x7528;work_mem&#x6216;&#x4E34;&#x65F6;&#x6587;&#x4EF6;&#x53D6;&#x51B3;&#x4E8E;&#x8981;&#x5B58;&#x50A8;&#x7684;&#x5143;&#x7EC4;&#x7684;&#x603B;&#x5927;&#x5C0F;&#x3002;</p>
</blockquote>
<p>&#x6211;&#x4EEC;&#x5C06;&#x63A2;&#x7A76;&#x6267;&#x884C;&#x5668;&#x5982;&#x4F55;&#x5904;&#x7406;materialized nested loop join&#x7684;&#x8BA1;&#x5212;&#x6811;&#xFF0C;&#x4EE5;&#x53CA;&#x5982;&#x4F55;&#x4F7F;&#x7528;&#x4E0B;&#x9762;&#x663E;&#x793A;&#x7684;&#x7279;&#x5B9A;&#x793A;&#x4F8B;&#x4F30;&#x7B97;&#x6210;&#x672C;&#x3002;</p>
<pre><code class="lang-sql">testdb=# EXPLAIN SELECT * FROM tbl_a AS a, tbl_b AS b WHERE a.id = b.id;
                        QUERY PLAN                               
----------------------------------------------------------------------- 
Nested Loop  (cost=0.00..750230.50 rows=5000 width=16)   
    Join Filter: (a.id = b.id)   
    -&gt;  Seq Scan on tbl_a a  (cost=0.00..145.00 rows=10000 width=8)   
    -&gt;  Materialize  (cost=0.00..98.00 rows=5000 width=8)         
        -&gt;  Seq Scan on tbl_b b  (cost=0.00..73.00 rows=5000 width=8)
(5 rows)
</code></pre>
<p>&#x9996;&#x5148;&#xFF0C;&#x7ED9;&#x51FA;&#x4E86;&#x6267;&#x884C;&#x5668;&#x7684;&#x64CD;&#x4F5C;&#x3002;&#x6267;&#x884C;&#x5668;&#x6309;&#x4EE5;&#x4E0B;&#x65B9;&#x5F0F;&#x5904;&#x7406;&#x663E;&#x793A;&#x7684;&#x8BA1;&#x5212;&#x8282;&#x70B9;&#xFF1A; </p>
<ul>
<li><strong>&#x7B2C;7&#x884C;</strong>: &#x6267;&#x884C;&#x5668;&#x901A;&#x8FC7;&#x987A;&#x5E8F;&#x626B;&#x63CF;&#x7269;&#x5316;&#x7684;&#x5185;&#x8868;tbl_b(&#x7B2C;8&#x884C;)&#x3002;</li>
<li><strong>&#x7B2C;4&#x884C;</strong>: &#x6267;&#x884C;&#x5668;&#x6267;&#x884C;nested loop join&#x64CD;&#x4F5C;; &#x5916;&#x8868;&#x662F;tbl_a&#xFF0C;&#x5185;&#x8868;&#x662F;&#x7269;&#x5316;&#x7684;tbl_b&#x3002;</li>
</ul>
<p>&#x5728;&#x4E0B;&#x6587;&#x4E2D;&#xFF0C;&#x4F30;&#x8BA1;&#x2018;Materialize&#x2019;(&#x7B2C;7&#x884C;)&#x548C; &#x2018;Nested Loop&#x2019;(&#x7B2C;4&#x884C;)&#x7684;&#x6210;&#x672C;&#x3002; &#x5047;&#x8BBE;&#x7269;&#x5316;&#x7684;&#x5185;&#x90E8;&#x5143;&#x7EC4;&#x5B58;&#x50A8;&#x5728;work_mem&#x4E2D;&#x3002;</p>
<p><strong>Materialize:</strong></p>
<p>&#x6CA1;&#x6709;&#x542F;&#x52A8;&#x6210;&#x672C;&#xFF1B;&#x56E0;&#x6B64;&#xFF0C; </p>
<p>&#x200B;    &#x2018;start-up cost&#x2019; = 0.</p>
<p>&#x8FD0;&#x884C;&#x6210;&#x672C;&#x7531;&#x4EE5;&#x4E0B;&#x516C;&#x5F0F;&#x5B9A;&#x4E49;&#xFF1A; </p>
<p>&#x200B;    &#x2018;run cost&#x2019; = 2 &#xD7; cpu<em>operator_cost &#xD7; $N</em>{inner}$;</p>
<p>&#x56E0;&#x6B64;&#xFF0C;</p>
<p>&#x200B;    &#x2018;run cost&#x2019; = 2 &#xD7; 0.0025 &#xD7; 5000 = 25.0.</p>
<p>&#x53E6;&#x5916;&#xFF0C;</p>
<p>&#x200B;    &#x2018;total cost&#x2019; = (&#x2018;start-up cost&#x2019; + &#x2018;total cost of seq scan&#x2019;) + &#x2018;run cost&#x2019;;</p>
<p>&#x56E0;&#x6B64;&#xFF0C;</p>
<p>&#x200B;    &#x2018;total cost&#x2019; = (0.0 + 73.0) + 25.0 = 98.0.</p>
<p><strong>(Materialized) Nested Loop:</strong></p>
<p>&#x6CA1;&#x6709;&#x542F;&#x52A8;&#x6210;&#x672C;&#xFF1B;&#x56E0;&#x6B64;&#xFF0C;</p>
<p>&#x200B;    &#x2018;start-up cost&#x2019; = 0.</p>
<p>&#x5728;&#x4F30;&#x7B97;&#x8FD0;&#x884C;&#x6210;&#x672C;&#x4E4B;&#x524D;&#xFF0C;&#x6211;&#x4EEC;&#x8003;&#x8651;<em>&#x91CD;&#x65B0;&#x626B;&#x63CF;&#x6210;&#x672C;(rescan cost)</em>&#x3002; &#x8BE5;&#x6210;&#x672C;&#x7531;&#x4EE5;&#x4E0B;&#x7B49;&#x5F0F;&#x5B9A;&#x4E49;&#xFF1A;</p>
<p>&#x200B;    &#x2018;rescan cost&#x2019; = cpu<em>operator_cost &#xD7; $N</em>{inner}$.</p>
<p>&#x5728;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;</p>
<p>&#x200B;    &#x2018;rescan cost&#x2019; = (0.0025) &#xD7; 5000 = 12.5.</p>
<p>&#x8FD0;&#x884C;&#x6210;&#x672C;&#x7531;&#x4EE5;&#x4E0B;&#x7B49;&#x5F0F;&#x5B9A;&#x4E49;&#xFF1A;</p>
<p>&#x200B;    &#x2018;run cost&#x2019; = (cpu<em>operator_cost + cpu_tuple_cost) &#xD7; $N</em>{inner}$ &#xD7; $N_{outer}$</p>
<p>&#x200B;            + &#x2018;rescan cost&#x2019; &#xD7; ($N<em>{outer}$ &#x2212; 1) + $C^{total}</em>{outer,seqscan}$ + $C^{total}_{materialize}$,</p>
<p>&#x5176;&#x4E2D;$C^{total}<em>{outer,seqscan}$&#x662F;&#x5916;&#x8868;&#x7684;&#x603B;&#x626B;&#x63CF;&#x6210;&#x672C;&#xFF0C;$C^{total}</em>{materialize}$&#x662F;materialized&#x7684;&#x603B;&#x6210;&#x672C;; &#x56E0;&#x6B64;&#xFF0C;</p>
<p>&#x200B;    &#x2018;run cost&#x2019; = (0.0025 + 0.01) &#xD7; 5000 &#xD7; 10000 + 12.5 &#xD7; (10000 &#x2212; 1) + 145.0 + 98.0 = 750230.5.</p>
<h4 id="3513-indexed-nested-loop-join">3.5.1.3. Indexed Nested Loop Join</h4>
<p>&#x5982;&#x679C;&#x5B58;&#x5728;&#x5185;&#x8868;&#x7684;&#x7D22;&#x5F15;&#xFF0C;&#x5E76;&#x4E14;&#x8BE5;&#x7D22;&#x5F15;&#x53EF;&#x4EE5;&#x67E5;&#x627E;&#x6EE1;&#x8DB3;&#x8FDE;&#x63A5;&#x6761;&#x4EF6;&#x7684;&#x5143;&#x7EC4;&#x4EE5;&#x5339;&#x914D;&#x5916;&#x8868;&#x7684;&#x6BCF;&#x4E2A;&#x5143;&#x7EC4;&#xFF0C;&#x5219;&#x4F18;&#x5316;&#x5668;&#x8003;&#x8651;&#x4F7F;&#x7528;&#x8BE5;&#x7D22;&#x5F15;&#x76F4;&#x63A5;&#x641C;&#x7D22;&#x5185;&#x90E8;&#x5143;&#x7EC4;&#x800C;&#x4E0D;&#x662F;&#x987A;&#x5E8F;&#x626B;&#x63CF;&#x3002; &#x8FD9;&#x79CD;&#x53D8;&#x5316;&#x88AB;&#x79F0;&#x4E3A;<strong>indexed nested loop join</strong>; &#x53C2;&#x8003;&#x56FE;3.18&#x3002;&#x5C3D;&#x7BA1;&#x5B83;&#x63D0;&#x5230;&#x4E86;&#x7D22;&#x5F15;&#x5316;&#x7684;&#x2018;nested loop join&#x2019;&#xFF0C;&#x4F46;&#x8BE5;&#x7B97;&#x6CD5;&#x53EF;&#x4EE5;&#x57FA;&#x4E8E;&#x5916;&#x8868;&#x7684;&#x5355;&#x4E2A;&#x5FAA;&#x73AF;&#x8FDB;&#x884C;&#x5904;&#x7406;; &#x56E0;&#x6B64;&#xFF0C;&#x5B83;&#x53EF;&#x4EE5;&#x9AD8;&#x6548;&#x5730;&#x6267;&#x884C;&#x8FDE;&#x63A5;&#x64CD;&#x4F5C;&#x3002;</p>
<p><strong>&#x56FE;. 3.18. Indexed nested loop join.</strong></p>
<p><img src="https://github.com/yonj1e/The-Internals-of-PostgreSQL/blob/master/imgs/ch3/fig-3-18.png?raw=true" alt="Fig. 3.18. Indexed nested loop join."></p>
<p>&#x4E0B;&#x9762;&#x663E;&#x793A;&#x4E86;indexed nested loop join&#x7684;&#x5177;&#x4F53;&#x793A;&#x4F8B;&#x3002;</p>
<pre><code class="lang-sql">testdb=# EXPLAIN SELECT * FROM tbl_c AS c, tbl_b AS b WHERE c.id = b.id;
                            QUERY PLAN                                   
-------------------------------------------------------------------------------- 
Nested Loop  (cost=0.29..1935.50 rows=5000 width=16)   
    -&gt;  Seq Scan on tbl_b b (cost=0.00..73.00 rows=5000 width=8)   
    -&gt;  Index Scan using tbl_c_pkey on tbl_c c  (cost=0.29..0.36 rows=1 width=8)         
        Index Cond: (id = b.id)
(4 rows)
</code></pre>
<p>&#x5728;&#x7B2C;6&#x884C;&#x4E2D;&#xFF0C;&#x663E;&#x793A;&#x8BBF;&#x95EE;&#x5185;&#x8868;&#x7684;&#x5143;&#x7EC4;&#x7684;&#x6210;&#x672C;&#x3002; &#x5982;&#x679C;&#x5143;&#x7EC4;&#x6EE1;&#x8DB3;&#x7B2C;7&#x884C;&#x6240;&#x793A;&#x7684;&#x7D22;&#x5F15;&#x6761;&#x4EF6;(id = b.id)&#xFF0C;&#x8FD9;&#x5C31;&#x662F;&#x67E5;&#x627E;&#x5185;&#x8868;&#x7684;&#x6210;&#x672C;&#x3002;</p>
<p>&#x5728;&#x7B2C;7&#x884C;&#x7684;&#x7D22;&#x5F15;&#x6761;&#x4EF6;(id = b.id)&#x4E2D;&#xFF0C;&apos;b.id&apos;&#x662F;&#x8FDE;&#x63A5;&#x6761;&#x4EF6;&#x4E2D;&#x4F7F;&#x7528;&#x7684;&#x5916;&#x8868;&#x5C5E;&#x6027;&#x7684;&#x503C;&#x3002; &#x6BCF;&#x5F53;&#x901A;&#x8FC7;&#x987A;&#x5E8F;&#x626B;&#x63CF;&#x68C0;&#x7D22;&#x5916;&#x8868;&#x7684;&#x5143;&#x7EC4;&#x65F6;&#xFF0C;&#x7B2C;6&#x884C;&#x4E2D;&#x7684;&#x7D22;&#x5F15;&#x626B;&#x63CF;&#x8DEF;&#x5F84;&#x67E5;&#x627E;&#x8981;&#x8FDE;&#x63A5;&#x7684;&#x5185;&#x90E8;&#x5143;&#x7EC4;&#x3002; &#x6362;&#x53E5;&#x8BDD;&#x8BF4;&#xFF0C;&#x6BCF;&#x5F53;&#x5C06;&#x5916;&#x8868;&#x7684;&#x503C;&#x4F5C;&#x4E3A;&#x53C2;&#x6570;&#x4F20;&#x9012;&#x65F6;&#xFF0C;&#x6B64;&#x7D22;&#x5F15;&#x626B;&#x63CF;&#x8DEF;&#x5F84;&#x5C06;&#x67E5;&#x627E;&#x6EE1;&#x8DB3;&#x8FDE;&#x63A5;&#x6761;&#x4EF6;&#x7684;&#x5185;&#x90E8;&#x5143;&#x7EC4;&#x3002; &#x8FD9;&#x79CD;&#x7D22;&#x5F15;&#x8DEF;&#x5F84;&#x79F0;&#x4E3A;<strong>parameterized (index) path</strong>&#x3002; &#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#x5728;<a href="https://github.com/postgres/postgres/blob/master/src/backend/optimizer/README" target="_blank">README</a>&#x4E2D;&#x4ECB;&#x7ECD;&#x3002;</p>
<p>&#x6B64;nested loop join&#x7684;&#x542F;&#x52A8;&#x6210;&#x672C;&#x7B49;&#x4E8E;&#x7B2C;6&#x884C;&#x4E2D;&#x7D22;&#x5F15;&#x626B;&#x63CF;&#x7684;&#x6210;&#x672C;; &#x4ECE;&#x800C;&#xFF0C;</p>
<p>&#x200B;     &#x2018;start-up cost&#x2019; = 0.285.</p>
<p>indexed nested loop join &#x7684;&#x603B;&#x6210;&#x672C;&#x7531;&#x4EE5;&#x4E0B;&#x7B49;&#x5F0F;&#x5B9A;&#x4E49;</p>
<p>&#x200B;     &#x2018;total cost&#x2019; = (cpu<em>tuple_cost + $C^{total}</em>{inner,parameterized}$) &#xD7; ${N<em>{outer}}$ + ${C^{run}</em>{outer,seqscan}}$, </p>
<p>&#x5176;&#x4E2D;$C^{total}_{inner,parameterized}$&#x662F;parameterized inner index scan&#x7684;&#x603B;&#x6210;&#x672C;&#x3002;</p>
<p>&#x5728;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;</p>
<p>&#x200B;     &#x2018;total cost&#x2019; = (0.01 + 0.3625) &#xD7; 5000 + 73.0 = 1935.5, </p>
<p>&#x8FD0;&#x884C;&#x6210;&#x672C;&#x662F;</p>
<p>&#x200B;    &#x2018;run cost&#x2019; = 1935.5 &#x2212; 0.285 = 1935.215.</p>
<p>&#x7EFC;&#x4E0A;&#x6240;&#x8FF0;&#xFF0C;indexed nested loop join&#x7684;&#x603B;&#x6210;&#x672C;&#x4E3A;O(${N_{outer}}$)&#x3002;</p>
<h4 id="3514-&#x5176;&#x4ED6;&#x53D8;&#x4F53;">3.5.1.4. &#x5176;&#x4ED6;&#x53D8;&#x4F53;</h4>
<p>&#x5982;&#x679C;&#x5B58;&#x5728;&#x5916;&#x8868;&#x7684;&#x7D22;&#x5F15;&#x5E76;&#x4E14;&#x5B83;&#x7684;&#x5C5E;&#x6027;&#x53C2;&#x4E0E;&#x4E86;&#x8FDE;&#x63A5;&#x6761;&#x4EF6;&#xFF0C;&#x5219;&#x53EF;&#x4EE5;&#x5C06;&#x5176;&#x7528;&#x4E8E;&#x7D22;&#x5F15;&#x626B;&#x63CF;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x5916;&#x8868;&#x7684;&#x987A;&#x5E8F;&#x626B;&#x63CF;&#x3002; &#x7279;&#x522B;&#x662F;&#xFF0C;&#x5982;&#x679C;&#x5728;WHERE&#x5B50;&#x53E5;&#x4E2D;&#x6709;&#x4E00;&#x4E2A;&#x7D22;&#x5F15;&#x7684;&#x5C5E;&#x6027;&#x53EF;&#x4EE5;&#x662F;&#x8BBF;&#x95EE;&#x8C13;&#x8BCD;&#xFF0C;&#x5219;&#x4F1A;&#x7F29;&#x5C0F;&#x5916;&#x8868;&#x7684;&#x641C;&#x7D22;&#x8303;&#x56F4;; &#x56E0;&#x6B64;&#xFF0C;nested loop join&#x7684;&#x6210;&#x672C;&#x53EF;&#x80FD;&#x4F1A;&#x5927;&#x5927;&#x964D;&#x4F4E;&#x3002;</p>
<p>PostgreSQL&#x652F;&#x6301;&#x5E26;&#x5916;&#x90E8;&#x7D22;&#x5F15;&#x626B;&#x63CF;&#x7684;nested loop join&#x7684;&#x4E09;&#x79CD;&#x53D8;&#x4F53;&#x3002;&#x53C2;&#x8003;&#x56FE;&#x3002;3.19. </p>
<p><strong>&#x56FE;. 3.19. nested loop join&#x7684;&#x4E09;&#x79CD;&#x53D8;&#x4F53;&#x4E0E;&#x5916;&#x90E8;&#x7D22;&#x5F15;&#x626B;&#x63CF;</strong></p>
<p><img src="https://github.com/yonj1e/The-Internals-of-PostgreSQL/blob/master/imgs/ch3/fig-3-19.png?raw=true" alt="Fig. 3.19. The three variations of the nested loop join with an outer index scan."></p>
<p><a href="javascript:void(0" target="_blank">&#x8FD9;&#x91CC;</a>) &#x5C55;&#x793A;&#x8FD9;&#x4E9B;join&#x7684;EXPLAIN&#x7ED3;&#x679C;</p>
<h3 id="352-merge-join">3.5.2. Merge Join</h3>
<p>&#x4E0E;nested loop join&#x4E0D;&#x540C;&#xFF0C;merge join&#x53EA;&#x80FD;&#x7528;&#x4E8E;natural joins&#x548C;<a href="https://en.wikipedia.org/wiki/Join_(SQL" target="_blank">equi-joins.</a>#Equi-join)&#x3002;</p>
<p>merge join&#x7684;&#x5F00;&#x9500;&#x7531;initial_cost_mergejoin()&#x548C;final_cost_mergejoin()&#x51FD;&#x6570;&#x4F30;&#x7B97;&#x3002;</p>
<p>&#x7531;&#x4E8E;&#x786E;&#x5207;&#x7684;&#x6210;&#x672C;&#x4F30;&#x7B97;&#x6BD4;&#x8F83;&#x590D;&#x6742;&#xFF0C;&#x56E0;&#x6B64;&#x7701;&#x7565;&#x5B83;&#x4EC5;&#x663E;&#x793A;merge join&#x7B97;&#x6CD5;&#x7684;&#x8FD0;&#x884C;&#x65F6;&#x987A;&#x5E8F;&#x3002;meger join &#x7684;&#x542F;&#x52A8;&#x6210;&#x672C;&#x662F;&#x5185;&#x8868;&#x548C;&#x5916;&#x8868;&#x7684;&#x6392;&#x5E8F;&#x6210;&#x672C;&#x7684;&#x603B;&#x548C;; ($N<em>{outer}$$log</em>{2}$($N<em>{outer}$) + $N</em>{inner}$$log<em>{2}$($N</em>{inner}$))&#xFF0C;&#x5176;&#x4E2D;$N<em>{outer}$&#x548C;$N</em>{inner}$&#x5206;&#x522B;&#x662F;&#x5916;&#x8868;&#x548C;&#x5185;&#x8868;&#x7684;&#x5143;&#x7EC4;&#x6570; &#x3002; &#x8FD0;&#x884C;&#x6210;&#x672C;&#x662F;O($N<em>{outer}$r +  $N</em>{inner}$)&#x3002;</p>
<p>&#x4E0E;nested loop join&#x7C7B;&#x4F3C;&#xFF0C;PostgreSQL&#x4E2D;&#x7684;merge join&#x6709;&#x56DB;&#x79CD;&#x53D8;&#x4F53;&#x3002;</p>
<h4 id="3521-merge-join">3.5.2.1. Merge Join</h4>
<p>&#x56FE; 3.20 &#x663E;&#x793A;&#x4E86;merge join&#x7684;&#x6982;&#x5FF5;&#x56FE;&#x3002;</p>
<p><strong>&#x56FE;. 3.20. Merge join.</strong></p>
<p><img src="https://github.com/yonj1e/The-Internals-of-PostgreSQL/blob/master/imgs/ch3/fig-3-20.png?raw=true" alt="Fig. 3.20. Merge join."></p>
<p>&#x5982;&#x679C;&#x6240;&#x6709;&#x5143;&#x7EC4;&#x90FD;&#x53EF;&#x4EE5;&#x5B58;&#x50A8;&#x5728;&#x5185;&#x5B58;&#x4E2D;&#xFF0C;&#x5219;&#x6392;&#x5E8F;&#x64CD;&#x4F5C;&#x5C06;&#x80FD;&#x591F;&#x5728;&#x5185;&#x5B58;&#x4E2D;&#x6267;&#x884C;; &#x5426;&#x5219;&#xFF0C;&#x4F7F;&#x7528;&#x4E34;&#x65F6;&#x6587;&#x4EF6;&#x3002;</p>
<p>&#x4E0B;&#x9762;&#x7ED9;&#x51FA;merge join &#x7684;EXPLAIN&#x547D;&#x4EE4;&#x7684;&#x7ED3;&#x679C;&#x7684;&#x4E00;&#x4E2A;&#x5177;&#x4F53;&#x793A;&#x4F8B;&#x3002;</p>
<p>merge join &#x7684;EXPLAIN&#x547D;&#x4EE4;&#x7ED3;&#x679C;&#x5982;&#x4E0B;&#x3002; </p>
<pre><code class="lang-sql">testdb=# <span class="hljs-keyword">EXPLAIN</span> <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> tbl_a <span class="hljs-keyword">AS</span> a, tbl_b <span class="hljs-keyword">AS</span> b <span class="hljs-keyword">WHERE</span> a.<span class="hljs-keyword">id</span> = b.<span class="hljs-keyword">id</span> <span class="hljs-keyword">AND</span> b.<span class="hljs-keyword">id</span> &lt; <span class="hljs-number">1000</span>;
                            QUERY PLAN
<span class="hljs-comment">------------------------------------------------------------------------- </span>
<span class="hljs-keyword">Merge</span> <span class="hljs-keyword">Join</span>  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">944.71</span>.<span class="hljs-number">.984</span><span class="hljs-number">.71</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">1000</span> width=<span class="hljs-number">16</span>)   
    <span class="hljs-keyword">Merge</span> Cond: (a.<span class="hljs-keyword">id</span> = b.<span class="hljs-keyword">id</span>)   
    -&gt;  <span class="hljs-keyword">Sort</span>  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">809.39</span>.<span class="hljs-number">.834</span><span class="hljs-number">.39</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">10000</span> width=<span class="hljs-number">8</span>)         
        <span class="hljs-keyword">Sort</span> <span class="hljs-keyword">Key</span>: a.<span class="hljs-keyword">id</span>         
        -&gt;  Seq <span class="hljs-keyword">Scan</span> <span class="hljs-keyword">on</span> tbl_a a  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">0.00</span>.<span class="hljs-number">.145</span><span class="hljs-number">.00</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">10000</span> width=<span class="hljs-number">8</span>)   
    -&gt;  <span class="hljs-keyword">Sort</span>  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">135.33</span>.<span class="hljs-number">.137</span><span class="hljs-number">.83</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">1000</span> width=<span class="hljs-number">8</span>)         
        <span class="hljs-keyword">Sort</span> <span class="hljs-keyword">Key</span>: b.<span class="hljs-keyword">id</span>         
        -&gt;  Seq <span class="hljs-keyword">Scan</span> <span class="hljs-keyword">on</span> tbl_b b  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">0.00</span>.<span class="hljs-number">.85</span><span class="hljs-number">.50</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">1000</span> width=<span class="hljs-number">8</span>)               
            Filter: (<span class="hljs-keyword">id</span> &lt; <span class="hljs-number">1000</span>)
(<span class="hljs-number">9</span> <span class="hljs-keyword">rows</span>)
</code></pre>
<ul>
<li><strong>&#x7B2C;9&#x884C;</strong>: &#x6267;&#x884C;&#x5668;&#x4F7F;&#x7528;&#x987A;&#x5E8F;&#x626B;&#x63CF;&#x5BF9;&#x5185;&#x8868;tbl_b&#x8FDB;&#x884C;&#x6392;&#x5E8F;(&#x7B2C;11&#x884C;)&#x3002; </li>
<li><strong>&#x7B2C;6&#x884C;</strong>: &#x6267;&#x884C;&#x5668;&#x4F7F;&#x7528;&#x987A;&#x5E8F;&#x626B;&#x63CF;&#x5BF9;&#x5916;&#x8868;tbl_a&#x8FDB;&#x884C;&#x6392;&#x5E8F;(&#x7B2C;8&#x884C;)&#x3002; </li>
<li><strong>&#x7B2C;4&#x884C;</strong>: &#x6267;&#x884C;&#x5668;&#x6267;&#x884C;meger join&#x64CD;&#x4F5C;; &#x5916;&#x8868;&#x662F;&#x6392;&#x5E8F;&#x7684;tbl_a&#xFF0C;&#x5185;&#x8868;&#x662F;&#x6392;&#x5E8F;&#x7684;tbl_b&#x3002;</li>
</ul>
<h4 id="3522-materialized-merge-join">3.5.2.2. Materialized Merge Join</h4>
<p>&#x4E0E;nested loop join&#x76F8;&#x540C;&#xFF0C;merge join&#x4E5F;&#x652F;&#x6301;materialized merge join &#x7269;&#x5316;&#x5185;&#x8868;&#xFF0C;&#x4EE5;&#x4F7F;&#x5185;&#x8868;&#x626B;&#x63CF;&#x66F4;&#x9AD8;&#x6548;&#x3002;</p>
<p><strong>&#x56FE;. 3.21. Materialized merge join.</strong></p>
<p><img src="https://github.com/yonj1e/The-Internals-of-PostgreSQL/blob/master/imgs/ch3/fig-3-21.png?raw=true" alt="Fig. 3.21. Materialized merge join."></p>
<p>materialized merge join&#x793A;&#x4F8B;&#x5982;&#x4E0B;&#x3002;&#x5F88;&#x5BB9;&#x6613;&#x53D1;&#x73B0;&#xFF0C;&#x4E0E;&#x4E0A;&#x9762;&#x7684;merge join&#x7ED3;&#x679C;&#x7684;&#x4E0D;&#x540C;&#x4E4B;&#x5904;&#x5728;&#x4E8E;&#x7B2C;9&#x884C;&#xFF1A;&#x2018;Materialize&#x2019;&#x3002;</p>
<pre><code class="lang-sql">testdb=# <span class="hljs-keyword">EXPLAIN</span> <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> tbl_a <span class="hljs-keyword">AS</span> a, tbl_b <span class="hljs-keyword">AS</span> b <span class="hljs-keyword">WHERE</span> a.<span class="hljs-keyword">id</span> = b.<span class="hljs-keyword">id</span>;
QUERY PLAN                                     
<span class="hljs-comment">----------------------------------------------------------------------------------- </span>
<span class="hljs-keyword">Merge</span> <span class="hljs-keyword">Join</span>  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">10466.08</span>.<span class="hljs-number">.10578</span><span class="hljs-number">.58</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">5000</span> width=<span class="hljs-number">2064</span>)   
    <span class="hljs-keyword">Merge</span> Cond: (a.<span class="hljs-keyword">id</span> = b.<span class="hljs-keyword">id</span>)   
    -&gt;  <span class="hljs-keyword">Sort</span>  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">6708.39</span>.<span class="hljs-number">.6733</span><span class="hljs-number">.39</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">10000</span> width=<span class="hljs-number">1032</span>)         
        <span class="hljs-keyword">Sort</span> <span class="hljs-keyword">Key</span>: a.<span class="hljs-keyword">id</span>         
        -&gt;  Seq <span class="hljs-keyword">Scan</span> <span class="hljs-keyword">on</span> tbl_a a  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">0.00</span>.<span class="hljs-number">.1529</span><span class="hljs-number">.00</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">10000</span> width=<span class="hljs-number">1032</span>)   
    -&gt;  Materialize  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">3757.69</span>.<span class="hljs-number">.3782</span><span class="hljs-number">.69</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">5000</span> width=<span class="hljs-number">1032</span>)         
        -&gt;  <span class="hljs-keyword">Sort</span>  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">3757.69</span>.<span class="hljs-number">.3770</span><span class="hljs-number">.19</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">5000</span> width=<span class="hljs-number">1032</span>)               
            <span class="hljs-keyword">Sort</span> <span class="hljs-keyword">Key</span>: b.<span class="hljs-keyword">id</span>               
            -&gt;  Seq <span class="hljs-keyword">Scan</span> <span class="hljs-keyword">on</span> tbl_b b  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">0.00</span>.<span class="hljs-number">.1193</span><span class="hljs-number">.00</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">5000</span> width=<span class="hljs-number">1032</span>)
(<span class="hljs-number">9</span> <span class="hljs-keyword">rows</span>)
</code></pre>
<ul>
<li><strong>&#x7B2C;10&#x884C;</strong>: &#x6267;&#x884C;&#x5668;&#x4F7F;&#x7528;&#x987A;&#x5E8F;&#x626B;&#x63CF;&#x5BF9;&#x5185;&#x8868;tbl_b&#x8FDB;&#x884C;&#x6392;&#x5E8F;(&#x7B2C;12&#x884C;)&#x3002;</li>
<li><strong>&#x7B2C;9&#x884C;</strong>: &#x6267;&#x884C;&#x5668;&#x7269;&#x5316;&#x6392;&#x5E8F;&#x540E;&#x7684;&#x8868;tbl_b&#x7684;&#x7ED3;&#x679C;&#x3002;</li>
<li><strong>&#x7B2C;6&#x884C;</strong>: &#x6267;&#x884C;&#x5668;&#x4F7F;&#x7528;&#x987A;&#x5E8F;&#x626B;&#x63CF;&#x5BF9;&#x5916;&#x8868;tbl_a&#x8FDB;&#x884C;&#x6392;&#x5E8F;(&#x7B2C;8&#x884C;)&#x3002;</li>
<li><strong>&#x7B2C;4&#x884C;</strong>: &#x6267;&#x884C;&#x5668;&#x6267;&#x884C;merge join&#x64CD;&#x4F5C;; &#x5916;&#x8868;&#x662F;&#x6392;&#x5E8F;&#x540E;&#x7684;tbl_a&#xFF0C;&#x5185;&#x8868;&#x662F;&#x7269;&#x5316;&#x6392;&#x5E8F;&#x7684;tbl_b&#x3002;</li>
</ul>
<h4 id="3523-&#x5176;&#x4ED6;&#x53D8;&#x4F53;">3.5.2.3. &#x5176;&#x4ED6;&#x53D8;&#x4F53;</h4>
<p>&#x4E0E;nested loop join&#x7C7B;&#x4F3C;&#xFF0C;PostgreSQL&#x4E2D;&#x7684;merge&#x4E5F;&#x6709;&#x5404;&#x79CD;&#x53D8;&#x4F53;&#xFF0C;&#x53EF;&#x4EE5;&#x6839;&#x636E;&#x8FD9;&#x4E9B;&#x53D8;&#x4F53;&#x6267;&#x884C;&#x5916;&#x8868;&#x7684;&#x7D22;&#x5F15;&#x626B;&#x63CF;&#x3002; </p>
<p>&#x56FE;. 3.22. merge join&#x7684;&#x4E09;&#x4E2A;&#x53D8;&#x4F53;&#x4E0E;&#x5916;&#x90E8;&#x7D22;&#x5F15;&#x626B;&#x63CF; </p>
<p><img src="https://github.com/yonj1e/The-Internals-of-PostgreSQL/blob/master/imgs/ch3/fig-3-22.png?raw=true" alt="Fig. 3.22. The three variations of the merge join with an outer index scan."></p>
<p><a href="javascript:void(0" target="_blank">&#x8FD9;&#x91CC;</a>) &#x5C55;&#x793A;&#x8FD9;&#x4E9B;join&#x7684;EXPLAIN&#x7ED3;&#x679C;</p>
<h3 id="353-hash-join">3.5.3. Hash Join</h3>
<p>&#x4E0E;merge join&#x7C7B;&#x4F3C;&#xFF0C;hash join&#x53EA;&#x80FD;&#x7528;&#x4E8E;natural joins&#x548C;equi-joins&#x3002;</p>
<p>PostgreSQL&#x4E2D;&#x7684;hash join&#x6839;&#x636E;&#x8868;&#x7684;&#x5927;&#x5C0F;&#x800C;&#x6709;&#x6240;&#x4E0D;&#x540C;&#x3002; &#x5982;&#x679C;&#x76EE;&#x6807;&#x8868;&#x8DB3;&#x591F;&#x5C0F;(&#x66F4;&#x786E;&#x5207;&#x5730;&#x8BF4;&#xFF0C;&#x5185;&#x8868;&#x7684;&#x5927;&#x5C0F;&#x662F;work_mem&#x7684;25&#xFF05;&#x6216;&#x66F4;&#x5C11;)&#xFF0C;&#x5B83;&#x5C06;&#x662F;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x4E24;&#x9636;&#x6BB5;&#x5185;&#x5B58;&#x4E2D;hash join; &#x5426;&#x5219;&#xFF0C;&#x4F7F;&#x7528;hybrid hash join with the skew&#x65B9;&#x6CD5;&#x3002;</p>
<p>&#x5728;&#x672C;&#x5C0F;&#x8282;&#x4E2D;&#xFF0C;&#x63CF;&#x8FF0;&#x4E86;PostgreSQL&#x4E2D;&#x4E24;&#x79CD;hash join&#x7684;&#x6267;&#x884C;&#x65B9;&#x5F0F;&#x3002;</p>
<p>&#x7531;&#x4E8E;&#x6210;&#x672C;&#x4F30;&#x7B97;&#x7684;&#x590D;&#x6742;&#x6027;&#xFF0C;&#x5BF9;&#x6210;&#x672C;&#x4F30;&#x7B97;&#x7684;&#x8BA8;&#x8BBA;&#x88AB;&#x5FFD;&#x7565;&#x4E86;&#x3002;&#x7C97;&#x7565;&#x5730;&#x8BF4;&#xFF0C;&#x5982;&#x679C;&#x5728;&#x641C;&#x7D22;&#x548C;&#x63D2;&#x5165;&#x54C8;&#x5E0C;&#x8868;&#x65F6;&#x6CA1;&#x6709;&#x51B2;&#x7A81;&#xFF0C;&#x5219;&#x542F;&#x52A8;&#x548C;&#x8FD0;&#x884C;&#x6210;&#x672C;&#x662F;O($N<em>{outer}$+$N</em>{inner}$)&#x3002; </p>
<h4 id="3531-in-memory-hash-join">3.5.3.1. In-Memory Hash Join</h4>
<p>&#x5728;&#x672C;&#x5C0F;&#x8282;&#x4E2D;&#xFF0C;&#x5C06;&#x63CF;&#x8FF0;in-memory hash join&#x3002; </p>
<p>in-memory hash join&#x662F;&#x5728;work_mem&#x4E0A;&#x5904;&#x7406;&#x7684;&#xFF0C;&#x5728;PostgreSQL&#x4E2D;&#xFF0C;&#x54C8;&#x5E0C;&#x8868;&#x533A;&#x57DF;&#x79F0;&#x4E3A;<strong>batch</strong>&#x3002;batch&#x6709;&#x6563;&#x5217;&#x69FD;&#xFF0C;&#x79F0;&#x4E3A;<strong>buckets</strong>&#xFF0C;&#x6876;&#x7684;&#x6570;&#x91CF;&#x7531;<a href="https://github.com/postgres/postgres/blob/master/src/backend/executor/nodeHash.c" target="_blank">nodeHash.c</a>;&#x4E2D;&#x5B9A;&#x4E49;&#x7684;ExecChooseHashTableSize()&#x51FD;&#x6570;&#x51B3;&#x5B9A;&#xFF1B;&#x6876;&#x7684;&#x6570;&#x91CF;&#x603B;&#x662F;$2^{n}$&#xFF0C;&#x5176;&#x4E2D;$n$&#x662F;&#x6574;&#x6570;&#x3002; </p>
<p>in-memory hash join&#x6709;&#x4E24;&#x4E2A;&#x9636;&#x6BB5;&#xFF1A;<strong>build</strong>&#x9636;&#x6BB5;&#x548C;<strong>probe</strong>&#x9636;&#x6BB5;&#x3002; &#x5728;build&#x9636;&#x6BB5;&#xFF0C;&#x5185;&#x8868;&#x7684;&#x6240;&#x6709;&#x5143;&#x7EC4;&#x90FD;&#x88AB;&#x63D2;&#x5165;batch; &#x5728;probe&#x9636;&#x6BB5;&#xFF0C;&#x5C06;&#x5916;&#x8868;&#x7684;&#x6BCF;&#x4E2A;&#x5143;&#x7EC4;&#x4E0E;batch&#x4E2D;&#x7684;&#x5185;&#x90E8;&#x5143;&#x7EC4;&#x8FDB;&#x884C;&#x6BD4;&#x8F83;&#xFF0C;&#x5982;&#x679C;&#x8FDE;&#x63A5;&#x6761;&#x4EF6;&#x6EE1;&#x8DB3;&#xFF0C;&#x5219;&#x5C06;&#x5176;&#x8FDE;&#x63A5;&#x3002; </p>
<p>&#x4E3E;&#x4F8B;&#x63CF;&#x8FF0;&#x8FD9;&#x4E2A;&#x64CD;&#x4F5C;&#x3002; &#x5047;&#x8BBE;&#x4E0B;&#x9762;&#x663E;&#x793A;&#x7684;&#x67E5;&#x8BE2;&#x662F;&#x4F7F;&#x7528;hash join&#x6267;&#x884C;&#x7684;&#x3002;</p>
<pre><code class="lang-sql">testdb=# <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> tbl_outer <span class="hljs-keyword">AS</span> <span class="hljs-keyword">outer</span>, tbl_inner <span class="hljs-keyword">AS</span> <span class="hljs-keyword">inner</span> <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">inner</span>.attr1 = <span class="hljs-keyword">outer</span>.attr2;
</code></pre>
<p>&#x4E0B;&#x9762;&#x663E;&#x793A;hash join&#x7684;&#x64CD;&#x4F5C;&#x3002;&#x53C2;&#x8003;&#x56FE;3.23&#x548C;3.24&#x3002; </p>
<p><strong>&#x56FE;. 3.23. in-memory hash join&#x7684;build&#x9636;&#x6BB5;</strong></p>
<p><img src="https://github.com/yonj1e/The-Internals-of-PostgreSQL/blob/master/imgs/ch3/fig-3-23.png?raw=true" alt="Fig. 3.23. The build phase in the in-memory hash join."></p>
<p>(1) &#x5728;work_mem&#x4E0A;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;batch&#x3002;</p>
<p>&#x200B;    &#x5728;&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x4E2D;&#xFF0C;&#x8BE5;batch&#x6709;&#x516B;&#x4E2A;&#x6876;; &#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#xFF0C;&#x6876;&#x7684;&#x6570;&#x91CF;&#x662F;$2^{3}$&#x6B21;&#x65B9;&#x3002;</p>
<p>(2) &#x5C06;&#x5185;&#x8868;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7EC4;&#x63D2;&#x5165;batch&#x7684;&#x76F8;&#x5E94;&#x5B58;&#x50A8;&#x6876;&#x4E2D;&#x3002;</p>
<p>  &#x8BE6;&#x60C5;&#x5982;&#x4E0B;&#xFF1A;</p>
<ol>
<li><p>&#x8BA1;&#x7B97;&#x8FDE;&#x63A5;&#x6761;&#x4EF6;&#x4E2D;&#x6D89;&#x53CA;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7EC4;&#x5C5E;&#x6027;&#x7684;hash-key&#x3002; </p>
<p>&#x5728;&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x4E2D;&#xFF0C;&#x7531;&#x4E8E;WHERE&#x5B50;&#x53E5;&#x662F;&apos;inner.attr1 = outer.attr2&apos;&#xFF0C;&#x56E0;&#x6B64;&#x4F7F;&#x7528;&#x5185;&#x7F6E;hash&#x51FD;&#x6570;&#x8BA1;&#x7B97;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7EC4;&#x7684;&#x5C5E;&#x6027;&apos;attr1&apos;&#x7684;hash-key&#x3002;</p>
</li>
<li><p>&#x5C06;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7EC4;&#x63D2;&#x5165;&#x5230;&#x76F8;&#x5E94;&#x7684;&#x5B58;&#x50A8;&#x6876;&#x4E2D;&#x3002;</p>
<p>&#x5047;&#x8BBE;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7EC4;&#x7684;hash-key&#x7531;&#x4E8C;&#x8FDB;&#x5236;&#x8868;&#x793A;&#x6CD5;&#x4E3A;&apos;0x000 ... 001&apos;; &#x5373;&#x6700;&#x540E;&#x4E09;&#x4F4D;&#x662F;&apos;001&apos;&#x3002; &#x5728;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x8BE5;&#x5143;&#x7EC4;&#x88AB;&#x63D2;&#x5165;&#x5230;key&#x4E3A;&apos;001&apos;&#x7684;&#x6876;&#x4E2D;&#x3002;</p>
<p>&#x5728;&#x6B64;&#x6587;&#x6863;&#x4E2D;&#xFF0C;&#x6784;&#x5EFA;batch&#x7684;&#x8FD9;&#x79CD;&#x63D2;&#x5165;&#x64CD;&#x4F5C;&#x7531;&#x4EE5;&#x4E0B;&#x8FD0;&#x7B97;&#x7B26;&#x8868;&#x793A;&#xFF1A; $&#x2295;$</p>
</li>
</ol>
<p>(3) &#x63D2;&#x5165;&#x5185;&#x8868;&#x7684;&#x5176;&#x4F59;&#x5143;&#x7EC4;&#x3002;</p>
<p><strong>&#x56FE;. 3.24. in-memory hash join&#x7684;probe&#x9636;&#x6BB5;</strong></p>
<p><img src="https://github.com/yonj1e/The-Internals-of-PostgreSQL/blob/master/imgs/ch3/fig-3-24.png?raw=true" alt="Fig. 3.24. The probe phase in the in-memory hash join."></p>
<p>(4) Probe&#x5916;&#x8868;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7EC4;</p>
<p>   &#x8BE6;&#x60C5;&#x5982;&#x4E0B;&#xFF1A;</p>
<ol>
<li><p>&#x8BA1;&#x7B97;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7EC4;&#x5C5E;&#x6027;&#x7684;hash-key&#xFF0C;&#x8BE5;&#x5C5E;&#x6027;&#x6D89;&#x53CA;&#x5230;&#x5916;&#x8868;&#x7684;&#x8FDE;&#x63A5;&#x6761;&#x4EF6;&#x3002; </p>
<p>&#x5728;&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x4E2D;&#xFF0C;&#x5047;&#x8BBE;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7EC4;&#x5C5E;&#x6027;&apos;attr2&apos;&#x7684;hash-key&#x662F;&apos;0x000 ... 100&apos;; &#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#xFF0C;&#x6700;&#x540E;&#x4E09;&#x4F4D;&#x662F;&apos;100&apos;&#x3002;</p>
</li>
<li><p>&#x5C06;&#x5916;&#x8868;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7EC4;&#x4E0E;batch&#x4E2D;&#x7684;&#x5185;&#x90E8;&#x5143;&#x7EC4;&#x8FDB;&#x884C;&#x6BD4;&#x8F83;&#xFF0C;&#x5982;&#x679C;&#x6EE1;&#x8DB3;&#x8FDE;&#x63A5;&#x6761;&#x4EF6;&#xFF0C;&#x5219;&#x5C06;&#x5176;&#x4E0E;&#x8FDE;&#x63A5;&#x5143;&#x7EC4;&#x8FDB;&#x884C;&#x6BD4;&#x8F83;&#x3002; </p>
<p>&#x56E0;&#x4E3A;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7EC4;&#x7684;hash-key&#x7684;&#x6700;&#x540E;&#x4E09;&#x4F4D;&#x662F;&#x201C;100&#x201D;&#xFF0C;&#x6240;&#x4EE5;&#x6267;&#x884C;&#x5668;&#x68C0;&#x7D22;key&#x4E3A;&#x201C;100&#x201D;&#x7684;&#x6876;&#x7684;&#x5143;&#x7EC4;&#xFF0C;&#x5E76;&#x6BD4;&#x8F83;&#x8FDE;&#x63A5;&#x6761;&#x4EF6;(&#x7531;WHERE&#x5B50;&#x53E5;&#x5B9A;&#x4E49;)&#x6307;&#x5B9A;&#x7684;&#x8868;&#x7684;&#x5404;&#x81EA;&#x5C5E;&#x6027;&#x503C;&#x3002; </p>
<p>&#x5982;&#x679C;&#x6EE1;&#x8DB3;&#x8FDE;&#x63A5;&#x6761;&#x4EF6;&#xFF0C;&#x5219;&#x5916;&#x8868;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7EC4;&#x548C;&#x5185;&#x8868;&#x7684;&#x76F8;&#x5E94;&#x5143;&#x7EC4;&#x5C06;&#x88AB;&#x8FDE;&#x63A5;&#xFF1B;&#x5426;&#x5219;&#xFF0C;&#x6267;&#x884C;&#x5668;&#x5C06;&#x4E0D;&#x6267;&#x884C;&#x4EFB;&#x4F55;&#x64CD;&#x4F5C;&#x3002; </p>
<p>&#x5728;&#x672C;&#x4F8B;&#x4E2D;&#xFF0C;key&#x4E3A;&apos;100&apos;&#x7684;&#x6876;&#x6709;Tuple_C&#x3002; &#x5982;&#x679C;Tuple_C&#x7684;attr1&#x7B49;&#x4E8E;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7EC4;(Tuple_W)&#x7684;attr2&#xFF0C;&#x5219;Tuple_C&#x548C;Tuple_W&#x5C06;&#x88AB;&#x8FDE;&#x63A5;&#x5E76;&#x4FDD;&#x5B58;&#x5230;&#x5185;&#x5B58;&#x6216;&#x4E34;&#x65F6;&#x6587;&#x4EF6;&#x4E2D;&#x3002;</p>
<p>&#x5728;&#x8FD9;&#x4E2A;&#x6587;&#x6863;&#x4E2D;&#xFF0C;&#x6784;&#x5EFA;batch&#x7684;&#x8FD9;&#x79CD;&#x63D2;&#x5165;&#x64CD;&#x4F5C;&#x7531;&#x4EE5;&#x4E0B;&#x8FD0;&#x7B97;&#x7B26;&#x8868;&#x793A;&#xFF1A;$&#x2297;$</p>
</li>
</ol>
<p>(5) Probe &#x5916;&#x8868;&#x7684;&#x5176;&#x4F59;&#x5143;&#x7EC4;&#x3002;</p>
<h4 id="3532-hybrid-hash-join-with-skew">3.5.3.2. Hybrid Hash Join with Skew</h4>
<p>&#x5F53;&#x5185;&#x8868;&#x7684;&#x5143;&#x7EC4;&#x65E0;&#x6CD5;&#x5B58;&#x50A8;&#x5230;work_mem&#x4E2D;&#x7684;&#x4E00;&#x4E2A;batch&#x4E2D;&#x65F6;&#xFF0C;PostgreSQL&#x5C06;&#x4F7F;&#x7528;hybrid hash join with skew&#xFF0C;&#x8FD9;&#x662F;&#x4E00;&#x79CD;&#x57FA;&#x4E8E;hybrid hash join&#x7684;&#x53D8;&#x4F53;&#x3002;</p>
<p>&#x9996;&#x5148;&#x4ECB;&#x7ECD;&#x4E86;hybrid hash join&#x7684;&#x57FA;&#x672C;&#x6982;&#x5FF5;&#x3002;&#x5728;&#x7B2C;&#x4E00;&#x4E2A;build&#x548C;probe&#x9636;&#x6BB5;&#xFF0C;PostgreSQL&#x51C6;&#x5907;&#x591A;&#x4E2A;batch&#x3002;batch&#x6570;&#x76EE;&#x4E0E;&#x7531;ExecChooseHashTableSize()&#x51FD;&#x6570;&#x786E;&#x5B9A;&#x7684;&#x6876;&#x6570;&#x76F8;&#x540C;&#xFF1B;&#x5B83;&#x603B;&#x662F;$2_{m}$&#xFF0C;&#x5176;&#x4E2D;$m$&#x662F;&#x6574;&#x6570;&#x3002;&#x5728;&#x6B64;&#x9636;&#x6BB5;&#xFF0C;&#x5728;work_mem&#x4E2D;&#x53EA;&#x5206;&#x914D;&#x4E00;&#x4E2A;batch&#xFF0C;&#x800C;&#x5176;&#x4ED6;batch&#x4F5C;&#x4E3A;&#x4E34;&#x65F6;&#x6587;&#x4EF6;&#x521B;&#x5EFA;&#xFF1B;&#x5C5E;&#x4E8E;&#x8FD9;&#x4E9B;batch&#x7684;&#x5143;&#x7EC4;&#x88AB;&#x5199;&#x5165;&#x76F8;&#x5E94;&#x7684;&#x6587;&#x4EF6;&#xFF0C;&#x5E76;&#x4F7F;&#x7528;&#x4E34;&#x65F6;&#x5143;&#x7EC4;&#x5B58;&#x50A8;&#x529F;&#x80FD;&#x4FDD;&#x5B58;&#x3002; </p>
<p>&#x56FE;3.25&#x8BF4;&#x660E;&#x4E86;&#x5143;&#x7EC4;&#x662F;&#x5982;&#x4F55;&#x5B58;&#x50A8;&#x5728;&#x56DB;&#x4E2A;(=2222)batch&#x4E2D;&#x7684;&#x3002;&#x5728;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5B58;&#x50A8;&#x6BCF;&#x4E2A;&#x5143;&#x7EC4;&#x7684;batch&#x7531;&#x5143;&#x7EC4;hash-key&#x6700;&#x540E;5&#x4F4D;&#x7684;&#x524D;&#x4E24;&#x4F4D;&#x51B3;&#x5B9A;&#xFF0C;&#x56E0;&#x4E3A;&#x6876;&#x548C;batch&#x7684;&#x5927;&#x5C0F;&#x5206;&#x522B;&#x4E3A;2323&#x548C;2222&#x3002;Batch_0&#x5B58;&#x50A8;hash-key&#x7684;&#x6700;&#x540E;5&#x4F4D;&#x4ECB;&#x4E8E;&#x2018;00000&#x2019;&#x548C;&#x2018;00111&#x2019;&#x4E4B;&#x95F4;&#x7684;&#x5143;&#x7EC4;&#xFF0C;Batch_1&#x5B58;&#x50A8;hash-key&#x7684;&#x6700;&#x540E;5&#x4F4D;&#x5728;&#x2018;01000&#x2019;&#x548C;&#x2018;01111&#x2019;&#x4E4B;&#x95F4;&#x7684;&#x5143;&#x7EC4;&#xFF0C;&#x4EE5;&#x6B64;&#x7C7B;&#x63A8;&#x3002; </p>
<p><strong>&#x56FE;. 3.25. hybrid hash join&#x4E2D;&#x591A;&#x4E2A;batch</strong></p>
<p><img src="https://github.com/yonj1e/The-Internals-of-PostgreSQL/blob/master/imgs/ch3/fig-3-25.png?raw=true" alt="Fig. 3.25. Multiple batches in hybrid hash join."></p>
<p>&#x5728;hybrid hash join&#x4E2D;&#xFF0C;build&#x548C;probe&#x9636;&#x6BB5;&#x7684;&#x6267;&#x884C;&#x6B21;&#x6570;&#x4E0E;batch&#x6570;&#x76F8;&#x540C;&#xFF0C;&#x56E0;&#x4E3A;&#x5185;&#x8868;&#x548C;&#x5916;&#x8868;&#x5B58;&#x50A8;&#x5728;&#x76F8;&#x540C;&#x6570;&#x91CF;&#x7684;batch&#x4E2D;&#x3002;&#x5728;&#x7B2C;&#x4E00;&#x8F6E;build&#x548C;probe&#x9636;&#x6BB5;&#xFF0C;&#x4E0D;&#x4EC5;&#x521B;&#x5EFA;&#x4E86;&#x6BCF;&#x4E2A;batch&#xFF0C;&#x800C;&#x4E14;&#x8FD8;&#x5904;&#x7406;&#x4E86;&#x7B2C;&#x4E00;&#x6279;&#x5185;&#x8868;&#x548C;&#x5916;&#x8868;&#x3002;&#x53E6;&#x4E00;&#x65B9;&#x9762;&#xFF0C;&#x7B2C;&#x4E8C;&#x8F6E;&#x548C;&#x540E;&#x7EED;&#x5404;&#x8F6E;&#x7684;&#x5904;&#x7406;&#x9700;&#x8981;&#x5199;&#x5165;&#x4E34;&#x65F6;&#x6587;&#x4EF6;&#x5E76;&#x4ECE;&#x4E34;&#x65F6;&#x6587;&#x4EF6;&#x4E2D;&#x91CD;&#x65B0;&#x52A0;&#x8F7D; &#xFF0C;&#x6240;&#x4EE5;&#x8FD9;&#x4E9B;&#x8FC7;&#x7A0B;&#x6210;&#x672C;&#x5F88;&#x9AD8;&#x3002;&#x56E0;&#x6B64;&#xFF0C;PostgreSQL&#x8FD8;&#x51C6;&#x5907;&#x4E86;&#x4E00;&#x4E2A;&#x540D;&#x4E3A;<strong>skew</strong>&#x7684;&#x7279;&#x6B8A;batch&#xFF0C;&#x4EE5;&#x4FBF;&#x5728;&#x7B2C;&#x4E00;&#x8F6E;&#x4E2D;&#x66F4;&#x9AD8;&#x6548;&#x5730;&#x5904;&#x7406;&#x8BB8;&#x591A;&#x5143;&#x7EC4;&#x3002;</p>
<p>skew batch&#x5B58;&#x50A8;&#x5C06;&#x4E0E;&#x5916;&#x8868;&#x5143;&#x7EC4;&#x8FDE;&#x63A5;&#x7684;&#x5185;&#x8868;&#x5143;&#x7EC4;&#xFF0C;&#x8FD9;&#x4E9B;&#x5916;&#x8868;&#x5143;&#x7EC4;&#x53C2;&#x4E0E;&#x8FDE;&#x63A5;&#x6761;&#x4EF6;&#x7684;&#x5C5E;&#x6027;&#x7684;MCV&#x503C;&#x76F8;&#x5BF9;&#x8F83;&#x5927;&#x3002; &#x4F46;&#x662F;&#xFF0C;&#x56E0;&#x4E3A;&#x8FD9;&#x4E2A;&#x89E3;&#x91CA;&#x4E0D;&#x5BB9;&#x6613;&#x7406;&#x89E3;&#xFF0C;&#x6240;&#x4EE5;&#x4F1A;&#x7528;&#x4E00;&#x4E2A;&#x5177;&#x4F53;&#x7684;&#x4F8B;&#x5B50;&#x6765;&#x89E3;&#x91CA;&#x3002;</p>
<p>&#x5047;&#x8BBE;&#x6709;&#x4E24;&#x4E2A;&#x8868;&#xFF1A;customers&#x548C;purchase_history&#x3002; &#x987E;&#x5BA2;&#x8868;&#x7531;&#x4E24;&#x4E2A;&#x5C5E;&#x6027;&#x7EC4;&#x6210;&#xFF1A;name&#x548C;address; purchase_history&#x8868;&#x7531;&#x4E24;&#x4E2A;&#x5C5E;&#x6027;&#x7EC4;&#x6210;&#xFF1A;customer_name&#x548C;purchased_item&#x3002; &#x987E;&#x5BA2;&#x8868;&#x6709;10,000&#x884C;&#xFF0C;purchase_history&#x8868;&#x6709;1,000,000&#x884C;&#x3002; &#x524D;10&#xFF05;&#x7684;&#x987E;&#x5BA2;&#x8D2D;&#x4E70;&#x4E86;&#x6240;&#x6709;&#x7269;&#x54C1;&#x7684;70&#xFF05;&#x3002;</p>
<p>&#x5728;&#x8FD9;&#x4E9B;&#x5047;&#x8BBE;&#x4E0B;&#xFF0C;&#x6211;&#x4EEC;&#x8003;&#x8651;&#x6267;&#x884C;&#x4E0B;&#x9762;&#x7684;&#x67E5;&#x8BE2;&#x65F6;&#xFF0C;&#x7B2C;&#x4E00;&#x8F6E;&#x5982;&#x4F55;&#x6267;&#x884C;hybrid hash join with skew&#x3002;</p>
<pre><code class="lang-sql">testdb=# <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> customers <span class="hljs-keyword">AS</span> c, purchase_history <span class="hljs-keyword">AS</span> h <span class="hljs-keyword">WHERE</span> c.<span class="hljs-keyword">name</span> = h.customer_name;
</code></pre>
<p>&#x5982;&#x679C;&#x5BA2;&#x6237;&#x8868;&#x4E3A;&#x5185;&#x8868;&#xFF0C;&#x800C;purchase_history&#x4E3A;&#x5916;&#x8868;&#xFF0C;&#x5219;&#x524D;10&#xFF05;&#x7684;&#x5BA2;&#x6237;&#x5C06;&#x4F7F;&#x7528;purchase_history&#x8868;&#x7684;MCV&#x503C;&#x5B58;&#x50A8;&#x5728;skew batch&#x4E2D;&#x3002; &#x8BF7;&#x6CE8;&#x610F;&#xFF0C;&#x5F15;&#x7528;&#x4E86;&#x5916;&#x8868;&#x7684;MCV&#x503C;&#xFF0C;&#x4EE5;&#x5C06;&#x5185;&#x8868;&#x5143;&#x7EC4;&#x63D2;&#x5165;&#x5230;skew batch&#x4E2D;&#x3002; &#x5728;&#x7B2C;&#x4E00;&#x8F6E;&#x7684;probe&#x9636;&#x6BB5;&#xFF0C;&#x5916;&#x8868;(purchase_history)&#x7684;&#x5143;&#x7EC4;&#x4E2D;&#x7684;70&#xFF05;&#x5C06;&#x4E0E;&#x5B58;&#x50A8;&#x5728;skew batch&#x4E2D;&#x7684;&#x5143;&#x7EC4;&#x8FDE;&#x63A5;&#x3002; &#x8FD9;&#x6837;&#xFF0C;&#x5916;&#x8868;&#x5206;&#x5E03;&#x7684;&#x4E0D;&#x5747;&#x5300;&#x6027;&#x5C31;&#x8D8A;&#x5927;&#xFF0C;&#x5B83;&#x53EF;&#x4EE5;&#x5728;&#x7B2C;&#x4E00;&#x8F6E;&#x4E2D;&#x5904;&#x7406;&#x5916;&#x8868;&#x7684;&#x8BB8;&#x591A;&#x5143;&#x7EC4;&#x3002;</p>
<p>&#x5728;&#x4E0B;&#x6587;&#x4E2D;&#xFF0C;&#x5C55;&#x793A;hybrid hash join with skew&#x7684;&#x5DE5;&#x4F5C;&#x673A;&#x5236;&#x3002; &#x53C2;&#x8003;&#x56FE;3.26&#x81F3;3.29&#x3002;</p>
<p><strong>&#x56FE;. 3.26. hybrid hash join&#x7B2C;&#x4E00;&#x8F6E;build&#x9636;&#x6BB5;</strong></p>
<p><img src="https://github.com/yonj1e/The-Internals-of-PostgreSQL/blob/master/imgs/ch3/fig-3-26.png?raw=true" alt="Fig. 3.26. The build phase of the hybrid hash join in the first round."></p>
<p>(1) &#x5728;work_mem&#x4E0A;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;batch&#x548C;&#x4E00;&#x4E2A;skew batch&#x3002;</p>
<p>(2) &#x521B;&#x5EFA;&#x7528;&#x4E8E;&#x5B58;&#x50A8;&#x5185;&#x8868;&#x5143;&#x7EC4;&#x7684;&#x4E34;&#x65F6;batch&#x6587;&#x4EF6;&#x3002;</p>
<p>&#x200B;    &#x5728;&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x4E2D;&#xFF0C;&#x521B;&#x5EFA;&#x4E86;&#x4E09;&#x4E2A;batch&#x6587;&#x4EF6;&#xFF0C;&#x56E0;&#x4E3A;&#x5185;&#x8868;&#x5C06;&#x88AB;&#x56DB;&#x4E2A;batch&#x5206;&#x5F00;&#x3002;</p>
<p>(3) &#x6267;&#x884C;&#x5185;&#x8868;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7EC4;&#x7684;build&#x64CD;&#x4F5C;&#x3002;</p>
<p>   &#x8BE6;&#x60C5;&#x5982;&#x4E0B;&#xFF1A;</p>
<ol>
<li><p>&#x5982;&#x679C;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7EC4;&#x5E94;&#x8BE5;&#x63D2;&#x5165;&#x5230;skew batch&#x4E2D;&#xFF0C;&#x8BF7;&#x6267;&#x884C;&#x6B64;&#x64CD;&#x4F5C;; &#x5426;&#x5219;&#xFF0C;&#x8BF7;&#x7EE7;&#x7EED;&#x6267;&#x884C;2&#x3002;</p>
<p>&#x5728;&#x4E0A;&#x9762;&#x89E3;&#x91CA;&#x7684;&#x4F8B;&#x5B50;&#x4E2D;&#xFF0C;&#x5982;&#x679C;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7EC4;&#x662F;&#x524D;10&#xFF05;&#x7684;&#x5BA2;&#x6237;&#x4E4B;&#x4E00;&#xFF0C;&#x5219;&#x5C06;&#x5176;&#x63D2;&#x5165;&#x5230;skew batch&#x4E2D;&#x3002;</p>
</li>
<li><p>&#x8BA1;&#x7B97;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7EC4;&#x7684;hash-key&#xFF0C;&#x7136;&#x540E;&#x63D2;&#x5165;&#x76F8;&#x5E94;&#x7684;batch&#x3002;</p>
</li>
</ol>
<p>(4) &#x5BF9;&#x5185;&#x8868;&#x7684;&#x5176;&#x4F59;&#x5143;&#x7EC4;&#x6267;&#x884C;build&#x64CD;&#x4F5C;&#x3002;</p>
<p><strong>&#x56FE; 3.27. hybrid hash join&#x7B2C;&#x4E00;&#x8F6E;probe&#x9636;&#x6BB5;</strong></p>
<p><img src="https://github.com/yonj1e/The-Internals-of-PostgreSQL/blob/master/imgs/ch3/fig-3-27.png?raw=true" alt="Fig. 3.27. The probe phase of the hybrid hash join in the first round."></p>
<p>(5) &#x521B;&#x5EFA;&#x7528;&#x4E8E;&#x5B58;&#x50A8;&#x5916;&#x8868;&#x5143;&#x7EC4;&#x7684;&#x4E34;&#x65F6;batch&#x6587;&#x4EF6;&#x3002;</p>
<p>(6) &#x5982;&#x679C;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7EC4;&#x7684;MCV&#x503C;&#x8F83;&#x5927;&#xFF0C;&#x8BF7;&#x4F7F;&#x7528;skew batch&#x6267;&#x884C;probe&#x64CD;&#x4F5C;; &#x5426;&#x5219;&#xFF0C;&#x8DF3;&#x5230;(7)&#x3002;</p>
<p>&#x200B;    &#x5728;&#x4E0A;&#x9762;&#x89E3;&#x91CA;&#x7684;&#x4F8B;&#x5B50;&#x4E2D;&#xFF0C;&#x5982;&#x679C;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7EC4;&#x662F;&#x524D;10&#xFF05;&#x7684;&#x5BA2;&#x6237;&#x7684;&#x8D2D;&#x4E70;&#x6570;&#x636E;&#xFF0C;&#x5219;&#x5C06;&#x5176;&#x4E0E;skew batch&#x4E2D;&#x7684;&#x5143;&#x7EC4;&#x8FDB;&#x884C;&#x6BD4;&#x8F83;&#x3002;</p>
<p>(7) &#x6267;&#x884C;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7EC4;&#x7684;probe&#x64CD;&#x4F5C;&#x3002;</p>
<p>&#x200B;    &#x6839;&#x636E;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7EC4;&#x7684;hash-key&#x503C;&#xFF0C;&#x6267;&#x884C;&#x4EE5;&#x4E0B;&#x8FC7;&#x7A0B;&#xFF1A;</p>
<p>&#x200B;    &#x5982;&#x679C;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7EC4;&#x5C5E;&#x4E8E;Batch_0&#xFF0C;&#x5219;&#x6267;&#x884C;probe&#x64CD;&#x4F5C;&#x3002;</p>
<p>&#x200B;    &#x5426;&#x5219;&#xFF0C;&#x63D2;&#x5165;&#x5230;&#x76F8;&#x5E94;&#x7684;batch&#x4E2D;&#x3002;</p>
<p>(8) &#x4ECE;&#x5916;&#x8868;&#x7684;&#x5176;&#x4F59;&#x5143;&#x7EC4;&#x4E2D;&#x6267;&#x884C;probe&#x64CD;&#x4F5C;&#x3002; &#x8BF7;&#x6CE8;&#x610F;&#xFF0C;&#x5728;&#x8BE5;&#x793A;&#x4F8B;&#x4E2D;&#xFF0C;&#x5916;&#x8868;&#x7684;&#x5143;&#x7EC4;&#x4E2D;&#x7684;70&#xFF05;&#x5DF2;&#x5728;&#x7B2C;&#x4E00;&#x8F6E;&#x4E2D;&#x90FD;&#x7ECF;&#x8FC7;skew&#x5904;&#x7406;&#x3002;</p>
<p><strong>&#x56FE;. 3.28. &#x7B2C;&#x4E8C;&#x8F6E;build&#x548C;probe&#x9636;&#x6BB5;</strong></p>
<p><img src="https://github.com/yonj1e/The-Internals-of-PostgreSQL/blob/master/imgs/ch3/fig-3-28.png?raw=true" alt="Fig. 3.28. The build and probe phases in the second round."></p>
<p>(9) &#x5220;&#x9664;skew batch&#x5E76;&#x6E05;&#x9664;Batch_0&#x4EE5;&#x51C6;&#x5907;&#x7B2C;&#x4E8C;&#x8F6E;&#x3002;</p>
<p>(10) &#x4ECE;batch&#x6587;&#x4EF6;&apos;batch_1_in&apos;&#x6267;&#x884C;build&#x64CD;&#x4F5C;&#x3002;</p>
<p>(11) &#x5BF9;&#x5B58;&#x50A8;&#x5728;batch&#x6587;&#x4EF6;&apos;batch_1_out&apos;&#x4E2D;&#x7684;&#x5143;&#x7EC4;&#x6267;&#x884C;probe&#x64CD;&#x4F5C;&#x3002;</p>
<p><strong>&#x56FE;. 3.29. &#x7B2C;&#x4E09;&#x8F6E;&#x548C;&#x6700;&#x540E;&#x4E00;&#x8F6E;build&#x548C;probe&#x9636;&#x6BB5;</strong></p>
<p><img src="https://github.com/yonj1e/The-Internals-of-PostgreSQL/blob/master/imgs/ch3/fig-3-29.png?raw=true" alt="Fig. 3.29. The build and probe phases in the third and the last rounds."></p>
<p>(12) &#x4F7F;&#x7528;batch&#x6587;&#x4EF6;&apos;batch_2_in&apos;&#x548C;&apos;batch_2_out&apos;&#x6267;&#x884C;build&#x548C;probe&#x64CD;&#x4F5C;&#x3002;</p>
<p>(13) &#x4F7F;&#x7528;batch&#x6587;&#x4EF6;&apos;batch_3_in&apos;&#x548C;&apos;batch_3_out&apos;&#x6267;&#x884C;build&#x548C;probe&#x64CD;&#x4F5C;&#x3002;</p>
<h3 id="354-join-access-paths-and-join-nodes">3.5.4. Join Access Paths and Join Nodes</h3>
<h4 id="3541-join-access-paths">3.5.4.1. Join Access Paths</h4>
<p>nested loop join&#x7684;&#x8BBF;&#x95EE;&#x8DEF;&#x5F84;&#x662F; <a href="javascript:void(0" target="_blank">JoinPath</a>) &#x7ED3;&#x6784;&#xFF0C;&#x5176;&#x4ED6;&#x8FDE;&#x63A5;&#x8BBF;&#x95EE;&#x8DEF;&#x5F84; <a href="javascript:void(0" target="_blank">MergePath</a>) &#x548C; <a href="javascript:void(0" target="_blank">HashPath</a>) &#x90FD;&#x662F;&#x57FA;&#x4E8E;&#x8BE5;&#x7ED3;&#x6784;&#x7684;&#x3002;</p>
<p>&#x6240;&#x6709;&#x8FDE;&#x63A5;&#x8BBF;&#x95EE;&#x8DEF;&#x5F84;&#x90FD;&#x5C06;&#x5728;&#x4E0B;&#x9762;&#x8FDB;&#x884C;&#x8BF4;&#x660E;&#xFF0C;&#x65E0;&#x9700;&#x89E3;&#x91CA;&#x3002; </p>
<p><strong>&#x56FE;. 3.30. &#x8FDE;&#x63A5;&#x8BBF;&#x95EE;&#x8DEF;&#x5F84;</strong></p>
<p><img src="https://github.com/yonj1e/The-Internals-of-PostgreSQL/blob/master/imgs/ch3/fig-3-30.png?raw=true" alt="Fig. 3.30. Join access paths."></p>
<h4 id="3542-join-nodes">3.5.4.2. Join Nodes</h4>
<p>&#x672C;&#x5C0F;&#x8282;&#x663E;&#x793A;&#x4E09;&#x4E2A;&#x6CA1;&#x6709;&#x89E3;&#x91CA;&#x7684;&#x8FDE;&#x63A5;&#x8282;&#x70B9;&#xFF1A; <a href="javascript:void(0" target="_blank">NestedLoopNode</a>), <a href="javascript:void(0" target="_blank">MergeJoinNode</a>) &#x548C; <a href="javascript:void(0" target="_blank">HashJoinNode</a>) &#x3002; &#x5B83;&#x4EEC;&#x57FA;&#x4E8E; <a href="javascript:void(0" target="_blank">JoinNode</a>) &#x7ED3;&#x6784;&#x3002;</p>
<h2 id="36-&#x521B;&#x5EFA;&#x591A;&#x8868;&#x67E5;&#x8BE2;&#x7684;&#x8BA1;&#x5212;&#x6811;">3.6. &#x521B;&#x5EFA;&#x591A;&#x8868;&#x67E5;&#x8BE2;&#x7684;&#x8BA1;&#x5212;&#x6811;</h2>
<p>&#x5728;&#x672C;&#x8282;&#x4E2D;&#xFF0C;&#x5C06;&#x63CF;&#x8FF0;&#x521B;&#x5EFA;&#x591A;&#x8868;&#x67E5;&#x8BE2;&#x7684;&#x8BA1;&#x5212;&#x6811;&#x7684;&#x8FC7;&#x7A0B;&#x3002;</p>
<h3 id="361-&#x9884;&#x5904;&#x7406;">3.6.1. &#x9884;&#x5904;&#x7406;</h3>
<p>&#x8C03;&#x7528;<a href="https://github.com/postgres/postgres/blob/master/src/backend/optimizer/plan/planner.c" target="_blank">planner.c</a>&#x4E2D;&#x5B9A;&#x4E49;&#x7684;subquery_planner() &#x51FD;&#x6570;&#x8FDB;&#x884C;&#x9884;&#x5904;&#x7406;&#x3002; &#x5355;&#x8868;&#x67E5;&#x8BE2;&#x7684;&#x9884;&#x5904;&#x7406;&#x5DF2;&#x5728;&#x7B2C;3.3.1&#x8282;&#x4E2D;&#x63CF;&#x8FF0;&#x3002; &#x5728;&#x672C;&#x5C0F;&#x8282;&#x4E2D;&#xFF0C;&#x5C06;&#x63CF;&#x8FF0;&#x591A;&#x8868;&#x67E5;&#x8BE2;&#x7684;&#x9884;&#x5904;&#x7406;; &#x7136;&#x800C;&#xFF0C;&#x867D;&#x7136;&#x76F8;&#x5173;&#x5185;&#x5BB9;&#x5F88;&#x591A;&#xFF0C;&#x4F46;&#x53EA;&#x4ECB;&#x7ECD;&#x4E00;&#x90E8;&#x5206;&#x3002;</p>
<ol>
<li><p>&#x8BA1;&#x5212;&#x548C;&#x8F6C;&#x6362; CTE</p>
<p>&#x5982;&#x679C;&#x6709;WITH&#x5217;&#x8868;&#xFF0C;&#x5219;&#x4F18;&#x5316;&#x5668;&#x901A;&#x8FC7;SS_process_ctes() &#x51FD;&#x6570;&#x5904;&#x7406;&#x6BCF;&#x4E2A;WITH&#x67E5;&#x8BE2;&#x3002;</p>
</li>
<li><p>&#x62C9;&#x53D6;&#x5B50;&#x67E5;&#x8BE2;</p>
<p>&#x5982;&#x679C;FROM&#x5B50;&#x53E5;&#x5177;&#x6709;&#x5B50;&#x67E5;&#x8BE2;&#x5E76;&#x4E14;&#x5B83;&#x6CA1;&#x6709;GROUP BY&#xFF0C;HAVING&#xFF0C;ORDER BY&#xFF0C;LIMIT&#x548C;DISTINCT&#x5B50;&#x53E5;&#xFF0C;&#x5E76;&#x4E14;&#x5B83;&#x4E0D;&#x4F7F;&#x7528;INTERSECT&#x6216;EXCEPT&#xFF0C;&#x5219;&#x4F18;&#x5316;&#x5668;&#x5C06;&#x901A;&#x8FC7;pull_up_subqueries() &#x51FD;&#x6570;&#x8F6C;&#x6362;&#x4E3A;join&#x5F62;&#x5F0F;&#x3002; &#x4F8B;&#x5982;&#xFF0C;&#x4E0B;&#x9762;&#x663E;&#x793A;&#x7684;&#x5305;&#x542B;FROM&#x5B50;&#x53E5;&#x4E2D;&#x7684;&#x5B50;&#x67E5;&#x8BE2;&#x7684;&#x67E5;&#x8BE2;&#x53EF;&#x4EE5;&#x8F6C;&#x6362;&#x4E3A;natural join&#x67E5;&#x8BE2;&#x3002; &#x4E0D;&#x7528;&#x8BF4;&#xFF0C;&#x8FD9;&#x4E2A;&#x8F6C;&#x6362;&#x662F;&#x5728;&#x67E5;&#x8BE2;&#x6811;&#x4E2D;&#x5B8C;&#x6210;&#x7684;&#x3002;</p>
</li>
</ol>
<pre><code class="lang-sql">testdb=# <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> tbl_a <span class="hljs-keyword">AS</span> a, (<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> tbl_b) <span class="hljs-keyword">as</span> b <span class="hljs-keyword">WHERE</span> a.<span class="hljs-keyword">id</span> = b.<span class="hljs-keyword">id</span>;
                            &#x2193;
testdb=# <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> tbl_a <span class="hljs-keyword">AS</span> a, tbl_b <span class="hljs-keyword">as</span> b <span class="hljs-keyword">WHERE</span> a.<span class="hljs-keyword">id</span> = b.<span class="hljs-keyword">id</span>;
</code></pre>
<ol>
<li><p>&#x5C06;&#x5916;&#x8FDE;&#x63A5;&#x8F6C;&#x6362;&#x4E3A;&#x5185;&#x8FDE;&#x63A5;</p>
<p>&#x5982;&#x679C;&#x53EF;&#x80FD;&#xFF0C;&#x4F18;&#x5316;&#x5668;&#x5C06;&#x5916;&#x8FDE;&#x63A5;&#x67E5;&#x8BE2;&#x8F6C;&#x6362;&#x4E3A;&#x5185;&#x8FDE;&#x63A5;&#x67E5;&#x8BE2;&#x3002;</p>
</li>
</ol>
<h3 id="362-&#x83B7;&#x5F97;&#x6700;&#x4F18;&#x8DEF;&#x5F84;">3.6.2. &#x83B7;&#x5F97;&#x6700;&#x4F18;&#x8DEF;&#x5F84;</h3>
<p>&#x4E3A;&#x4E86;&#x5F97;&#x5230;&#x6700;&#x4F18;&#x7684;&#x8BA1;&#x5212;&#x6811;&#xFF0C;&#x4F18;&#x5316;&#x5668;&#x5FC5;&#x987B;&#x8003;&#x8651;&#x6240;&#x6709;&#x7D22;&#x5F15;&#x7684;&#x7EC4;&#x5408;&#x548C;&#x8FDE;&#x63A5;&#x65B9;&#x6CD5;&#x7684;&#x53EF;&#x80FD;&#x6027;&#x3002; &#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x975E;&#x5E38;&#x6602;&#x8D35;&#x7684;&#x8FC7;&#x7A0B;&#xFF0C;&#x5982;&#x679C;&#x7531;&#x4E8E;&#x7EC4;&#x5408;&#x7206;&#x70B8;&#x5BFC;&#x81F4;&#x8868;&#x7684;&#x6570;&#x91CF;&#x8D85;&#x8FC7;&#x67D0;&#x4E2A;&#x6C34;&#x5E73;&#xFF0C;&#x8FD9;&#x5C06;&#x662F;&#x4E0D;&#x53EF;&#x884C;&#x7684;&#x3002; &#x5E78;&#x8FD0;&#x7684;&#x662F;&#xFF0C;&#x5982;&#x679C;&#x8868;&#x7684;&#x6570;&#x91CF;&#x5C11;&#x4E8E;12&#x4E2A;&#x5DE6;&#x53F3;&#xFF0C;&#x4F18;&#x5316;&#x5668;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x52A8;&#x6001;&#x89C4;&#x5212;&#x6765;&#x83B7;&#x5F97;&#x6700;&#x4F18;&#x8BA1;&#x5212;&#x3002; &#x5426;&#x5219;&#xFF0C;&#x4F18;&#x5316;&#x5668;&#x4F7F;&#x7528;&#x9057;&#x4F20;&#x7B97;&#x6CD5;&#x3002; &#x8BF7;&#x53C2;&#x9605;&#x4E0B;&#x9762;&#x7684;&#x5185;&#x5BB9;&#x3002;</p>
<blockquote>
<p>:pushpin: <em>&#x9057;&#x4F20;&#x67E5;&#x8BE2;&#x4F18;&#x5316;&#x5668; Genetic Query Optimizer</em></p>
<p>&#x5F53;&#x6267;&#x884C;&#x8FDE;&#x63A5;&#x591A;&#x4E2A;&#x8868;&#x7684;&#x67E5;&#x8BE2;&#x65F6;&#xFF0C;&#x9700;&#x8981;&#x5927;&#x91CF;&#x7684;&#x65F6;&#x95F4;&#x6765;&#x4F18;&#x5316;&#x67E5;&#x8BE2;&#x8BA1;&#x5212;&#x3002; &#x4E3A;&#x4E86;&#x5904;&#x7406;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#xFF0C;PostgreSQL&#x5B9E;&#x73B0;&#x4E86;&#x4E00;&#x4E2A;&#x6709;&#x8DA3;&#x7684;&#x529F;&#x80FD;&#xFF1A;<a href="http://www.postgresql.org/docs/current/static/geqo.html" target="_blank">Genetic Query Optimizer</a>&#x3002; &#x8FD9;&#x662F;&#x4E00;&#x79CD;&#x5728;&#x5408;&#x7406;&#x65F6;&#x95F4;&#x5185;&#x786E;&#x5B9A;&#x5408;&#x7406;&#x8BA1;&#x5212;&#x7684;&#x8FD1;&#x4F3C;&#x7B97;&#x6CD5;&#x3002; &#x56E0;&#x6B64;&#xFF0C;&#x5728;&#x67E5;&#x8BE2;&#x4F18;&#x5316;&#x9636;&#x6BB5;&#xFF0C;&#x5982;&#x679C;&#x8FDE;&#x63A5;&#x8868;&#x7684;&#x6570;&#x91CF;&#x9AD8;&#x4E8E;&#x53C2;&#x6570;<a href="http://www.postgresql.org/docs/current/static/runtime-config-query.html#GUC-GEQO-THRESHOLD" target="_blank">geqo_threshold</a>&#x6307;&#x5B9A;&#x7684;&#x9608;&#x503C;(&#x7F3A;&#x7701;&#x503C;&#x4E3A;12)&#xFF0C;PostgreSQL&#x4F7F;&#x7528;&#x9057;&#x4F20;&#x7B97;&#x6CD5;&#x751F;&#x6210;&#x67E5;&#x8BE2;&#x8BA1;&#x5212;&#x3002; </p>
</blockquote>
<p>&#x4EE5;&#x4E0B;&#x6B65;&#x9AA4;&#x63CF;&#x8FF0;&#x901A;&#x8FC7;&#x52A8;&#x6001;&#x89C4;&#x5212;&#x786E;&#x5B9A;&#x6700;&#x4F18;&#x8BA1;&#x5212;&#x6811;&#xFF1A;</p>
<p><em>Level = 1</em></p>
<p>&#x200B;    &#x83B7;&#x53D6;&#x6BCF;&#x5F20;&#x8868;&#x7684;&#x6700;&#x4F18;&#x8DEF;&#x5F84;; &#x6700;&#x4F18;&#x8DEF;&#x5F84;&#x5B58;&#x50A8;&#x5728;&#x76F8;&#x5E94;&#x7684;RelOptInfo&#x4E2D;&#x3002;</p>
<p><em>Level = 2</em></p>
<p>&#x200B;    &#x4E3A;&#x6BCF;&#x4E2A;&#x7EC4;&#x5408;&#x9009;&#x62E9;&#x6700;&#x4F18;&#x8DEF;&#x5F84;&#xFF0C;&#x4ECE;&#x6240;&#x6709;&#x8868;&#x4E2D;&#x9009;&#x62E9;&#x4E24;&#x4E2A;&#x3002;</p>
<p>&#x200B;    &#x4F8B;&#x5982;&#xFF0C;&#x5982;&#x679C;&#x6709;&#x4E24;&#x4E2A;&#x8868;A&#x548C;B&#xFF0C;&#x5219;&#x83B7;&#x5F97;&#x8868;A&#x548C;B&#x7684;&#x6700;&#x4F18;&#x8FDE;&#x63A5;&#x8DEF;&#x5F84;&#xFF0C;&#x8FD9;&#x662F;&#x6700;&#x7EC8;&#x7B54;&#x6848;&#x3002;</p>
<p>&#x200B;    &#x4E0B;&#x9762;&#xFF0C;&#x4E24;&#x4E2A;&#x8868;&#x7684;RelOptInfo&#x7531;{A&#xFF0C;B}&#x8868;&#x793A;&#x3002;</p>
<p>&#x200B;    &#x5982;&#x679C;&#x6709;&#x4E09;&#x4E2A;&#x8868;&#xFF0C;&#x5219;&#x4E3A;{A&#xFF0C;B}&#xFF0C;{A&#xFF0C;C}&#x548C;{B&#xFF0C;C}&#x4E2D;&#x7684;&#x6BCF;&#x4E00;&#x4E2A;&#x627E;&#x5F97;&#x6700;&#x4F18;&#x8DEF;&#x5F84;&#x3002;</p>
<p><em>Level = 3 and higher</em></p>
<p>&#x200B;    &#x7EE7;&#x7EED;&#x76F8;&#x540C;&#x7684;&#x5904;&#x7406;&#xFF0C;&#x76F4;&#x5230;level&#x7B49;&#x4E8E;&#x8868;&#x7684;&#x6570;&#x91CF;&#x3002;</p>
<p>&#x8FD9;&#x6837;&#xFF0C;&#x90E8;&#x5206;&#x95EE;&#x9898;&#x7684;&#x6700;&#x4F18;&#x8DEF;&#x5F84;&#x5728;&#x6BCF;&#x4E2A;&#x7EA7;&#x522B;&#x83B7;&#x5F97;&#x5E76;&#x4E14;&#x88AB;&#x7528;&#x4E8E;&#x83B7;&#x5F97;&#x4E0A;&#x7EA7;&#x7684;&#x8BA1;&#x7B97;&#x3002;&#x8FD9;&#x4F7F;&#x5F97;&#x6709;&#x6548;&#x5730;&#x8BA1;&#x7B97;&#x6700;&#x4F18;&#x8BA1;&#x5212;&#x6811;&#x6210;&#x4E3A;&#x53EF;&#x80FD;&#x3002; </p>
<p><strong>&#x56FE;. 3.31. &#x4F7F;&#x7528;&#x52A8;&#x6001;&#x89C4;&#x5212;&#x83B7;&#x5F97;&#x6700;&#x4F18;&#x8BBF;&#x95EE;&#x8DEF;&#x5F84;</strong></p>
<p><img src="https://github.com/yonj1e/The-Internals-of-PostgreSQL/blob/master/imgs/ch3/fig-3-31.png?raw=true" alt="Fig. 3.31. How to get the cheapest access path using dynamic programming."></p>
<p>&#x5728;&#x4E0B;&#x6587;&#x4E2D;&#xFF0C;&#x63CF;&#x8FF0;&#x4F18;&#x5316;&#x5668;&#x83B7;&#x53D6;&#x4EE5;&#x4E0B;&#x67E5;&#x8BE2;&#x7684;&#x6700;&#x4F18;&#x8BA1;&#x5212;&#x7684;&#x8FC7;&#x7A0B;&#x3002;</p>
<pre><code class="lang-sql">testdb=# \d tbl_a
     Table &quot;public.tbl_a&quot;
 Column |  Type   | Modifiers 
<span class="hljs-comment">--------+---------+-----------</span>
 id     | integer | not null
 data   | integer | 
Indexes:
    &quot;tbl_a_pkey&quot; PRIMARY KEY, btree (id)

testdb=# \d tbl_b
     Table &quot;public.tbl_b&quot;
 Column |  Type   | Modifiers 
<span class="hljs-comment">--------+---------+-----------</span>
 id     | integer | 
 data   | integer | 

testdb=# <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> tbl_a <span class="hljs-keyword">AS</span> a, tbl_b <span class="hljs-keyword">AS</span> b <span class="hljs-keyword">WHERE</span> a.<span class="hljs-keyword">id</span> = b.<span class="hljs-keyword">id</span> <span class="hljs-keyword">AND</span> b.<span class="hljs-keyword">data</span> &lt; <span class="hljs-number">400</span>;
</code></pre>
<h4 id="3621-level-1-&#x9884;&#x5904;&#x7406;">3.6.2.1. Level 1 &#x9884;&#x5904;&#x7406;</h4>
<p>&#x5728;Level 1&#x4E2D;&#xFF0C;&#x4F18;&#x5316;&#x5668;&#x521B;&#x5EFA;RelOptInfo&#x7ED3;&#x6784;&#x5E76;&#x4F30;&#x8BA1;&#x67E5;&#x8BE2;&#x4E2D;&#x6BCF;&#x4E2A;&#x5173;&#x7CFB;&#x7684;&#x6700;&#x4F4E;&#x6210;&#x672C;&#x3002; &#x5728;&#x8FD9;&#xFF0C;RelOptInfo&#x7ED3;&#x6784;&#x88AB;&#x6DFB;&#x52A0;&#x5230;&#x8BE5;&#x67E5;&#x8BE2;&#x7684;PlannerInfo&#x7684;simple_rel_arrey&#x3002;</p>
<p><strong>&#x56FE;. 3.32. Level 1&#x9884;&#x5904;&#x7406;&#x540E;&#x7684;PlannerInfo &#x548C; RelOptInfo</strong></p>
<p><img src="https://github.com/yonj1e/The-Internals-of-PostgreSQL/blob/master/imgs/ch3/fig-3-32.png?raw=true" alt="Fig. 3.32. The PlannerInfo and RelOptInfo after processing in Level 1."></p>
<p>tbl_a&#x7684;RelOptInfo&#x6709;&#x4E09;&#x6761;&#x8BBF;&#x95EE;&#x8DEF;&#x5F84;&#xFF0C;&#x5B83;&#x4EEC;&#x88AB;&#x6DFB;&#x52A0;&#x5230;RelOptInfo&#x7684;pathlist&#x4E2D;&#xFF0C;&#x5E76;&#x4E14;&#x94FE;&#x63A5;&#x5230;&#x4E09;&#x4E2A;&#x6700;&#x4F4E;&#x6210;&#x672C;&#x8DEF;&#x5F84;&#xFF0C;&#x5373;<em>cheapest start-up (cost) path</em>&#xFF0C;<em>cheapest total (cost) path</em>&#x548C;<em>cheapest parameterized (cost) path</em>&#x3002; &#x7531;&#x4E8E;&#x6700;&#x4F18;&#x542F;&#x52A8;&#x548C;&#x603B;&#x6210;&#x672C;&#x8DEF;&#x5F84;&#x662F;&#x663E;&#x800C;&#x6613;&#x89C1;&#x7684;&#xFF0C;&#x56E0;&#x6B64;&#x5C06;&#x63CF;&#x8FF0;cheapest parameterized index scan path&#x7684;&#x6210;&#x672C;&#x3002;</p>
<p>&#x5982;&#x7B2C;3.5.1.3&#x8282;&#x6240;&#x8FF0;&#xFF0C;&#x4F18;&#x5316;&#x5668;&#x8003;&#x8651;&#x4F7F;&#x7528;indexed nested loop join&#x7684;parameterized path(&#x5E76;&#x4E14;&#x5F88;&#x5C11;&#x5C06;indexed merge join&#x4E0E;outer index scan&#x4E00;&#x8D77;&#x4F7F;&#x7528;)&#x3002; cheapest parameterized cost&#x662F;&#x4F30;&#x8BA1;parameterized path&#x7684;&#x6700;&#x4F4E;&#x6210;&#x672C;&#x3002;</p>
<p>tbl_b&#x7684;RelOptInfo&#x53EA;&#x5177;&#x6709;&#x987A;&#x5E8F;&#x626B;&#x63CF;&#x8BBF;&#x95EE;&#x8DEF;&#x5F84;&#xFF0C;&#x56E0;&#x4E3A;tbl_b&#x6CA1;&#x6709;&#x76F8;&#x5173;&#x7684;&#x7D22;&#x5F15;&#x3002;</p>
<h4 id="3622-level-2-&#x9884;&#x5904;&#x7406;">3.6.2.2. Level 2 &#x9884;&#x5904;&#x7406;</h4>
<p>&#x5728;Level 2&#x4E2D;&#xFF0C;&#x521B;&#x5EFA;RelOptInfo&#x7ED3;&#x6784;&#x5E76;&#x5C06;&#x5176;&#x6DFB;&#x52A0;&#x5230;PlannerInfo&#x7684;join_rel_list&#x4E2D;&#x3002; &#x7136;&#x540E;&#xFF0C;&#x4F30;&#x8BA1;&#x6240;&#x6709;&#x53EF;&#x80FD;&#x7684;join&#x8DEF;&#x5F84;&#x7684;&#x6210;&#x672C;&#xFF0C;&#x5E76;&#x9009;&#x62E9;&#x603B;&#x6210;&#x672C;&#x6700;&#x4F4E;&#x7684;&#x6700;&#x4F18;&#x8BBF;&#x95EE;&#x8DEF;&#x5F84;&#x3002;RelOptInfo&#x5C06;&#x6700;&#x4F18;&#x8BBF;&#x95EE;&#x8DEF;&#x5F84;&#x5B58;&#x50A8;&#x4E3A;&#x6700;&#x4F18;&#x603B;&#x6210;&#x672C;&#x8DEF;&#x5F84;&#x3002; &#x53C2;&#x8003;&#x56FE;3.33&#x3002;</p>
<p><strong>&#x56FE;. 3.33. Level 2&#x9884;&#x5904;&#x7406;&#x540E;&#x7684;PlannerInfo &#x548C; RelOptInfo</strong></p>
<p><img src="https://github.com/yonj1e/The-Internals-of-PostgreSQL/blob/master/imgs/ch3/fig-3-33.png?raw=true" alt="Fig. 3.33. The PlannerInfo and RelOptInfo after processing in Level 2."></p>
<p>&#x8868;3.1&#x5C55;&#x793A;&#x8FD9;&#x4E2A;&#x793A;&#x4F8B;&#x4E2D;&#x6240;&#x6709;&#x8FDE;&#x63A5;&#x8BBF;&#x95EE;&#x8DEF;&#x5F84;&#x7684;&#x7EC4;&#x5408;&#x3002;&#x793A;&#x4F8B;&#x7684;&#x67E5;&#x8BE2;&#x662F;&#x4E00;&#x4E2A;equi-join&#x7C7B;&#x578B;; &#x56E0;&#x6B64;&#xFF0C;&#x4F30;&#x8BA1;&#x6240;&#x6709;&#x4E09;&#x79CD;&#x8FDE;&#x63A5;&#x65B9;&#x6CD5;&#x3002; &#x4E3A;&#x4E86;&#x65B9;&#x4FBF;&#x8D77;&#x89C1;&#xFF0C;&#x5F15;&#x5165;&#x4E86;&#x4E00;&#x4E9B;&#x8BBF;&#x95EE;&#x8DEF;&#x5F84;&#x7684;&#x540D;&#x8BCD;&#xFF1A;</p>
<ul>
<li><em>SeqScanPath(table)</em> &#x8868;&#x793A;&#x8868;&#x7684;&#x987A;&#x5E8F;&#x626B;&#x63CF;&#x8DEF;&#x5F84;&#x3002;</li>
<li><em>Materialized-&gt;SeqScanPath(table)</em> &#x8868;&#x793A;&#x8868;&#x7684;&#x7269;&#x5316;&#x987A;&#x5E8F;&#x626B;&#x63CF;&#x8DEF;&#x5F84;&#x3002;</li>
<li><em>IndexScanPath(table, attribute)</em> &#x8868;&#x793A;&#x7531;&#x8868;&#x7684;&#x5C5E;&#x6027;&#x6307;&#x5B9A;&#x7684;&#x7D22;&#x5F15;&#x626B;&#x63CF;&#x8DEF;&#x5F84;&#x3002;</li>
<li><em>ParameterizedIndexScanPath(table, attribute1, attribute2)</em> &#x7531;&#x8868;&#x7684;&#x5C5E;&#x6027;1&#x6307;&#x5B9A;&#x7684;&#x53C2;&#x6570;&#x5316;&#x7D22;&#x5F15;&#x8DEF;&#x5F84;&#xFF0C;&#x5E76;&#x4E14;&#x7531;&#x5916;&#x8868;&#x7684;&#x5C5E;&#x6027;2&#x8FDB;&#x884C;&#x53C2;&#x6570;&#x5316;&#x3002;</li>
</ul>
<p><strong>&#x8868; 3.1: &#x672C;&#x4F8B;&#x4E2D;&#x6240;&#x6709;&#x7EC4;&#x5408;&#x7684;&#x8BBF;&#x95EE;&#x8DEF;&#x5F84;</strong> </p>
<table>
<thead>
<tr>
<th></th>
<th>Outer Path</th>
<th>Inner Path</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Nested Loop Join</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>1</td>
<td>SeqScanPath(tbl_a)</td>
<td>SeqScanPath(tbl_b)</td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>SeqScanPath(tbl_a)</td>
<td>Materialized-&gt;SeqScanPath(tbl_b)</td>
<td>Materialized nested loop join</td>
</tr>
<tr>
<td>3</td>
<td>IndexScanPath(tbl_a,id)</td>
<td>SeqScanPath(tbl_b)</td>
<td>Nested loop join with outer index scan</td>
</tr>
<tr>
<td>4</td>
<td>IndexScanPath(tbl_a,id)</td>
<td>Materialized-&gt;SeqScanPath(tbl_b)</td>
<td>Materialized nested loop join with outer index scan</td>
</tr>
<tr>
<td>5</td>
<td>SeqScanPath(tbl_b)</td>
<td>SeqScanPath(tbl_a)</td>
<td></td>
</tr>
<tr>
<td>6</td>
<td>SeqScanPath(tbl_b)</td>
<td>Materialized-&gt;SeqScanPath(tbl_a)</td>
<td>Materialized nested loop join</td>
</tr>
<tr>
<td>7</td>
<td>SeqScanPath(tbl_b)</td>
<td>ParametalizedIndexScanPath(tbl_a, id, tbl_b.id)</td>
<td>Indexed nested loop join</td>
</tr>
<tr>
<td>Merge Join</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>1</td>
<td>SeqScanPath(tbl_a)</td>
<td>SeqScanPath(tbl_b)</td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>IndexScanPath(tbl_a,id)</td>
<td>SeqScanPath(tbl_b)</td>
<td>Merge join with outer index scan</td>
</tr>
<tr>
<td>3</td>
<td>SeqScanPath(tbl_b)</td>
<td>SeqScanPath(tbl_a)</td>
<td></td>
</tr>
<tr>
<td>Hash Join</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>1</td>
<td>SeqScanPath(tbl_a)</td>
<td>SeqScanPath(tbl_b)</td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>SeqScanPath(tbl_b)</td>
<td>SeqScanPath(tbl_a)</td>
</tr>
</tbody>
</table>
<p>&#x4F8B;&#x5982;&#xFF0C;&#x5728;nested loop join&#x4E2D;&#xFF0C;&#x4F30;&#x8BA1;&#x4E03;&#x6761;&#x8FDE;&#x63A5;&#x8DEF;&#x5F84;&#x3002; &#x7B2C;&#x4E00;&#x4E2A;&#x8868;&#x793A;&#x5916;&#x8DEF;&#x5F84;&#x548C;&#x5185;&#x8DEF;&#x5F84;&#x5206;&#x522B;&#x662F;tbl_a&#x548C;tbl_b&#x7684;&#x987A;&#x5E8F;&#x626B;&#x63CF;&#x8DEF;&#x5F84;; &#x7B2C;&#x4E8C;&#x4E2A;&#x8868;&#x793A;&#x5916;&#x8DEF;&#x5F84;&#x662F;tbl_a&#x7684;&#x987A;&#x5E8F;&#x626B;&#x63CF;&#x8DEF;&#x5F84;&#xFF0C;&#x800C;&#x5185;&#x8DEF;&#x5F84;&#x662F;tbl_b&#x7684;&#x7269;&#x5316;&#x987A;&#x5E8F;&#x626B;&#x63CF;&#x8DEF;&#x5F84;; &#x7B49;&#x7B49;&#x3002;</p>
<p>&#x4F18;&#x5316;&#x5668;&#x6700;&#x7EC8;&#x4ECE;&#x4F30;&#x8BA1;&#x7684;&#x8FDE;&#x63A5;&#x8DEF;&#x5F84;&#x4E2D;&#x9009;&#x62E9;&#x6700;&#x4F18;&#x8BBF;&#x95EE;&#x8DEF;&#x5F84;&#xFF0C;&#x5E76;&#x5C06;&#x6700;&#x4F18;&#x8DEF;&#x5F84;&#x6DFB;&#x52A0;&#x5230;RelOptInfo {tbl_a&#xFF0C;tbl_b}&#x7684;pathlist&#x4E2D;&#x3002; &#x53C2;&#x8003;&#x56FE;3.33&#x3002;</p>
<p>&#x5728;&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x4E2D;&#xFF0C;&#x5982;&#x4E0B;&#x9762;EXPLAIN&#x7684;&#x7ED3;&#x679C;&#x6240;&#x793A;&#xFF0C;&#x4F18;&#x5316;&#x5668;&#x9009;&#x62E9;&#x5185;&#x8868;&#x548C;&#x5916;&#x8868;&#x4E3A;tbl_b&#x548C;tbl_c&#x7684;hash join&#x3002;</p>
<pre><code class="lang-sql">testdb=# EXPLAIN  SELECT * FROM tbl_b AS b, tbl_c AS c WHERE c.id = b.id AND b.data &lt; 400;
                        QUERY PLAN                              
---------------------------------------------------------------------- 
Hash Join  (cost=90.50..277.00 rows=400 width=16)   
    Hash Cond: (c.id = b.id)   
    -&gt;  Seq Scan on tbl_c c  (cost=0.00..145.00 rows=10000 width=8)   
    -&gt;  Hash  (cost=85.50..85.50 rows=400 width=8)         
        -&gt;  Seq Scan on tbl_b b  (cost=0.00..85.50 rows=400 width=8)               
            Filter: (data &lt; 400)
(6 rows)
</code></pre>
<h3 id="363-&#x83B7;&#x53D6;&#x4E09;&#x8868;&#x67E5;&#x8BE2;&#x7684;&#x6700;&#x4F18;&#x8DEF;&#x5F84;">3.6.3. &#x83B7;&#x53D6;&#x4E09;&#x8868;&#x67E5;&#x8BE2;&#x7684;&#x6700;&#x4F18;&#x8DEF;&#x5F84;</h3>
<p>&#x83B7;&#x53D6;&#x6D89;&#x53CA;&#x4E09;&#x4E2A;&#x8868;&#x7684;&#x67E5;&#x8BE2;&#x7684;&#x6700;&#x4F18;&#x8DEF;&#x5F84;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code class="lang-sql">testdb=# \d tbl_a
     Table &quot;public.tbl_a&quot;
 Column |  Type   | Modifiers 
<span class="hljs-comment">--------+---------+-----------</span>
 id     | integer | 
 data   | integer | 

testdb=# \d tbl_b
     Table &quot;public.tbl_b&quot;
 Column |  Type   | Modifiers 
<span class="hljs-comment">--------+---------+-----------</span>
 id     | integer | 
 data   | integer | 

testdb=# \d tbl_c
     Table &quot;public.tbl_c&quot;
 Column |  Type   | Modifiers 
<span class="hljs-comment">--------+---------+-----------</span>
 id     | integer | not null
 data   | integer | 
Indexes:
    &quot;tbl_c_pkey&quot; PRIMARY KEY, btree (id)

testdb=# <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> tbl_a <span class="hljs-keyword">AS</span> a, tbl_b <span class="hljs-keyword">AS</span> b, tbl_c <span class="hljs-keyword">AS</span> c 
testdb-#                <span class="hljs-keyword">WHERE</span> a.<span class="hljs-keyword">id</span> = b.<span class="hljs-keyword">id</span> <span class="hljs-keyword">AND</span> b.<span class="hljs-keyword">id</span> = c.<span class="hljs-keyword">id</span> <span class="hljs-keyword">AND</span> a.<span class="hljs-keyword">data</span> &lt; <span class="hljs-number">40</span>;
</code></pre>
<p> <strong>Level 1:</strong></p>
<p>&#x4F18;&#x5316;&#x5668;&#x4F30;&#x8BA1;&#x6240;&#x6709;&#x8868;&#x7684;&#x6700;&#x4F18;&#x8DEF;&#x5F84;&#xFF0C;&#x5E76;&#x5C06;&#x8FD9;&#x4E9B;&#x4FE1;&#x606F;&#x5B58;&#x50A8;&#x5728;&#x76F8;&#x5E94;&#x7684;RelOptInfos&#xFF1A;{tbl_a}&#xFF0C;{tbl_b}&#x548C;{tbl_c}&#x4E2D;&#x3002;</p>
<p><strong>Level 2:</strong></p>
<p>&#x4F18;&#x5316;&#x5668;&#x9009;&#x53D6;&#x4E09;&#x5F20;&#x8868;&#x4E2D;&#x7684;&#x6240;&#x6709;&#x7EC4;&#x5408;&#xFF0C;&#x5E76;&#x4F30;&#x8BA1;&#x6BCF;&#x4E2A;&#x7EC4;&#x5408;&#x7684;&#x6700;&#x4F18;&#x8DEF;&#x5F84;; &#x4F18;&#x5316;&#x5668;&#x7136;&#x540E;&#x5C06;&#x4FE1;&#x606F;&#x5B58;&#x50A8;&#x5728;&#x76F8;&#x5E94;&#x7684;RelOptInfos&#xFF1A;{tbl_a&#xFF0C;tbl_b}&#xFF0C;{tbl_b&#xFF0C;tbl_c}&#x548C;{tbl_a&#xFF0C;tbl_c}&#x4E2D;&#x3002;</p>
<p><strong>Level 3:</strong></p>
<p>&#x4F18;&#x5316;&#x5668;&#x6700;&#x7EC8;&#x4F7F;&#x7528;&#x5DF2;&#x83B7;&#x5F97;&#x7684;RelOptInfos&#x83B7;&#x5F97;&#x6700;&#x4F18;&#x8DEF;&#x5F84;&#x3002; &#x66F4;&#x51C6;&#x786E;&#x5730;&#x8BF4;&#xFF0C; &#x89C4;&#x5212;&#x5668;&#x8003;&#x8651;&#x4E86;RelOptInfos&#x7684;&#x4E09;&#x4E2A;&#x7EC4;&#x5408;&#xFF1A;{tbl_a&#xFF0C;{tbl_b&#xFF0C;tbl_c}&#xFF0C;{tbl_b&#xFF0C;{tbl_a&#xFF0C;tbl_c}&#x548C;{tbl_c&#xFF0C;{tbl_a&#xFF0C;tbl_b}&#xFF0C;&#x56E0;&#x4E3A;{tbl_a&#xFF0C;tbl_b&#xFF0C;tbl_c}&#x662F;&#x7531;&#x5B83;&#x4EEC;&#x7EC4;&#x6210;&#x7684;&#x3002; </p>
<p>&#x200B;    {tbl_a,tbl_b,tbl_c} = {tbl_a,{tbl_b,tbl_c}} + {tbl_b,{tbl_a,tbl_c}} + {tbl_c,{tbl_a,tbl_b}}.</p>
<p>&#x7136;&#x540E;&#xFF0C;&#x4F18;&#x5316;&#x5668;&#x4F1A;&#x4F30;&#x8BA1;&#x5176;&#x4E2D;&#x6240;&#x6709;&#x53EF;&#x80FD;&#x7684;&#x8FDE;&#x63A5;&#x8DEF;&#x5F84;&#x7684;&#x6210;&#x672C;&#x3002;</p>
<p>&#x5728;RelOptInfo {tbl_c&#xFF0C;{tbl_a&#xFF0C;tbl_b}}&#x4E2D;&#xFF0C;&#x4F18;&#x5316;&#x5668;&#x4F30;&#x8BA1;tbl_c&#x548C;{tbl_a&#xFF0C;tbl_b}&#x7684;&#x6700;&#x4F18;&#x8DEF;&#x5F84;&#x7684;&#x6240;&#x6709;&#x7EC4;&#x5408;&#xFF0C;tbl_a&#xFF0C;tbl_b&#x662F;&#x5176;&#x5185;&#x8868;&#x548C;&#x5916;&#x8868;&#x5206;&#x522B;&#x4E3A;tbl_a&#x548C;tbl_b&#x7684;hash join&#xFF0C; &#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x3002; &#x4F30;&#x8BA1;&#x7684;&#x8FDE;&#x63A5;&#x8DEF;&#x5F84;&#x5C06;&#x5305;&#x542B;&#x4E09;&#x79CD;&#x8FDE;&#x63A5;&#x8DEF;&#x5F84;&#x53CA;&#x5176;&#x53D8;&#x4F53;&#xFF0C;&#x5982;&#x524D;&#x4E00;&#x5C0F;&#x8282;&#x6240;&#x793A;&#xFF0C;&#x5373;nested loop join&#x53CA;&#x5176;&#x53D8;&#x4F53;&#xFF0C;merge join&#x53CA;&#x5176;&#x53D8;&#x4F53;&#x4EE5;&#x53CA;hash join&#x3002;</p>
<p>&#x4F18;&#x5316;&#x5668;&#x4EE5;&#x76F8;&#x540C;&#x7684;&#x65B9;&#x5F0F;&#x5904;&#x7406;RelOptInfos {tbl_a&#xFF0C;{tbl_b&#xFF0C;tbl_c}}&#x548C;{tbl_b&#xFF0C;{tbl_a&#xFF0C;tbl_c}}&#xFF0C;&#x6700;&#x540E;&#x4ECE;&#x6240;&#x6709;&#x4F30;&#x8BA1;&#x7684;&#x8DEF;&#x5F84;&#x4E2D;&#x9009;&#x62E9;&#x6700;&#x4F18;&#x8BBF;&#x95EE;&#x8DEF;&#x5F84;&#x3002;</p>
<p>&#x4E0B;&#x9762;&#x663E;&#x793A;&#x4E86;&#x8BE5;&#x67E5;&#x8BE2;&#x7684;EXPLAIN&#x547D;&#x4EE4;&#x7684;&#x7ED3;&#x679C;&#xFF1A;</p>
<p><img src="https://github.com/yonj1e/The-Internals-of-PostgreSQL/blob/master/imgs/ch3/fig-3-34.png?raw=true" alt="img"></p>
<p>&#x6700;&#x5916;&#x5C42;&#x7684;&#x8FDE;&#x63A5;&#x662F;indexed nested loop join(&#x7B2C;5&#x884C;)&#xFF1B;inner parameterized index scan&#x663E;&#x793A;&#x5728;&#x7B2C;13&#x884C;&#x4E2D;&#xFF0C;&#x7B2C;7-12&#x884C;&#x662F;hash join&#x7684;&#x7ED3;&#x679C;&#xFF0C;&#x5176;&#x5185;&#x8868;&#x548C;&#x5916;&#x8868;&#x5206;&#x522B;&#x662F;tbl_b&#x548C;tbl_a&#x3002;&#x56E0;&#x6B64;&#xFF0C;&#x6267;&#x884C;&#x5668;&#x9996;&#x5148;&#x6267;&#x884C;tbl_a&#x548C;tbl_b&#x7684;hash join&#xFF0C;&#x7136;&#x540E;&#x6267;&#x884C;indexed nested loop join&#x3002; </p>
<h2 id="&#x53C2;&#x8003;">&#x53C2;&#x8003;</h2>
<ul>
<li>[1] Abraham Silberschatz, Henry F. Korth, and S. Sudarshan, &quot;<a href="https://www.amazon.com/dp/0073523321" target="_blank">Database System Concepts</a>&quot;, McGraw-Hill Education, ISBN-13: 978-0073523323</li>
<li>[2] Thomas M. Connolly, and Carolyn E. Begg, &quot;<a href="https://www.amazon.com/dp/0321523067" target="_blank">Database Systems</a>&quot;, Pearson, ISBN-13: 978-0321523068</li>
</ul>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="ch2.html" class="navigation navigation-prev " aria-label="Previous page: 第二章. 进程和内存结构">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="ch4.html" class="navigation navigation-next " aria-label="Next page: 第四章. 外部表(FDW)和并行查询">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"第三章. 查询处理","level":"1.5","depth":1,"next":{"title":"第四章. 外部表(FDW)和并行查询","level":"1.6","depth":1,"path":"ch4.md","ref":"ch4.md","articles":[]},"previous":{"title":"第二章. 进程和内存结构","level":"1.4","depth":1,"path":"ch2.md","ref":"ch2.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["livereload"],"pluginsConfig":{"livereload":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"ch3.md","mtime":"2018-06-20T04:18:23.384Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2018-06-25T07:08:45.205Z"},"basePath":".","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    
        
        <script src="gitbook/gitbook-plugin-livereload/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

